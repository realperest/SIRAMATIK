<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title id="page-title">Ä°rmet Hospital - SÄ±ra Takip</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ä°rmet SÄ±ra">
    <meta name="screen-orientation" content="portrait">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" id="favicon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ«</text></svg>">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10px 20px;
            overscroll-behavior-y: contain;
            /* Pull-to-refresh engelleme */
        }

        .ticket {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .ticket::before,
        .ticket::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            background: #f0f2f5;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }

        .ticket::before {
            left: -20px;
        }

        .ticket::after {
            right: -20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            text-align: center;
        }

        .content {
            padding: 24px 24px;
            text-align: center;
            border-top: 2px dashed #eee;
        }

        .number {
            font-size: 84px;
            font-weight: 900;
            color: #764ba2;
            margin: 12px 0;
            letter-spacing: -2px;
        }

        .label {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .footer {
            background: #f8f9fa;
            padding: 14px 20px;
            text-align: center;
            font-size: 14px;
            color: #95a5a6;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.5s ease;
        }

        .calling-active-body {
            animation: party-alert 0.8s infinite;
        }

        @keyframes party-alert {
            0% {
                background-color: #ff0000;
            }

            /* KÄ±rmÄ±zÄ± */
            25% {
                background-color: #ffeb3b;
            }

            /* SarÄ± */
            50% {
                background-color: #2196f3;
            }

            /* Mavi */
            75% {
                background-color: #4caf50;
            }

            /* YeÅŸil */
            100% {
                background-color: #ff0000;
            }
        }

        /* Ã‡arpÄ±cÄ± etki iÃ§in bilet kartÄ±na gÃ¶lge ekle */
        .calling-active-body .ticket {
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.6);
            border: 4px solid white;
        }

        .calling-status {
            background: #22c55e !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        /* Aktivasyon Overlay */
        #activation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .activation-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            cursor: pointer;
            margin-top: 20px;
        }

        /* BaÄŸlantÄ± durumu: sol Ã¼st, iki kÃ¼Ã§Ã¼k balon W / P */
        .connection-badges {
            position: fixed;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 6px;
            z-index: 1000;
        }
        .connection-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            transition: background 0.3s, opacity 0.3s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .connection-badge.active {
            background: #22c55e;
            opacity: 1;
        }
        .connection-badge.inactive {
            background: #94a3b8;
            opacity: 0.5;
        }
        .connection-badge.connecting {
            background: #f59e0b;
            opacity: 0.8;
        }

        /* SayÄ± Azalma Animasyonu */
        @keyframes number-decrease {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
                color: #22c55e;
            }
        }

        .number.animate-decrease {
            animation: number-decrease 0.6s ease;
        }

        /* DeÄŸer balonu (Ã¶nÃ¼nÃ¼zdeki kiÅŸi / tahmini dakika) - sadece sayÄ± */
        .value-bubble {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(118, 75, 162, 0.15);
            color: #764ba2;
            border-radius: 12px;
            font-size: inherit;
            font-weight: 700;
        }
        .value-bubble-old {
            position: relative;
            opacity: 0.95;
            background: rgba(59, 130, 246, 0.25);
        }
        /* Eski deÄŸerin Ã¼zerinde X (Ã§arpÄ±) iÅŸareti - kÄ±rmÄ±zÄ± */
        .value-bubble-old::before,
        .value-bubble-old::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 120%;
            height: 2px;
            background: #dc2626;
            transform-origin: center;
        }
        .value-bubble-old::before {
            transform: translate(-50%, -50%) rotate(-45deg);
        }
        .value-bubble-old::after {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .value-bubble-new {
            margin-left: 6px;
        }
        /* Tahmini Bekleme SÃ¼resi */
        .estimated-time {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(118, 75, 162, 0.1);
            color: #764ba2;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 15px;
        }
        .estimated-time .value-bubble {
            font-size: 13px;
        }

        /* Gizli element (HTML tekrarÄ± dÃ¼zeltmesi iÃ§in) */
        .hidden {
            display: none;
        }

        /* Erteleme alanÄ± - iPhone tarzÄ± Ã§ark */
        .erteleme-wrap {
            background: rgba(118, 75, 162, 0.06);
        }
        .erteleme-inner {
            padding: 12px 20px 14px;
            border-top: 2px dashed #eee;
            text-align: center;
        }
        .erteleme-wheel-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 12px 0;
        }
        .erteleme-wheel-mask {
            height: 120px;
            overflow: hidden;
            position: relative;
            border-radius: 12px;
            background: linear-gradient(to bottom,
                rgba(255,255,255,0) 0%,
                rgba(248,249,250,0.95) 15%,
                rgba(248,249,250,1) 35%,
                rgba(248,249,250,1) 65%,
                rgba(248,249,250,0.95) 85%,
                rgba(255,255,255,0) 100%);
            box-shadow: inset 0 0 20px rgba(118, 75, 162, 0.08);
        }
        .erteleme-wheel-mask::before,
        .erteleme-wheel-mask::after {
            content: '';
            position: absolute;
            left: 0; right: 0;
            height: 40px;
            pointer-events: none;
            z-index: 1;
        }
        .erteleme-wheel-mask::before {
            top: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.98), transparent);
        }
        .erteleme-wheel-mask::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.98), transparent);
        }
        .erteleme-wheel {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            padding: 40px 24px;
        }
        .erteleme-wheel-spacer {
            height: 40px;
            scroll-snap-align: center;
            flex-shrink: 0;
        }
        .erteleme-wheel-item {
            height: 40px;
            line-height: 40px;
            scroll-snap-align: center;
            scroll-snap-stop: always;
            font-size: 22px;
            font-weight: 700;
            color: #764ba2;
            flex-shrink: 0;
        }
        .erteleme-wheel-unit {
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            align-self: center;
        }
        .erteleme-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .erteleme-btn:active {
            transform: scale(0.98);
        }
        .erteleme-btn:disabled {
            opacity: 0.6;
        }
        /* Erteleme overlay - saÄŸ Ã¼st katman */
        .erteleme-overlay {
            position: fixed;
            inset: 0;
            z-index: 9998;
            display: flex;
            justify-content: flex-end;
            align-items: stretch;
            pointer-events: none;
        }
        .erteleme-overlay[data-open="true"] {
            pointer-events: auto;
        }
        .erteleme-overlay-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.35);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .erteleme-overlay[data-open="true"] .erteleme-overlay-backdrop {
            opacity: 1;
        }
        .erteleme-overlay-panel {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: min(420px, 96vw);
            min-height: 100vh;
            background: linear-gradient(180deg, #f8f7fc 0%, #f0eeff 35%, #fff 100%);
            box-shadow: -4px 0 28px rgba(102, 126, 234, 0.12);
            padding: 24px 56px 28px 24px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.25s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        @media (max-width: 500px) {
            .erteleme-overlay-panel { max-width: 100%; padding: 22px 52px 26px 22px; }
        }
        @media (min-width: 480px) {
            .erteleme-overlay-panel { padding: 28px 60px 32px 28px; }
        }
        .erteleme-overlay[data-open="true"] .erteleme-overlay-panel {
            transform: translateX(0);
        }
        .erteleme-overlay-panel .erteleme-overlay-header {
            width: 100%;
            margin-bottom: 8px;
        }
        .erteleme-overlay-title {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            color: #5b4a7a;
            letter-spacing: 0.3px;
        }
        .erteleme-overlay-hint {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .erteleme-estimate-above {
            font-size: 17px;
            font-weight: 600;
            color: #475569;
            margin: 14px 0 16px 0;
            padding: 12px 18px;
            background: rgba(118, 75, 162, 0.08);
            border-radius: 14px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        .erteleme-estimate-above strong {
            color: #764ba2;
            font-size: 19px;
        }
        .erteleme-overlay-wheel-wrap {
            width: 100%;
            justify-content: center;
            margin: 8px 0 20px 0;
            padding: 16px 0;
            background: rgba(255,255,255,0.6);
            border-radius: 16px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .erteleme-overlay-wheel-mask {
            height: 168px;
        }
        .erteleme-overlay-panel .erteleme-wheel-item {
            font-size: 28px;
        }
        .erteleme-overlay-submit {
            width: 100%;
            max-width: 320px;
            padding: 14px 20px;
            font-size: 15px;
            margin-top: 8px;
        }
        .erteleme-error-box {
            display: none;
            width: 100%;
            margin: 12px 0 16px 0;
            padding: 14px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 14px;
            text-align: center;
        }
        .erteleme-error-box.show { display: block; }
        .erteleme-error-box .erteleme-error-msg {
            font-size: 14px;
            color: #b91c1c;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .erteleme-error-box .erteleme-error-retry {
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .erteleme-error-box .erteleme-error-retry:active { opacity: 0.9; }
        .erteleme-overlay-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border: none;
            background: #f1f5f9;
            color: #64748b;
            font-size: 24px;
            line-height: 1;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .erteleme-overlay-close:active {
            background: #e2e8f0;
        }
        .erteleme-backend-status {
            margin-top: 14px;
            font-size: 12px;
            color: #64748b;
            min-height: 18px;
        }
        .erteleme-backend-status.ok { color: #16a34a; }
        .erteleme-backend-status.fail { color: #dc2626; }
        .erteleme-estimate {
            font-size: 13px;
            color: #64748b;
            margin-top: 10px;
            text-align: center;
        }
        .erteleme-estimate strong {
            color: #764ba2;
        }

        /* Ekran YÃ¶nlendirme Kilidi - Sadece Portre Mod */
        @media screen and (orientation: landscape) {
            body::before {
                content: '[SYNC] LÃ¼tfen telefonunuzu dikey konuma getirin';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 99999;
                font-size: 18px;
                text-align: center;
                padding: 20px;
            }

            body>*:not(::before) {
                display: none !important;
            }
        }

        /* ===== MEMNUNÄ°YET ANKETÄ° STÄ°LLERÄ° ===== */
        .survey-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .survey-card {
            background: white;
            border-radius: 18px;
            padding: 20px 16px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 420px;
            box-sizing: border-box;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }

        .rating-faces {
            display: flex;
            justify-content: space-between;
            gap: 2px;
            margin: 8px 0 12px 0;
            flex-shrink: 0;
        }

        .face-option {
            flex: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 3px 0px;
            border-radius: 6px;
            border: 2px solid transparent;
        }

        .face-option:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.05);
        }

        .face-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .face {
            font-size: 24px;
            margin-bottom: 2px;
            transition: all 0.3s ease;
        }

        .face-option:hover .face {
            transform: scale(1.15);
        }

        .face-label {
            font-size: 7px;
            color: #7f8c8d;
            font-weight: 600;
            line-height: 1.2;
        }

        .face-option.selected .face-label {
            color: #667eea;
        }

        .survey-submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 16px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        .survey-submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .survey-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .survey-submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <!-- BaÄŸlantÄ± durumu: sol Ã¼st, W = WebSocket / P = Polling (yeÅŸil = baÄŸlÄ±, sÃ¶nÃ¼k = deÄŸil) -->
    <div id="connection-badges" class="connection-badges" title="W: WebSocket, P: Polling (yeÅŸil = baÄŸlÄ±)">
        <span id="connection-w" class="connection-badge inactive" title="WebSocket">W</span>
        <span id="connection-p" class="connection-badge inactive" title="Polling">P</span>
    </div>

    <!-- Aktivasyon KatmanÄ± -->
    <div id="activation-overlay">
        <div>
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸ””</div>
            <h2 style="margin-bottom: 10px;">Sesli Bildirimler</h2>
            <p style="opacity: 0.8; margin-bottom: 20px;">SÄ±ranÄ±z geldiÄŸinde sizi sesli ve gÃ¶rÃ¼ntÃ¼lÃ¼ <br> uyarabilmemiz
                iÃ§in onay veriniz.</p>
            <button class="activation-btn" onclick="startNotifications()">BÄ°LDÄ°RÄ°MLERÄ° AÃ‡</button>
        </div>
    </div>
    <div class="ticket">
        <div class="header">
            <h2 id="hospital-name">Ä°RMET HOSPITAL</h2>
            <div style="font-size: 14px; opacity: 0.8;">SÄ±ra Takip Sistemi</div>
        </div>
        <div class="content">
            <div class="label">SÄ±ra NumaranÄ±z</div>
            <div class="number" id="ticket-number">---</div>
            <div class="label" id="queue-name">BÃ¶lÃ¼m YÃ¼kleniyor...</div>
            <div class="status" id="wait-info">GiriÅŸ YapÄ±lÄ±yor...</div>
            <div class="estimated-time" id="estimated-time" style="display: none;">
                â± Tahmini <span id="est-minutes-wrap"><span id="est-minutes" class="value-bubble">--</span></span> dakika
            </div>
        </div>
        <div class="footer">
            <div id="current-time">--:--:--</div>
            <div style="margin-top: 5px;">LÃ¼tfen ekranlardan numaranÄ±zÄ± takip ediniz.</div>
        </div>
        <!-- Erteleme: Ã¶nce sadece buton; tÄ±klanÄ±nca saÄŸ Ã¼stte Ã§ark overlay aÃ§Ä±lÄ±r -->
        <div id="erteleme-wrap" class="erteleme-wrap" style="display: none;">
            <div class="erteleme-inner">
                <button type="button" id="erteleme-open-btn" class="erteleme-btn">Erteleme Ä°ste</button>
                <small id="erteleme-hakki" style="display:block; margin-top:8px; color:#7f8c8d; font-size:12px;"></small>
            </div>
        </div>
    </div>

    <!-- Erteleme Ã§ark overlay - saÄŸ Ã¼st, "Erteleme Ä°ste" tÄ±klanÄ±nca aÃ§Ä±lÄ±r -->
    <div id="erteleme-overlay" class="erteleme-overlay" style="display: none;">
        <div class="erteleme-overlay-panel">
            <button type="button" id="erteleme-overlay-close" class="erteleme-overlay-close" aria-label="Kapat">Ã—</button>
            <div class="erteleme-overlay-header">
                <div class="erteleme-overlay-title">KaÃ§ dakika geciktirmek istiyorsunuz?</div>
                <div class="erteleme-overlay-hint">1â€“60 dakika arasÄ± seÃ§in</div>
            </div>
            <div id="erteleme-estimate" class="erteleme-estimate erteleme-estimate-above">YaklaÅŸÄ±k <strong>0</strong> sÄ±ra geri dÃ¼ÅŸersiniz.</div>
            <div id="erteleme-error" class="erteleme-error-box" role="alert">
                <div class="erteleme-error-msg" id="erteleme-error-msg">BaÄŸlantÄ± hatasÄ±.</div>
                <button type="button" class="erteleme-error-retry" id="erteleme-error-retry">Tekrar dene</button>
            </div>
            <div class="erteleme-wheel-container erteleme-overlay-wheel-wrap">
                <div class="erteleme-wheel-mask erteleme-overlay-wheel-mask">
                    <div id="erteleme-wheel" class="erteleme-wheel erteleme-overlay-wheel" role="listbox" aria-label="Dakika seÃ§in">
                        <div class="erteleme-wheel-spacer"></div>
                    </div>
                </div>
                <div class="erteleme-wheel-unit">dakika</div>
            </div>
            <button type="button" id="erteleme-btn" class="erteleme-btn erteleme-overlay-submit">Ertelemeyi Uygula</button>
            <div id="erteleme-backend-status" class="erteleme-backend-status" aria-live="polite"></div>
        </div>
        <div class="erteleme-overlay-backdrop" id="erteleme-overlay-backdrop"></div>
    </div>

    <!-- Memnuniyet Anketi -->
    <div id="survey-container" class="survey-container" style="display: none;">
        <div class="survey-card">
            <h3 style="color: #764ba2; margin-bottom: 4px; font-size: 17px; font-weight: 700; flex-shrink: 0;">ğŸ¯ AldÄ±ÄŸÄ±nÄ±z Hizmeti PuanlayÄ±n</h3>
            <p style="font-size: 11px; color: #7f8c8d; margin-bottom: 8px; flex-shrink: 0;">
                GÃ¶rÃ¼ÅŸÃ¼nÃ¼z bizim iÃ§in deÄŸerli!
            </p>

            <!-- YÃ¼z Ä°fadeleri -->
            <div class="rating-faces">
                <div class="face-option" data-rating="1" onclick="selectRating(1)">
                    <div class="face">ğŸ˜</div>
                    <div class="face-label">Ã‡ok KÃ¶tÃ¼</div>
                </div>
                <div class="face-option" data-rating="2" onclick="selectRating(2)">
                    <div class="face">ğŸ˜•</div>
                    <div class="face-label">KÃ¶tÃ¼</div>
                </div>
                <div class="face-option" data-rating="3" onclick="selectRating(3)">
                    <div class="face">ğŸ˜</div>
                    <div class="face-label">Normal</div>
                </div>
                <div class="face-option" data-rating="4" onclick="selectRating(4)">
                    <div class="face">ğŸ˜Š</div>
                    <div class="face-label">Ä°yi</div>
                </div>
                <div class="face-option" data-rating="5" onclick="selectRating(5)">
                    <div class="face">ğŸ˜</div>
                    <div class="face-label">MÃ¼kemmel</div>
                </div>
            </div>

            <!-- Yorum AlanÄ± -->
            <div style="margin-top: 8px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                <label style="display: block; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; text-align: center; flex-shrink: 0;">
                    Bize iletmek istediÄŸiniz bir ÅŸey var mÄ±?
                </label>
                <textarea id="survey-comment" placeholder="Ä°steÄŸe baÄŸlÄ±..." rows="4"
                    style="width: 100%; padding: 10px; border: 2px solid #eee; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; text-align: left; box-sizing: border-box; min-height: 80px;"></textarea>
            </div>

            <!-- GÃ¶nder Butonu -->
            <button id="survey-submit-btn" class="survey-submit-btn" onclick="submitSurvey()" disabled style="margin-top: 10px;">
                GÃ¶nder
            </button>

            <!-- TeÅŸekkÃ¼r MesajÄ± -->
            <div id="survey-thanks" style="display: none; text-align: center; padding: 20px 12px;">
                <div style="font-size: 48px; margin-bottom: 12px;"></div>
                <h2 style="color: #22c55e; margin-bottom: 10px; font-size: 20px;">TeÅŸekkÃ¼r Ederiz!</h2>
                <p style="color: #7f8c8d; font-size: 13px; line-height: 1.5;">
                    GÃ¶rÃ¼ÅŸÃ¼nÃ¼z kaydedildi.<br>
                    Ä°yi gÃ¼nler dileriz! ğŸ’™
                </p>
            </div>
        </div>
    </div>

    <script src="static/config.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /*
         * ============================================================
         * SIRAMATÄ°K BÄ°LET TAKÄ°P SÄ°STEMÄ°
         * ============================================================
         * 
         * GÃœNCELLEME MANTIÄI:
         * -------------------
         * 1. WebSocket (GerÃ§ek ZamanlÄ± - 0ms gecikme)
         *    - Backend sunucuya deploy edildiÄŸinde otomatik aktif
         *    - AnÄ±nda bildirim alÄ±rsÄ±n
         * 
         * 2. Polling (Yedek Sistem - 5 saniye)
         *    - WebSocket yoksa veya koptuÄŸunda devreye girer
         *    - Her 5 saniyede Supabase'den veri Ã§eker
         *    - Her durumda Ã§alÄ±ÅŸÄ±r garantisi
         * 
         * BACKEND SUNUCUYA KOYDUÄUNDA:
         * ----------------------------
         * SatÄ±r ~387'de PRODUCTION_WS_URL'e sunucu URL'ini yaz:
         * const PRODUCTION_WS_URL = 'wss://api.yourdomain.com/ws';
         * 
         * Sistem otomatik ÅŸuna geÃ§er:
         * - WebSocket: Aktif (gerÃ§ek zamanlÄ±)
         * - Polling: Pasif bekleme (sadece WebSocket koparsa devreye girer)
         * 
         * ============================================================
         */

        // Verileri sakla/getir (Yenileme korumasÄ±)
        function getTicketData() {
            const params = new URLSearchParams(window.location.search);
            const data = {
                numara: params.get('numara') || localStorage.getItem('bt_numara') || '---',
                kuyruk_ad: params.get('kuyruk') || localStorage.getItem('bt_kuyruk_ad') || 'SÄ±ramatik',
                firma_ad: params.get('firma') || localStorage.getItem('bt_firma_ad') || 'Ä°RMET HOSPITAL',
                kuyruk_id: params.get('kuyruk_id') || localStorage.getItem('bt_kuyruk_id'),
                sira_id: params.get('sira_id') || localStorage.getItem('bt_sira_id'),
                bekleyen: params.get('bekleyen') || localStorage.getItem('bt_bekleyen') || '0',
                servis_id: params.get('servis_id') || localStorage.getItem('bt_servis_id'),
                firma_id: params.get('firma_id') || localStorage.getItem('bt_firma_id') || '1'
            };

            // EÄŸer URL'den geldiyse hafÄ±zaya kaydet
            if (params.get('numara')) {
                localStorage.setItem('bt_numara', data.numara);
                localStorage.setItem('bt_kuyruk_ad', data.kuyruk_ad);
                localStorage.setItem('bt_firma_ad', data.firma_ad);
                localStorage.setItem('bt_kuyruk_id', data.kuyruk_id);
                localStorage.setItem('bt_sira_id', data.sira_id);
                localStorage.setItem('bt_bekleyen', data.bekleyen);
                localStorage.setItem('bt_servis_id', data.servis_id);
                localStorage.setItem('bt_firma_id', data.firma_id);
            }
            return data;
        }

        const ticketSpecs = getTicketData();

        // URL Maskeleme (Veriler saklandÄ±ktan sonra)
        if (window.history.replaceState && window.location.search) {
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
        }

        const numara = ticketSpecs.numara;
        const kuyruk_ad = ticketSpecs.kuyruk_ad;
        const firma_ad = ticketSpecs.firma_ad;
        const kuyruk_id = ticketSpecs.kuyruk_id;
        const sira_id = ticketSpecs.sira_id;

        let sessionDurum = 'waiting';
        let notificationPlayed = false;
        let lastCount = -1;
        let isAudioUnlocked = false;
        let isFirstLoad = true;
        let ertelemeJustApplied = null; // Bir kez set edilir; eski balon hep Ã¼stÃ¼ Ã§izili, yeni deÄŸer her poll'da gÃ¼ncellenir
        let ertelemeKullanilan = 0;
        let ertelemeLimit = 0;
        let ws = null; // WebSocket baÄŸlantÄ±sÄ±
        let pollingInterval = null; // Polling interval referansÄ±
        let isPageVisible = true; // Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k durumu
        let avgProcessTime = 5; // Dinamik olarak gÃ¼ncellenecek ortalama sÃ¼re (dakika)
        let lastSpokenStatus = null; // En son seslendirilen durum metni
        let firmaErtelemeAyar = { erteleme: false, erteleme_sayisi: 0 };
        let firmaErtelemeAyarFetched = false;

        // Backend adresi: config.js (window.API_URL) ile tÃ¼m sitede tek ayar
        function getApiBase() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') return '';
            if (typeof window.API_URL !== 'undefined' && window.API_URL) return window.API_URL.replace(/\/$/, '');
            return window.location.origin;
        }
        // Sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz backendâ€™i uyandÄ±r (Railway cold start; erteleme tÄ±klanÄ±nca hazÄ±r olsun)
        (function () {
            var base = getApiBase();
            if (base) fetch(base + '/health', { method: 'GET', mode: 'cors' }).catch(function () {});
        })();

        // Supabase BaÄŸlantÄ±sÄ±
        const supabaseUrl = 'https://wyursjdrnnjabpfeucyi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5dXJzamRybm5qYWJwZmV1Y3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NzcwOTEsImV4cCI6MjA4NTQ1MzA5MX0.uacZI2vB1pfDyk_UO0lvJBgftJl_R04YX9Bv9kWOLd4';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // ===== UPGRADE: HTML5 Audio (ESKÄ°) + GeliÅŸmiÅŸ Hata YÃ¶netimi (YENÄ°) =====
        const tickSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        const alertSound = tickSound; // BitiÅŸ alarmÄ± da aynÄ± ses

        // Ses yÃ¼kleme kontrolÃ¼
        tickSound.addEventListener('loadeddata', () => {
            console.log('[OK] Ses dosyasÄ± yÃ¼klendi');
        });
        tickSound.addEventListener('error', (e) => {
            console.warn('[WARN] Ses dosyasÄ± yÃ¼klenemedi:', e);
        });

        // iPhone / iPad tespiti (iOS Safari TTS ve ses davranÄ±ÅŸÄ± iÃ§in)
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        // iOS'ta sesler gecikmeli yÃ¼klenir; Ã¶nbelleÄŸe al
        let cachedVoices = [];
        function cacheVoices() {
            cachedVoices = speechSynthesis.getVoices();
            if (isIOS && cachedVoices.length > 0) console.log('[iOS] TTS sesleri yÃ¼klendi:', cachedVoices.length);
        }
        if ('speechSynthesis' in window) {
            cacheVoices();
            speechSynthesis.onvoiceschanged = cacheVoices;
        }

        // TÃ¼rkÃ§e sesli duyuru (Web Speech API) â€” iOS uyumlu. rateOpsiyonel: boÅŸsa 1.02
        function speakTr(metin, rateOpsiyonel) {
            if (!metin || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel();

            const sesler = cachedVoices.length > 0 ? cachedVoices : speechSynthesis.getVoices();
            const trSes = sesler.find(v => v.lang.startsWith('tr'));
            const u = new SpeechSynthesisUtterance(metin);
            u.lang = 'tr-TR';
            u.rate = rateOpsiyonel != null ? rateOpsiyonel : 1.02;
            u.volume = 1;
            if (trSes) u.voice = trSes;

            if (isIOS && sesler.length === 0) {
                // iOS: sesler henÃ¼z yoksa kÄ±sa gecikmeyle tekrar dene
                setTimeout(() => speakTr(metin, rateOpsiyonel), 150);
                return;
            }

            speechSynthesis.speak(u);
        }

        async function startNotifications() {
            // iOS iÃ§in ses kilidi aÃ§ma yÃ¶ntemi
            alertSound.volume = 0.5;
            tickSound.volume = 0.5;

            alertSound.play().then(() => { alertSound.pause(); }).catch(() => { });
            tickSound.play().then(() => { tickSound.pause(); }).catch(() => { });

            isAudioUnlocked = true;
            document.getElementById('activation-overlay').style.display = 'none';

            // iPhone/iPad: TTS'i kullanÄ±cÄ± tÄ±klamasÄ±yla Ä±sÄ±ndÄ±r (sonraki konuÅŸmalar Ã§alÄ±ÅŸsÄ±n)
            if (isIOS && 'speechSynthesis' in window) {
                cacheVoices();
                const wake = new SpeechSynthesisUtterance('\u00A0'); // boÅŸluk
                wake.lang = 'tr-TR';
                wake.volume = 0.01;
                speechSynthesis.speak(wake);
                speechSynthesis.cancel(); // hemen iptal, sadece TTS aktif olsun
            }

            // Test titreÅŸimi
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // Test sesi Ã§al
            setTimeout(() => {
                tickSound.play().catch(e => console.log('Test sesi hatasÄ±:', e));
                console.log('ğŸ”Š Test sesi Ã§alÄ±ndÄ±');
            }, 300);

            // Ortalama bekleme sÃ¼resini arka planda hesapla (bloklamaz; tahmin hazÄ±r olunca gÃ¼ncellenir)
            fetchAverageWaitTime();

            // WebSocket baÄŸlantÄ±sÄ±nÄ± baÅŸlat
            initWebSocket();

            // Ä°lk durumu hemen gÃ¼ncelle (erteleme butonu + yaklaÅŸÄ±k sÃ¼re daha Ã§abuk gÃ¶rÃ¼nsÃ¼n)
            updateStatus();

            // Polling baÅŸlat (fallback)
            startPolling();
        }

        // ===== WEBSOCKET YÃ–NETÄ°MÄ° =====
        function initWebSocket() {
            // config.js ile tÃ¼m sitede tek WS adresi (window.SIRAMATIK_WS_URL)
            let wsUrl = typeof window.SIRAMATIK_WS_URL !== 'undefined' ? window.SIRAMATIK_WS_URL : '';
            if (!wsUrl && window.location.hostname.includes('github.io')) {
                console.log('â„¹ï¸ Backend sunucu bulunamadÄ±, Polling modu aktif (5 saniye)');
                updateConnectionStatus('online', false);
                return;
            }
            if (!wsUrl) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                wsUrl = protocol + '//' + (window.location.hostname || 'localhost') + ':8000/ws';
            }
            console.log('ğŸ”— WebSocket baÄŸlanÄ±yor:', wsUrl);

            console.log('ğŸ”— WebSocket baÄŸlanÄ±yor:', wsUrl);
            updateConnectionStatus('connecting');

            function connect() {
                try {
                    ws = new WebSocket(wsUrl);
                    var connectTimeout = setTimeout(function () {
                        if (ws && ws.readyState === WebSocket.CONNECTING) {
                            console.warn('[WS] BaÄŸlantÄ± zaman aÅŸÄ±mÄ±, polling ile devam.');
                            ws.close();
                        }
                    }, 10000);

                    ws.onopen = function () {
                        clearTimeout(connectTimeout);
                        console.log('[OK] WebSocket baÄŸlandÄ±! GerÃ§ek zamanlÄ± mod aktif.');
                        updateConnectionStatus('online', true);
                        // Polling zaten Ã§alÄ±ÅŸÄ±yor (yedek); durdurmuyoruz
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('ğŸ“© WebSocket mesaj:', data);
                            handleWebSocketMessage(data);
                        } catch (e) {
                            console.error('WebSocket veri hatasÄ±:', e);
                        }
                    };

                    ws.onclose = function () {
                        clearTimeout(connectTimeout);
                        console.warn('[WARN] WebSocket koptu. Polling zaten Ã§alÄ±ÅŸÄ±yor.');
                        updateConnectionStatus('online', false);
                        ws = null;
                        if (!pollingInterval) startPolling();
                        setTimeout(connect, 5000);
                    };

                    ws.onerror = (err) => {
                        console.error('[ERR] WebSocket baÄŸlantÄ± hatasÄ± (Polling devrede)');
                        // Hata durumunda P gÃ¶ster (polling Ã§alÄ±ÅŸÄ±yor)
                        updateConnectionStatus('online', false);
                    };
                } catch (err) {
                    console.error('WebSocket oluÅŸturma hatasÄ±:', err);
                    updateConnectionStatus('online'); // Polling devrede
                }
            }

            connect();
        }

        // WebSocket mesajlarÄ±nÄ± iÅŸle (bilet sayfasÄ± her kuyruk haberiyle gÃ¼ncellenir)
        function handleWebSocketMessage(data) {
            var msgKuyrukId = data.kuyruk_id != null ? data.kuyruk_id : (data.sira && data.sira.kuyruk_id != null ? data.sira.kuyruk_id : null);
            var bizimKuyruk = msgKuyrukId != null && String(msgKuyrukId) === String(kuyruk_id);

            // Ã–NCE: call_ticket â€” biletimiz Ã§aÄŸrÄ±ldÄ±ysa "SÄ±ra sizde" gÃ¶ster
            if (data.type === 'call_ticket' && data.sira) {
                const calledSiraId = data.sira.id || data.sira.sira_id;
                if (calledSiraId && String(calledSiraId) === String(sira_id)) {
                    console.log('ğŸ¯ Biletimiz Ã§aÄŸrÄ±ldÄ± (iÃ§eriden):', data.sira);
                    if (sessionDurum !== 'calling') {
                        notificationPlayed = false;
                        sessionDurum = 'calling';
                    }
                    showCallingStatus(data.sira);
                    return;
                }
                // BaÅŸka biri Ã§aÄŸrÄ±ldÄ± ama aynÄ± kuyruk â€” Ã¶nÃ¼mÃ¼zdeki sayÄ± azaldÄ±, gÃ¼ncelle
                if (bizimKuyruk) {
                    console.log('ğŸ“© Kuyrukta Ã§aÄŸrÄ± (bilet gÃ¼ncelle):', data.sira.numara);
                    updateStatus();
                }
                return;
            }

            // Bu bilet veya kuyrukla ilgili her tÃ¼rlÃ¼ gÃ¼ncelleme
            if (data.sira_id != null && String(data.sira_id) === String(sira_id)) {
                console.log('ğŸ¯ Biletimiz iÃ§in gÃ¼ncelleme:', data);
                updateStatus();
                return;
            }
            if (bizimKuyruk) {
                console.log('ğŸ“© Kuyruk gÃ¼ncellendi:', data.type || data);
                updateStatus();
            }
        }
        
        // "SÄ±ra Sizde" durumunu gÃ¶ster (iÃ§eriden Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda veya normal Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda)
        function showCallingStatus(siraData) {
            const statusEl = document.getElementById('wait-info');
            const numEl = document.getElementById('ticket-number');
            
            // Durumu "SÄ±ra Sizde" olarak ayarla
            statusEl.textContent = "SIRA SÄ°ZDE!";
            statusEl.classList.add('calling-status');
            document.body.classList.add('calling-active-body');
            numEl.style.color = "#22c55e";
            
            // Bildirim oynat (her Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda - notificationPlayed WebSocket'te reset edildi)
            if (!notificationPlayed) {
                notificationPlayed = true;
                
                // 3x alarm Ã§alma (1 saniye aralÄ±kla)
                let playCount = 0;
                alertSound.volume = 1.0;
                
                const playAlert = () => {
                    if (playCount < 3) {
                        console.log(`ğŸ“¢ SIRA SÄ°ZDE! Alarm ${playCount + 1}/3`);
                        
                        // Sesi sÄ±fÄ±rdan baÅŸlat
                        alertSound.pause();
                        alertSound.currentTime = 0;
                        
                        // Sesi Ã§al
                        alertSound.play().catch(e => {
                            console.error("Alarm Ã§alma hatasÄ±:", e);
                        });
                        
                        playCount++;
                        
                        // 1 saniye sonra tekrar (son ses deÄŸilse)
                        if (playCount < 3) {
                            setTimeout(playAlert, 1000);
                        } else {
                            // 3. alarm bittikten sonra sesli "SÄ±ra sizde" oku
                            setTimeout(() => speakTr('SÄ±ra sizde'), 1200);
                        }
                    }
                };
                
                // Ä°lk sesi hemen Ã§al
                playAlert();
                
                // GÃ¼Ã§lÃ¼ titreÅŸim (3 kez tekrarlÄ±)
                if (navigator.vibrate) {
                    navigator.vibrate([500, 200, 500, 200, 500, 200, 500, 200, 500, 200, 1000]);
                }
            }
        }

        // BaÄŸlantÄ± durumu: iki balon (W = WebSocket, P = Polling); yeÅŸil = baÄŸlÄ±, sÃ¶nÃ¼k = deÄŸil
        let isWebSocketActive = false;
        function updateConnectionStatus(status, isWebSocket) {
            var wEl = document.getElementById('connection-w');
            var pEl = document.getElementById('connection-p');
            if (!wEl || !pEl) return;
            isWebSocketActive = isWebSocket === true;
            if (status === 'online') {
                wEl.className = 'connection-badge ' + (isWebSocketActive ? 'active' : 'inactive');
                pEl.className = 'connection-badge active'; // Polling her zaman Ã§alÄ±ÅŸÄ±yor
            } else if (status === 'connecting') {
                wEl.className = 'connection-badge connecting';
                pEl.className = 'connection-badge active';
            } else {
                wEl.className = 'connection-badge inactive';
                pEl.className = 'connection-badge active';
            }
        }

        // Polling: Her 3 saniyede bir gÃ¼ncelle (WebSocket aÃ§Ä±k olsa da yedek / kayÄ±p mesaj telafisi)
        var POLLING_INTERVAL_MS = 3000;
        function startPolling() {
            if (pollingInterval) {
                console.log('â„¹ï¸ Polling zaten aktif');
                return;
            }
            console.log('[SYNC] Polling baÅŸlatÄ±lÄ±yor (' + (POLLING_INTERVAL_MS / 1000) + ' saniye aralÄ±k, WebSocket olsa da Ã§alÄ±ÅŸÄ±r)');
            pollingInterval = setInterval(function () {
                updateStatus();
            }, POLLING_INTERVAL_MS);
        }

        // Page Visibility API (Arka plan kontrolÃ¼)
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;

            if (isPageVisible) {
                console.log('ğŸ‘€ Sayfa gÃ¶rÃ¼nÃ¼r hale geldi');
                updateStatus(); // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda hemen gÃ¼ncelle
                updatePageTitle(); // BaÅŸlÄ±ÄŸÄ± sÄ±fÄ±rla
            } else {
                console.log('ğŸ™ˆ Sayfa arka planda');
            }
        });

        // Ä°lk verileri URL'den bas
        document.getElementById('ticket-number').textContent = numara;
        document.getElementById('queue-name').textContent = kuyruk_ad;
        document.getElementById('hospital-name').textContent = firma_ad;
        document.getElementById('wait-info').innerHTML = 'Ã–nÃ¼nÃ¼zde <span class="value-bubble">' + (ticketSpecs.bekleyen || '0') + '</span> kiÅŸi var';

        // Ä°lk bekleyen sayÄ±sÄ±nÄ± kaydet (URL'den)
        const bekleyen_url = ticketSpecs.bekleyen;
        if (bekleyen_url && bekleyen_url !== '0') {
            lastCount = parseInt(bekleyen_url);
            isFirstLoad = false; // Ä°lk veri URL'den geldi
            console.log(` Ä°lk bekleyen sayÄ±sÄ± (URL): ${lastCount}`);
        }

        // Kuyruk iÃ§in ortalama bekleme sÃ¼resini hesapla
        async function fetchAverageWaitTime() {
            if (!kuyruk_id) return;

            try {
                const kid = parseInt(kuyruk_id);

                // Son 7 gÃ¼nÃ¼n ortalamasÄ±nÄ± al (siramatik ÅŸemasÄ±ndaki fonksiyon)
                const { data, error } = await _supabase
                    .schema('siramatik')
                    .rpc('ortalama_bekleme_suresi', {
                        p_kuyruk_id: kid,
                        p_gun_sayisi: 7
                    });

                if (error) {
                    console.warn('Ortalama sÃ¼re RPC hatasÄ±:', error);
                    // Fallback: Manuel hesapla
                    const avgToday = await calculateTodayAverage(kid);
                    avgProcessTime = avgToday > 0 ? avgToday : 5;
                    console.log(` Manuel hesaplama: ${avgProcessTime} dk (fallback: 5 dk)`);
                } else if (data !== null && data > 0) {
                    avgProcessTime = data;
                    console.log(` Kuyruk ${kuyruk_id} iÃ§in ortalama bekleme (7 gÃ¼n): ${avgProcessTime} dk`);
                } else {
                    // Veri yoksa bugÃ¼nÃ¼n ortalamasÄ±nÄ± dene
                    const avgToday = await calculateTodayAverage(kid);
                    avgProcessTime = avgToday > 0 ? avgToday : 5;
                    console.log(` BugÃ¼nÃ¼n ortalamasÄ±: ${avgProcessTime} dk (fallback: 5 dk)`);
                }
            } catch (e) {
                console.error('Ortalama sÃ¼re hatasÄ±:', e);
                avgProcessTime = 5; // Fallback
            }
            // Tahmini sÃ¼re alanÄ±nÄ± gÃ¼ncelle (Ã¶nceden 5 dk gÃ¶steriliyorsa gerÃ§ek ortalamayla yenile)
            if (typeof updateEstimatedTime === 'function' && lastCount >= 0) updateEstimatedTime(lastCount);
        }

        // BugÃ¼nÃ¼n ortalamasÄ±nÄ± manuel hesapla (fallback)
        async function calculateTodayAverage(kid) {
            try {
                // BugÃ¼nÃ¼n baÅŸlangÄ±cÄ± (timezone zaten Supabase'de ayarlÄ±, direkt yerel saat kullan)
                const simdi = new Date();
                const bugunBaslangic = new Date(simdi.getFullYear(), simdi.getMonth(), simdi.getDate(), 0, 0, 0, 0);
                const bugunBaslangicISO = bugunBaslangic.toISOString();

                const { data, error } = await _supabase
                    .schema('siramatik')
                    .from('siralar')
                    .select('olusturulma, etkin_olusturulma, cagirilma')
                    .eq('kuyruk_id', kid)
                    .in('durum', ['calling', 'completed'])
                    .gte('olusturulma', bugunBaslangicISO)
                    .not('cagirilma', 'is', null);

                if (error || !data || data.length === 0) {
                    return 0;
                }

                // Ortalama bekleme sÃ¼resini hesapla (dakika) - etkin zamana gÃ¶re
                const totalMinutes = data.reduce((sum, row) => {
                    const effective = row.etkin_olusturulma || row.olusturulma;
                    const called = new Date(row.cagirilma);
                    const diffMinutes = (called - new Date(effective)) / 60000;
                    return sum + diffMinutes;
                }, 0);

                const avgMinutes = Math.round(totalMinutes / data.length);
                return avgMinutes > 0 ? avgMinutes : 0;
            } catch (e) {
                console.error('BugÃ¼n ortalama hesaplama hatasÄ±:', e);
                return 0;
            }
        }

        async function updateStatus() {
            const statusEl = document.getElementById('wait-info');
            const numEl = document.getElementById('ticket-number');

            if (!kuyruk_id || !sira_id) {
                console.warn("CanlÄ± takip iÃ§in sira_id veya kuyruk_id eksik.");
                return;
            }

            try {
                const kid = parseInt(kuyruk_id);
                const sid = parseInt(sira_id);
                const firmaIdFromUrl = ticketSpecs.firma_id || null;

                // 1. Bilet + erteleme ayarÄ±nÄ± paralel Ã§ek (firma_id URL'de varsa daha hÄ±zlÄ±)
                const promiseMyTicket = _supabase
                    .schema('siramatik')
                    .from('siralar')
                    .select('durum, oncelik, olusturulma, etkin_olusturulma, erteleme_sayisi, firma_id')
                    .eq('id', sid)
                    .single();

                let promiseErteleme = null;
                if (firmaIdFromUrl && !firmaErtelemeAyarFetched) {
                    firmaErtelemeAyarFetched = true;
                    const base = getApiBase();
                    promiseErteleme = fetch(base + '/api/public/firma/' + firmaIdFromUrl + '/erteleme-ayarlari').then(function(r) { return r.ok ? r.json() : null; }).catch(function() { return null; });
                }

                const myTicket = await promiseMyTicket;
                if (myTicket.error) throw myTicket.error;
                const me = myTicket.data;

                if (promiseErteleme) {
                    const j = await promiseErteleme;
                    if (j) firmaErtelemeAyar = { erteleme: !!j.erteleme, erteleme_sayisi: parseInt(j.erteleme_sayisi, 10) || 0 };
                } else if ((me && me.firma_id) && !firmaErtelemeAyarFetched) {
                    firmaErtelemeAyarFetched = true;
                    try {
                        const base = getApiBase();
                        const r = await fetch(base + '/api/public/firma/' + me.firma_id + '/erteleme-ayarlari');
                        if (r.ok) {
                            const j = await r.json();
                            firmaErtelemeAyar = { erteleme: !!j.erteleme, erteleme_sayisi: parseInt(j.erteleme_sayisi, 10) || 0 };
                        }
                    } catch (e) { console.warn('Erteleme ayarlarÄ± alÄ±namadÄ±:', e); }
                }

                // Durum kontrolÃ¼
                if (me.durum === 'calling') {
                    // Sadece waiting â†’ calling geÃ§iÅŸinde alarm + sesli duyuru Ã§alÄ±ÅŸsÄ±n
                    if (sessionDurum !== 'calling') {
                        notificationPlayed = false;
                        sessionDurum = 'calling';
                        showCallingStatus({ id: sid });
                    } else {
                        // Yine de gÃ¶rsel durumu koru
                        showCallingStatus({ id: sid });
                    }
                    return;
                } else if (me.durum === 'completed') {
                    statusEl.textContent = "Ä°ÅLEM TAMAMLANDI";
                    statusEl.classList.remove('calling-status');
                    document.body.classList.remove('calling-active-body');
                    statusEl.style.background = "#94a3b8";
                    notificationPlayed = false;
                    sessionDurum = 'completed';

                    // Anket gÃ¶ster (sadece bir kez)
                    showSurvey();
                    return;
                }

                // Ã–nÃ¼nÃ¼zdekileri saymak iÃ§in 2 sorguyu paralel Ã§alÄ±ÅŸtÄ±r (etkin_olusturulma null olmasÄ±n diye fallback)
                const etkinOlusturulma = me.etkin_olusturulma || me.olusturulma || new Date().toISOString();
                const [highPriority, samePriorityBefore] = await Promise.all([
                    _supabase.schema('siramatik').from('siralar').select('*', { count: 'exact', head: true })
                        .eq('kuyruk_id', kid).eq('durum', 'waiting').gt('oncelik', me.oncelik),
                    _supabase.schema('siramatik').from('siralar').select('*', { count: 'exact', head: true })
                        .eq('kuyruk_id', kid).eq('durum', 'waiting').eq('oncelik', me.oncelik).lt('etkin_olusturulma', etkinOlusturulma)
                ]);

                if (highPriority.error) throw highPriority.error;
                if (samePriorityBefore.error) throw samePriorityBefore.error;

                const count = (highPriority.count || 0) + (samePriorityBefore.count || 0);
                console.log(`[SEARCH] SayaÃ§: YÃ¼ksek:${highPriority.count}, AynÄ±:${samePriorityBefore.count}, Toplam:${count}`);

                // Erteleme var mÄ±? (etkin_olusturulma > olusturulma ise bilet ertelenmiÅŸ demektir)
                const olusturulmaMs = me.olusturulma ? new Date(me.olusturulma).getTime() : 0;
                const etkinMs = etkinOlusturulma ? new Date(etkinOlusturulma).getTime() : 0;
                const ertelemeVar = olusturulmaMs > 0 && etkinMs > olusturulmaMs;
                let oldCountForDiff = null;
                if (ertelemeVar && me.olusturulma) {
                    const samePriorityBeforeByOlusturulma = await _supabase
                        .schema('siramatik')
                        .from('siralar')
                        .select('*', { count: 'exact', head: true })
                        .eq('kuyruk_id', kid)
                        .eq('durum', 'waiting')
                        .eq('oncelik', me.oncelik)
                        .lt('olusturulma', me.olusturulma);
                    if (!samePriorityBeforeByOlusturulma.error)
                        oldCountForDiff = (highPriority.count || 0) + (samePriorityBeforeByOlusturulma.count || 0);
                }

                // GeliÅŸmiÅŸ sÄ±ra azalma kontrolÃ¼
                if (isFirstLoad) {
                    // Ä°lk yÃ¼kleme: Sadece kaydet
                    lastCount = count;
                    isFirstLoad = false;
                    console.log(` Ä°lk bekleyen sayÄ±sÄ± (API): ${count}`);
                } else if (lastCount !== -1 && count < lastCount && count >= 0) {
                    // Bekleyen azaldÄ± - ses + titreÅŸim + animasyon
                    console.log(`ğŸ”” Bekleyen azaldÄ±: ${lastCount} â†’ ${count}`);

                    // SayÄ± animasyonu
                    numEl.classList.add('animate-decrease');
                    setTimeout(() => numEl.classList.remove('animate-decrease'), 600);

                    // Ses + TitreÅŸim (bir kez kullanÄ±cÄ± dokunduysa isAudioUnlocked true; yoksa yine dene)
                    tickSound.pause();
                    tickSound.currentTime = 0;
                    tickSound.volume = 0.6;
                    tickSound.play().catch(e => console.log("Tick sesi Ã§alÄ±namadÄ±:", e));
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }

                    // Sayfa arka plandaysa baÅŸlÄ±ÄŸÄ± gÃ¼ncelle
                    if (!isPageVisible) {
                        updatePageTitle(`ğŸ”” ${count} kiÅŸi kaldÄ±!`);
                    }

                    lastCount = count;
                } else {
                    lastCount = count;
                }

                // Durum mesajÄ± gÃ¼ncelle (waiting durumu)
                document.body.classList.remove('calling-active-body');
                statusEl.classList.remove('calling-status');
                numEl.style.color = "#764ba2";

                if (count === 0) {
                    statusEl.textContent = "SÄ±radaki sizsiniz!";
                    statusEl.style.color = "#764ba2";
                    statusEl.style.fontWeight = "bold";
                    updateEstimatedTime(0);
                } else {
                    // Eski balon Ã¼stÃ¼ Ã§izili: ya az Ã¶nce erteleme yapÄ±ldÄ± (ertelemeJustApplied) ya da bilet zaten ertelenmiÅŸ (etkin_olusturulma > olusturulma)
                    const oldBekleyen = (ertelemeJustApplied && ertelemeJustApplied.oldBekleyen !== undefined)
                        ? ertelemeJustApplied.oldBekleyen
                        : (ertelemeVar && oldCountForDiff !== null ? oldCountForDiff : null);
                    const oldMinutesForEst = (ertelemeJustApplied && ertelemeJustApplied.oldMinutes !== undefined)
                        ? ertelemeJustApplied.oldMinutes
                        : (oldBekleyen !== null ? Math.ceil(oldBekleyen * (typeof avgProcessTime !== 'undefined' ? avgProcessTime : 5)) : undefined);
                    const showErtelemeDiff = oldBekleyen !== null;
                    if (showErtelemeDiff) {
                        statusEl.innerHTML = 'Ã–nÃ¼nÃ¼zde <span class="value-bubble value-bubble-old">' + oldBekleyen + '</span> <span class="value-bubble value-bubble-new">' + count + '</span> kiÅŸi var';
                    } else {
                        statusEl.innerHTML = 'Ã–nÃ¼nÃ¼zde <span class="value-bubble">' + count + '</span> kiÅŸi var';
                    }
                    statusEl.style.color = "#667eea";
                    updateEstimatedTime(count, oldMinutesForEst);
                }

                // Sesli oku: her zaman gÃ¼ncel Ã¶nÃ¼ndeki kiÅŸi sayÄ±sÄ± (ertelenmemiÅŸte 1 sayÄ±, ertelenmiÅŸte sadece yeni sayÄ±)
                const textForSpeech = 'Ã–nÃ¼nÃ¼zde ' + count + ' kiÅŸi var';
                if (textForSpeech !== lastSpokenStatus) {
                    lastSpokenStatus = textForSpeech;
                    setTimeout(function() { speakTr(textForSpeech); }, 250);
                }

                sessionDurum = 'waiting';

                // Sayfa baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
                if (isPageVisible) {
                    updatePageTitle();
                }

                if (me.durum === 'waiting') notificationPlayed = false;

                // Erteleme bloÄŸu: beklerken (waiting) her zaman gÃ¶ster; hakkÄ± bittiyse buton sÃ¶nÃ¼k + mesaj
                const ertelemeWrap = document.getElementById('erteleme-wrap');
                const ertelemeHakkiEl = document.getElementById('erteleme-hakki');
                const ertelemeOpenBtn = document.getElementById('erteleme-open-btn');
                const ticketErtelemeKullanilan = parseInt(me.erteleme_sayisi, 10) || 0;
                const limit = firmaErtelemeAyar.erteleme_sayisi || 0;
                ertelemeKullanilan = ticketErtelemeKullanilan;
                ertelemeLimit = limit;
                const ertelemeGoster = me.durum === 'waiting';
                const ertelemeHakkiBitti = limit > 0 && ticketErtelemeKullanilan >= limit;
                if (ertelemeWrap) {
                    ertelemeWrap.style.display = ertelemeGoster ? 'block' : 'none';
                    if (ertelemeHakkiEl) {
                        if (ertelemeHakkiBitti)
                            ertelemeHakkiEl.textContent = 'Bu firma sadece ' + limit + ' erteleme hakkÄ± tanÄ±yor; kullandÄ±nÄ±z.';
                        else if (ertelemeGoster && firmaErtelemeAyar.erteleme && limit > 0 && ticketErtelemeKullanilan < limit)
                            ertelemeHakkiEl.textContent = limit - ticketErtelemeKullanilan === 1 ? '1 erteleme hakkÄ±nÄ±z var.' : (limit - ticketErtelemeKullanilan) + ' erteleme hakkÄ±nÄ±z var.';
                        else if (ertelemeGoster)
                            ertelemeHakkiEl.textContent = 'Erteleme isteÄŸi gÃ¶nderebilirsiniz; uygun deÄŸilse sunucu bilgi verecektir.';
                        else
                            ertelemeHakkiEl.textContent = '';
                    }
                    if (ertelemeOpenBtn) {
                        ertelemeOpenBtn.disabled = ertelemeHakkiBitti;
                        ertelemeOpenBtn.style.opacity = ertelemeHakkiBitti ? '0.6' : '';
                    }
                }

            } catch (e) {
                console.error("Takip HatasÄ±:", e);
            }
        }

        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleTimeString('tr-TR');
        }

        // Tahmini bekleme sÃ¼resini gÃ¼ncelle (erteleme sonrasÄ± oldMinutes verilirse eski Ã¼stÃ¼ Ã§izili + yeni balon)
        function updateEstimatedTime(count, oldMinutes) {
            const estimatedEl = document.getElementById('estimated-time');
            const wrapEl = document.getElementById('est-minutes-wrap');

            if (count === 0 || !wrapEl) {
                if (estimatedEl) estimatedEl.style.display = 'none';
                return;
            }
            const minutes = Math.ceil(count * avgProcessTime);
            if (oldMinutes !== undefined && oldMinutes !== null) {
                wrapEl.innerHTML = '<span class="value-bubble value-bubble-old">' + oldMinutes + '</span> <span class="value-bubble value-bubble-new">' + minutes + '</span>';
            } else {
                wrapEl.innerHTML = '<span id="est-minutes" class="value-bubble">' + minutes + '</span>';
            }
            estimatedEl.style.display = 'inline-block';
            console.log(`â± Tahmini bekleme: ${count} kiÅŸi Ã— ${avgProcessTime} dk = ${minutes} dk`);
        }

        // Sayfa baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle (Arka plan bildirimleri iÃ§in)
        function updatePageTitle(customTitle = null) {
            const titleEl = document.getElementById('page-title');
            const faviconEl = document.getElementById('favicon');

            if (customTitle) {
                titleEl.textContent = customTitle;
                // Favicon'u bildirim ikonu yap
                faviconEl.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ””</text></svg>";
            } else {
                // Normal baÅŸlÄ±k
                titleEl.textContent = `${firma_ad} - SÄ±ra Takip`;
                faviconEl.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ«</text></svg>";
            }
        }

        var ERTELEME_FETCH_TIMEOUT_MS = 45000;
        async function requestErteleme() {
            const btn = document.getElementById('erteleme-btn');
            if (!sira_id || !btn) return;
            const dakika = getErtelemeWheelValue ? getErtelemeWheelValue() : 10;
            if (dakika < 1 || dakika > 60) return;
            btn.disabled = true;
            btn.textContent = 'Ä°ÅŸleniyor...';
            var base = getApiBase();
            var attempt = 0;
            var maxAttempts = 3;
            function doFetch() {
                var ctrl = new AbortController();
                var t = setTimeout(function () { ctrl.abort(); }, ERTELEME_FETCH_TIMEOUT_MS);
                return fetch(base + '/api/sira/ertele/' + sira_id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dakika: dakika }),
                    signal: ctrl.signal,
                    mode: 'cors'
                }).finally(function () { clearTimeout(t); });
            }
            try {
                var r = null;
                while (attempt < maxAttempts) {
                    try {
                        r = await doFetch();
                        break;
                    } catch (e) {
                        attempt++;
                        if (attempt >= maxAttempts) throw e;
                    }
                }
                const data = await r.json().catch(function () { return {}; });
                hideErtelemeError();
                if (r.ok && data.success) {
                    if (data.mesaj) alert(data.mesaj);
                    const oldB = lastCount >= 0 ? lastCount : 0;
                    const oldM = lastCount >= 0 ? Math.ceil(lastCount * (typeof avgProcessTime !== 'undefined' ? avgProcessTime : 5)) : 0;
                    ertelemeJustApplied = { oldBekleyen: oldB, oldMinutes: oldM };
                    // Hemen DOM gÃ¼ncelle: eski Ã¼stÃ¼ Ã§izili gÃ¶rÃ¼nsÃ¼n, yeni deÄŸer fetch gelince dolacak
                    const statusEl = document.getElementById('wait-info');
                    const wrapEl = document.getElementById('est-minutes-wrap');
                    if (statusEl) statusEl.innerHTML = 'Ã–nÃ¼nÃ¼zde <span class="value-bubble value-bubble-old">' + oldB + '</span> <span class="value-bubble value-bubble-new">â€¦</span> kiÅŸi var';
                    if (wrapEl) wrapEl.innerHTML = '<span class="value-bubble value-bubble-old">' + oldM + '</span> <span class="value-bubble value-bubble-new" id="est-minutes">â€¦</span>';
                    const estBlock = document.getElementById('estimated-time');
                    if (estBlock) estBlock.style.display = 'inline-block';
                    updateStatus();
                    closeErtelemeOverlay();
                } else {
                    const d = String(data.detail || '');
                    const hakKalmadi = (d.indexOf('hak') !== -1 || d.indexOf('kalmadÄ±') !== -1 || d.indexOf('erteleme_sayisi') !== -1) && ertelemeLimit > 0;
                    const msg = hakKalmadi ? 'Bu firma sadece ' + ertelemeLimit + ' erteleme hakkÄ± tanÄ±yor ve onu kullandÄ±nÄ±z.' : (data.detail || 'Erteleme yapÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.');
                    showErtelemeError(msg);
                }
            } catch (e) {
                console.error('Erteleme hatasÄ±:', e);
                showErtelemeError('Sunucuya ulaÅŸÄ±lamadÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin; birkaÃ§ saniye sonra \'Tekrar dene\' ile yeniden deneyin.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ertelemeyi Uygula';
            }
        }

        function updateErtelemeEstimate() {
            const dakika = getErtelemeWheelValue ? getErtelemeWheelValue() : 10;
            const estEl = document.getElementById('erteleme-estimate');
            if (!estEl) return;
            const avg = typeof avgProcessTime !== 'undefined' ? avgProcessTime : 5;
            const x = avg > 0 ? Math.max(0, Math.round(dakika / avg)) : 0;
            estEl.innerHTML = 'YaklaÅŸÄ±k <strong>' + x + '</strong> sÄ±ra geri dÃ¼ÅŸersiniz.';
        }

        function showErtelemeError(message) {
            const box = document.getElementById('erteleme-error');
            const msg = document.getElementById('erteleme-error-msg');
            if (box && msg) { msg.textContent = message; box.classList.add('show'); }
        }
        function hideErtelemeError() {
            const box = document.getElementById('erteleme-error');
            if (box) box.classList.remove('show');
        }
        function setBackendStatus(text, ok) {
            var el = document.getElementById('erteleme-backend-status');
            if (!el) return;
            el.textContent = text || '';
            el.className = 'erteleme-backend-status' + (ok === true ? ' ok' : ok === false ? ' fail' : '');
        }
        function openErtelemeOverlay() {
            if (ertelemeLimit > 0 && ertelemeKullanilan >= ertelemeLimit) {
                alert('Bu firma sadece ' + ertelemeLimit + ' erteleme hakkÄ± tanÄ±yor ve onu kullandÄ±nÄ±z.');
                return;
            }
            const overlay = document.getElementById('erteleme-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';
            overlay.setAttribute('data-open', 'true');
            hideErtelemeError();
            buildErtelemeWheel();
            updateErtelemeEstimate();
            var base = getApiBase();
            if (base) {
                setBackendStatus('Sunucu durumu: kontrol ediliyorâ€¦', null);
                var healthTimeout = 12000;
                var healthAbort = new AbortController();
                var timeoutId = setTimeout(function () {
                    healthAbort.abort();
                    setBackendStatus('BaÄŸlantÄ± gecikiyor; ertelemeyi yine de deneyebilirsiniz.', false);
                }, healthTimeout);
                fetch(base + '/health', { method: 'GET', mode: 'cors', signal: healthAbort.signal }).then(function (r) {
                    clearTimeout(timeoutId);
                    if (r.ok) setBackendStatus('Sunucu eriÅŸilebilir âœ“', true);
                    else setBackendStatus('Sunucu yanÄ±t veremedi (HTTP ' + r.status + ')', false);
                }).catch(function (e) {
                    clearTimeout(timeoutId);
                    if (e.name === 'AbortError') return;
                    setBackendStatus('AÄŸ hatasÄ±; ertelemeyi yine de deneyebilirsiniz.', false);
                });
                fetch(base + '/api/public/db-check', { method: 'GET' }).then(function (r) {
                    if (!r.ok) r.json().then(function (d) { if (d.detail && (String(d.detail).indexOf('yazma') !== -1 || String(d.detail).indexOf('permission') !== -1)) showErtelemeError(d.detail); }).catch(function () {});
                }).catch(function () {});
            } else {
                setBackendStatus('', null);
            }
        }
        function closeErtelemeOverlay() {
            const overlay = document.getElementById('erteleme-overlay');
            if (!overlay) return;
            overlay.style.display = 'none';
            overlay.removeAttribute('data-open');
            setBackendStatus('', null);
        }

        const ERTELEME_ITEM_HEIGHT = 40;
        const ERTELEME_WHEEL_PADDING_TOP = 40; /* .erteleme-wheel { padding: 40px 24px } */
        function buildErtelemeWheel() {
            const wheel = document.getElementById('erteleme-wheel');
            if (!wheel || wheel.dataset.built === '1') return;
            wheel.innerHTML = '';
            const topPad = document.createElement('div');
            topPad.className = 'erteleme-wheel-spacer';
            wheel.appendChild(topPad);
            for (let i = 1; i <= 60; i++) {
                const div = document.createElement('div');
                div.className = 'erteleme-wheel-item';
                div.setAttribute('data-value', i);
                div.textContent = i;
                wheel.appendChild(div);
            }
            const bottomPad = document.createElement('div');
            bottomPad.className = 'erteleme-wheel-spacer';
            wheel.appendChild(bottomPad);
            wheel.dataset.built = '1';
            setErtelemeWheelValue(10);
            wheel.addEventListener('scroll', function () {
                updateErtelemeEstimate();
                clearTimeout(wheel._scrollTimer);
                wheel._scrollTimer = setTimeout(function () { snapErtelemeWheel(); }, 100);
            });
            wheel.addEventListener('touchmove', function () {
                updateErtelemeEstimate();
                clearTimeout(wheel._scrollTimer);
                wheel._scrollTimer = setTimeout(function () { snapErtelemeWheel(); }, 150);
            }, { passive: true });
            updateErtelemeEstimate();
        }
        function getErtelemeWheelValue() {
            const wheel = document.getElementById('erteleme-wheel');
            if (!wheel || !wheel.children.length) return 10;
            const st = wheel.scrollTop;
            const value = Math.round((st - ERTELEME_WHEEL_PADDING_TOP) / ERTELEME_ITEM_HEIGHT) + 1;
            return Math.max(1, Math.min(60, value));
        }
        function setErtelemeWheelValue(dakika) {
            const wheel = document.getElementById('erteleme-wheel');
            if (!wheel) return;
            const targetScroll = ERTELEME_WHEEL_PADDING_TOP + (dakika - 1) * ERTELEME_ITEM_HEIGHT;
            wheel.scrollTop = targetScroll;
        }
        function snapErtelemeWheel() {
            const wheel = document.getElementById('erteleme-wheel');
            if (!wheel) return;
            const v = getErtelemeWheelValue();
            setErtelemeWheelValue(v);
            updateErtelemeEstimate();
        }
        document.getElementById('erteleme-btn').addEventListener('click', requestErteleme);
        document.getElementById('erteleme-open-btn').addEventListener('click', openErtelemeOverlay);
        document.getElementById('erteleme-overlay-close').addEventListener('click', closeErtelemeOverlay);
        document.getElementById('erteleme-overlay-backdrop').addEventListener('click', closeErtelemeOverlay);
        document.getElementById('erteleme-error-retry').addEventListener('click', function () { hideErtelemeError(); requestErteleme(); });

        // Sayfa yÃ¼klendiÄŸinde
        setInterval(updateTime, 1000);
        updateTime();

        // Ä°lk baÅŸlÄ±k ayarÄ±
        updatePageTitle();

        // ===== EKRAN YÃ–NÃœ KÄ°LÄ°DÄ° =====
        // Screen Orientation API ile portre modunu kilitle
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('portrait').then(() => {
                console.log('ğŸ”’ Ekran portre modunda kilitlendi');
            }).catch(err => {
                console.log('â„¹ï¸ Ekran kilidi desteklenmiyor (CSS fallback aktif)');
            });
        }

        // Oryantasyon deÄŸiÅŸimini dinle ve uyar
        window.addEventListener('orientationchange', () => {
            if (window.orientation === 90 || window.orientation === -90) {
                console.warn('[WARN] Telefon yatay konumda - LÃ¼tfen dikey konuma getirin');
            }
        });

        // ===== MEMNUNÄ°YET ANKETÄ° =====
        let selectedRating = 0;
        let surveyShown = false;

        // Ses efektleri fonksiyonlarÄ±
        let audioContextInstance = null;
        let audioContextInitialized = false;
        
        // AudioContext'i kullanÄ±cÄ± etkileÅŸimi ile baÅŸlat (tarayÄ±cÄ± kÄ±sÄ±tlamasÄ± iÃ§in)
        function initAudioContext() {
            if (!audioContextInstance) {
                try {
                    audioContextInstance = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('[AUDIO] AudioContext oluÅŸturuldu, durum:', audioContextInstance.state);
                } catch (e) {
                    console.warn('AudioContext oluÅŸturulamadÄ±:', e);
                    return null;
                }
            }
            
            // EÄŸer suspended durumundaysa resume et
            if (audioContextInstance.state === 'suspended') {
                audioContextInstance.resume().then(() => {
                    console.log('[AUDIO] AudioContext resume edildi');
                    audioContextInitialized = true;
                }).catch(e => {
                    console.warn('[AUDIO] AudioContext resume edilemedi:', e);
                });
            } else {
                audioContextInitialized = true;
            }
            
            return audioContextInstance;
        }
        
        // Sayfa yÃ¼klendiÄŸinde kullanÄ±cÄ± etkileÅŸimi bekle (AudioContext iÃ§in)
        document.addEventListener('click', function initAudioOnInteraction() {
            if (!audioContextInitialized) {
                initAudioContext();
                // Ä°lk etkileÅŸimden sonra listener'Ä± kaldÄ±r
                document.removeEventListener('click', initAudioOnInteraction);
            }
        }, { once: true });
        
        // Touch event iÃ§in de ekle (mobil cihazlar)
        document.addEventListener('touchstart', function initAudioOnTouch() {
            if (!audioContextInitialized) {
                initAudioContext();
                document.removeEventListener('touchstart', initAudioOnTouch);
            }
        }, { once: true });

        function playHappySound() {
            try {
                const audioContext = initAudioContext();
                if (!audioContext) return;
                
                // AudioContext suspended ise resume et
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        playHappySoundInternal(audioContext);
                    }).catch(e => {
                        console.warn('AudioContext resume edilemedi:', e);
                    });
                } else {
                    playHappySoundInternal(audioContext);
                }
            } catch (e) {
                console.warn('Ses Ã§alÄ±namadÄ±:', e);
            }
        }
        
        function playHappySoundInternal(audioContext) {
            // NeÅŸeli ve dinamik melodi: Do-Mi-Sol-Do (yÃ¼ksek oktav)
            const notes = [
                { freq: 523.25, duration: 150 }, // Do (C5)
                { freq: 659.25, duration: 150 }, // Mi (E5)
                { freq: 783.99, duration: 150 }, // Sol (G5)
                { freq: 1046.50, duration: 300 }  // Do (C6) - daha uzun
            ];
            
            let currentTime = audioContext.currentTime;
            
            notes.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = note.freq;
                oscillator.type = 'sine';
                
                // YumuÅŸak baÅŸlangÄ±Ã§ ve bitiÅŸ (fade in/out)
                gainNode.gain.setValueAtTime(0, currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, currentTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(0, currentTime + note.duration / 1000);
                
                oscillator.start(currentTime);
                oscillator.stop(currentTime + note.duration / 1000);
                
                currentTime += note.duration / 1000;
            });
        }

        function playThankYouSound() {
            try {
                const audioContext = initAudioContext();
                if (!audioContext) return;
                
                // AudioContext suspended ise resume et
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        playThankYouSoundInternal(audioContext);
                    }).catch(e => {
                        console.warn('AudioContext resume edilemedi:', e);
                    });
                } else {
                    playThankYouSoundInternal(audioContext);
                }
            } catch (e) {
                console.warn('Ses Ã§alÄ±namadÄ±:', e);
            }
        }
        
        function playThankYouSoundInternal(audioContext) {
            // Ufak, yumuÅŸak "ding" sesi
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // Orta-yÃ¼ksek frekans
            oscillator.type = 'sine';
            
            // Ã‡ok yumuÅŸak ve kÄ±sa
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function showSurvey() {
            // Sadece bir kez gÃ¶ster
            if (surveyShown) return;

            // Daha Ã¶nce anket gÃ¶nderilmiÅŸ mi kontrol et
            const surveySubmitted = localStorage.getItem(`survey_${sira_id}`);
            if (surveySubmitted) {
                console.log('â„¹ï¸ Anket daha Ã¶nce gÃ¶nderilmiÅŸ');
                return;
            }

            surveyShown = true;
            document.getElementById('survey-container').style.display = 'block';

            // NeÅŸeli ve dinamik ses Ã§al (anket aÃ§Ä±lÄ±rken)
            setTimeout(() => {
                playHappySound();
            }, 100);

            // Puanlama ekranÄ± aÃ§Ä±ldÄ±ÄŸÄ±nda sesli duyuru (sÄ±ra numarasÄ± ile aynÄ± hÄ±zda)
            setTimeout(() => {
                speakTr('LÃ¼tfen aldÄ±ÄŸÄ±nÄ±z hizmeti deÄŸerlendirin.'); // Default hÄ±z: 1.02 (sÄ±ra numarasÄ± ile aynÄ±)
            }, 900);

            // Anket gÃ¶sterilince sayfayÄ± yumuÅŸakÃ§a kaydÄ±r
            setTimeout(() => {
                document.getElementById('survey-container').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 300);

            console.log('ğŸ“‹ Memnuniyet anketi gÃ¶sterildi');
        }

        function selectRating(rating) {
            selectedRating = rating;

            // TÃ¼m seÃ§imleri temizle
            document.querySelectorAll('.face-option').forEach(option => {
                option.classList.remove('selected');
            });

            // SeÃ§ilen yÃ¼zÃ¼ vurgula
            document.querySelector(`.face-option[data-rating="${rating}"]`).classList.add('selected');

            // GÃ¶nder butonunu aktif et
            document.getElementById('survey-submit-btn').disabled = false;

            console.log(`â­ Puan seÃ§ildi: ${rating}/5`);
        }

        async function submitSurvey() {
            if (selectedRating === 0) {
                alert('LÃ¼tfen bir puan seÃ§in');
                return;
            }

            const submitBtn = document.getElementById('survey-submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'GÃ¶nderiliyor...';

            try {
                const comment = document.getElementById('survey-comment').value.trim();

                // Hizmet sÃ¼resi hesapla (ÅŸu anki zaman - oluÅŸturulma zamanÄ±)
                const hizmetSuresiDk = localStorage.getItem(`bt_hizmet_suresi_dk`) || null;

                // Verileri hazÄ±rla
                const servis_id = ticketSpecs.servis_id || localStorage.getItem('bt_servis_id') || null;
                const firma_id = ticketSpecs.firma_id || localStorage.getItem('bt_firma_id') || 1;
                
                console.log(' Anket verileri:', {
                    sira_id, kuyruk_id, servis_id, firma_id
                });

                // Supabase'e kaydet
                const { data, error } = await _supabase
                    .schema('siramatik')
                    .from('memnuniyet_anketleri')
                    .insert([{
                        sira_id: parseInt(sira_id),
                        kuyruk_id: parseInt(kuyruk_id),
                        servis_id: servis_id ? parseInt(servis_id) : null,
                        firma_id: parseInt(firma_id),
                        cagiran_kullanici_id: null,
                        puan: selectedRating,
                        yorum: comment || null,
                        hizmet_suresi_dk: hizmetSuresiDk ? parseInt(hizmetSuresiDk) : null
                    }]);

                if (error) {
                    console.error('Anket kayÄ±t hatasÄ±:', error);
                    alert('Anket gÃ¶nderilemedi. LÃ¼tfen tekrar deneyin.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'GÃ¶nder';
                    return;
                }

                console.log('[OK] Anket gÃ¶nderildi:', data);

                // localStorage'a kaydet (tekrar gÃ¶sterme)
                localStorage.setItem(`survey_${sira_id}`, 'submitted');

                // Form'u gizle, teÅŸekkÃ¼r mesajÄ±nÄ± gÃ¶ster
                document.querySelectorAll('.survey-card > *:not(#survey-thanks)').forEach(el => {
                    el.style.display = 'none';
                });
                document.getElementById('survey-thanks').style.display = 'block';

                // Ufak teÅŸekkÃ¼r sesi Ã§al (kÄ±sa gecikme ile)
                setTimeout(() => {
                    playThankYouSound();
                }, 200);

                // TeÅŸekkÃ¼r ekranÄ±nda kalsÄ±n - bilete dÃ¶nmesin (iÅŸ bitti)

            } catch (e) {
                console.error('Anket gÃ¶nderme hatasÄ±:', e);
                alert('Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'GÃ¶nder';
            }
        }
    </script>
</body>

</html>