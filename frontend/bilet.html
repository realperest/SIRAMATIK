<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title id="page-title">Ä°rmet Hospital - SÄ±ra Takip</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ä°rmet SÄ±ra">
    <meta name="screen-orientation" content="portrait">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ«</text></svg>">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 15px 20px;
            overscroll-behavior-y: contain;
            /* Pull-to-refresh engelleme */
        }

        .ticket {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .ticket::before,
        .ticket::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            background: #f0f2f5;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }

        .ticket::before {
            left: -20px;
        }

        .ticket::after {
            right: -20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .content {
            padding: 40px 30px;
            text-align: center;
            border-top: 2px dashed #eee;
        }

        .number {
            font-size: 84px;
            font-weight: 900;
            color: #764ba2;
            margin: 20px 0;
            letter-spacing: -2px;
        }

        .label {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            font-size: 14px;
            color: #95a5a6;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.5s ease;
        }

        .calling-active-body {
            animation: party-alert 0.8s infinite;
        }

        @keyframes party-alert {
            0% {
                background-color: #ff0000;
            }

            /* KÄ±rmÄ±zÄ± */
            25% {
                background-color: #ffeb3b;
            }

            /* SarÄ± */
            50% {
                background-color: #2196f3;
            }

            /* Mavi */
            75% {
                background-color: #4caf50;
            }

            /* YeÅŸil */
            100% {
                background-color: #ff0000;
            }
        }

        /* Ã‡arpÄ±cÄ± etki iÃ§in bilet kartÄ±na gÃ¶lge ekle */
        .calling-active-body .ticket {
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.6);
            border: 4px solid white;
        }

        .calling-status {
            background: #22c55e !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        /* Aktivasyon Overlay */
        #activation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .activation-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            cursor: pointer;
            margin-top: 20px;
        }

        /* BaÄŸlantÄ± Durumu Badge */
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .connection-status.online {
            background: #22c55e;
            color: white;
        }

        .connection-status.offline {
            background: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }

        .connection-status.connecting {
            background: #f59e0b;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        /* SayÄ± Azalma Animasyonu */
        @keyframes number-decrease {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); color: #22c55e; }
        }

        .number.animate-decrease {
            animation: number-decrease 0.6s ease;
        }

        /* Tahmini Bekleme SÃ¼resi */
        .estimated-time {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(118, 75, 162, 0.1);
            color: #764ba2;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 15px;
        }

        /* Gizli element (HTML tekrarÄ± dÃ¼zeltmesi iÃ§in) */
        .hidden { display: none; }

        /* Ekran YÃ¶nlendirme Kilidi - Sadece Portre Mod */
        @media screen and (orientation: landscape) {
            body::before {
                content: 'ğŸ”„ LÃ¼tfen telefonunuzu dikey konuma getirin';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 99999;
                font-size: 18px;
                text-align: center;
                padding: 20px;
            }
            
            body > *:not(::before) {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- BaÄŸlantÄ± Durumu -->
    <div id="connection-status" class="connection-status connecting">
        <span class="status-dot"></span>
        <span id="connection-text">BaÄŸlanÄ±yor...</span>
    </div>

    <!-- Aktivasyon KatmanÄ± -->
    <div id="activation-overlay">
        <div>
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸ””</div>
            <h2 style="margin-bottom: 10px;">Sesli Bildirimler</h2>
            <p style="opacity: 0.8; margin-bottom: 20px;">SÄ±ranÄ±z geldiÄŸinde sizi sesli ve gÃ¶rÃ¼ntÃ¼lÃ¼ <br> uyarabilmemiz
                iÃ§in onay veriniz.</p>
            <button class="activation-btn" onclick="startNotifications()">BÄ°LDÄ°RÄ°MLERÄ° AÃ‡</button>
        </div>
    </div>
    <div class="ticket">
        <div class="header">
            <h2 id="hospital-name">Ä°RMET HOSPITAL</h2>
            <div style="font-size: 14px; opacity: 0.8;">SÄ±ra Takip Sistemi</div>
        </div>
        <div class="content">
            <div class="label">SÄ±ra NumaranÄ±z</div>
            <div class="number" id="ticket-number">---</div>
            <div class="label" id="queue-name">BÃ¶lÃ¼m YÃ¼kleniyor...</div>
            <div class="status" id="wait-info">GiriÅŸ YapÄ±lÄ±yor...</div>
            <div class="estimated-time" id="estimated-time" style="display: none;">
                â± Tahmini <span id="est-minutes">--</span> dakika
            </div>
        </div>
        <div class="footer">
            <div id="current-time">--:--:--</div>
            <div style="margin-top: 5px;">LÃ¼tfen ekranlardan numaranÄ±zÄ± takip ediniz.</div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /*
         * ============================================================
         * SIRAMATÄ°K BÄ°LET TAKÄ°P SÄ°STEMÄ°
         * ============================================================
         * 
         * GÃœNCELLEME MANTIÄI:
         * -------------------
         * 1. WebSocket (GerÃ§ek ZamanlÄ± - 0ms gecikme)
         *    - Backend sunucuya deploy edildiÄŸinde otomatik aktif
         *    - AnÄ±nda bildirim alÄ±rsÄ±n
         * 
         * 2. Polling (Yedek Sistem - 5 saniye)
         *    - WebSocket yoksa veya koptuÄŸunda devreye girer
         *    - Her 5 saniyede Supabase'den veri Ã§eker
         *    - Her durumda Ã§alÄ±ÅŸÄ±r garantisi
         * 
         * BACKEND SUNUCUYA KOYDUÄUNDA:
         * ----------------------------
         * SatÄ±r ~387'de PRODUCTION_WS_URL'e sunucu URL'ini yaz:
         * const PRODUCTION_WS_URL = 'wss://api.yourdomain.com/ws';
         * 
         * Sistem otomatik ÅŸuna geÃ§er:
         * - WebSocket: Aktif (gerÃ§ek zamanlÄ±)
         * - Polling: Pasif bekleme (sadece WebSocket koparsa devreye girer)
         * 
         * ============================================================
         */

        // Verileri sakla/getir (Yenileme korumasÄ±)
        function getTicketData() {
            const params = new URLSearchParams(window.location.search);
            const data = {
                numara: params.get('numara') || localStorage.getItem('bt_numara') || '---',
                kuyruk_ad: params.get('kuyruk') || localStorage.getItem('bt_kuyruk_ad') || 'SÄ±ramatik',
                firma_ad: params.get('firma') || localStorage.getItem('bt_firma_ad') || 'Ä°RMET HOSPITAL',
                kuyruk_id: params.get('kuyruk_id') || localStorage.getItem('bt_kuyruk_id'),
                sira_id: params.get('sira_id') || localStorage.getItem('bt_sira_id'),
                bekleyen: params.get('bekleyen') || localStorage.getItem('bt_bekleyen') || '0'
            };

            // EÄŸer URL'den geldiyse hafÄ±zaya kaydet
            if (params.get('numara')) {
                localStorage.setItem('bt_numara', data.numara);
                localStorage.setItem('bt_kuyruk_ad', data.kuyruk_ad);
                localStorage.setItem('bt_firma_ad', data.firma_ad);
                localStorage.setItem('bt_kuyruk_id', data.kuyruk_id);
                localStorage.setItem('bt_sira_id', data.sira_id);
                localStorage.setItem('bt_bekleyen', data.bekleyen);
            }
            return data;
        }

        const ticketSpecs = getTicketData();

        // URL Maskeleme (Veriler saklandÄ±ktan sonra)
        if (window.history.replaceState && window.location.search) {
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
        }

        const numara = ticketSpecs.numara;
        const kuyruk_ad = ticketSpecs.kuyruk_ad;
        const firma_ad = ticketSpecs.firma_ad;
        const kuyruk_id = ticketSpecs.kuyruk_id;
        const sira_id = ticketSpecs.sira_id;

        let sessionDurum = 'waiting';
        let notificationPlayed = false;
        let lastCount = -1;
        let isAudioUnlocked = false;
        let isFirstLoad = true;
        let ws = null; // WebSocket baÄŸlantÄ±sÄ±
        let pollingInterval = null; // Polling interval referansÄ±
        let isPageVisible = true; // Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k durumu
        let avgProcessTime = 5; // Dinamik olarak gÃ¼ncellenecek ortalama sÃ¼re (dakika)

        // Supabase BaÄŸlantÄ±sÄ±
        const supabaseUrl = 'https://wyursjdrnnjabpfeucyi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5dXJzamRybm5qYWJwZmV1Y3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NzcwOTEsImV4cCI6MjA4NTQ1MzA5MX0.uacZI2vB1pfDyk_UO0lvJBgftJl_R04YX9Bv9kWOLd4';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // ===== UPGRADE: HTML5 Audio (ESKÄ°) + GeliÅŸmiÅŸ Hata YÃ¶netimi (YENÄ°) =====
        const tickSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        const alertSound = tickSound; // BitiÅŸ alarmÄ± da aynÄ± ses

        // Ses yÃ¼kleme kontrolÃ¼
        tickSound.addEventListener('loadeddata', () => {
            console.log('âœ… Ses dosyasÄ± yÃ¼klendi');
        });
        tickSound.addEventListener('error', (e) => {
            console.warn('âš ï¸ Ses dosyasÄ± yÃ¼klenemedi:', e);
        });

        async function startNotifications() {
            // iOS iÃ§in ses kilidi aÃ§ma yÃ¶ntemi
            alertSound.volume = 0.5;
            tickSound.volume = 0.5;

            alertSound.play().then(() => { alertSound.pause(); }).catch(() => { });
            tickSound.play().then(() => { tickSound.pause(); }).catch(() => { });

            isAudioUnlocked = true;
            document.getElementById('activation-overlay').style.display = 'none';
            
            // Test titreÅŸimi
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            
            // Test sesi Ã§al
            setTimeout(() => {
                tickSound.play().catch(e => console.log('Test sesi hatasÄ±:', e));
                console.log('ğŸ”Š Test sesi Ã§alÄ±ndÄ±');
            }, 300);
            
            // Ortalama bekleme sÃ¼resini hesapla
            await fetchAverageWaitTime();
            
            // WebSocket baÄŸlantÄ±sÄ±nÄ± baÅŸlat
            initWebSocket();
            
            // Ä°lk durumu gÃ¼ncelle
            updateStatus();
            
            // Polling baÅŸlat (fallback)
            startPolling();
        }

        // ===== WEBSOCKET YÃ–NETÄ°MÄ° =====
        function initWebSocket() {
            // ====== BACKEND SUNUCU AYARI ======
            // Backend'i sunucuya koyduÄŸunda buraya URL'ini yaz:
            // Ã–rnek: 'wss://api.yourdomain.com/ws' veya 'wss://siramatik.herokuapp.com/ws'
            const PRODUCTION_WS_URL = '';
            // ==================================
            
            let wsUrl;
            
            // Production URL varsa kullan
            if (PRODUCTION_WS_URL) {
                wsUrl = PRODUCTION_WS_URL;
                console.log('ğŸ”— Production WebSocket baÄŸlanÄ±yor:', wsUrl);
            } 
            // GitHub Pages'te ve production URL yoksa polling kullan
            else if (window.location.hostname.includes('github.io')) {
                console.log('â„¹ï¸ Backend sunucu bulunamadÄ±, Polling modu aktif (5 saniye)');
                updateConnectionStatus('online'); // Polling Ã§alÄ±ÅŸÄ±yor, yeÅŸil gÃ¶ster
                return;
            } 
            // Local development
            else {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname || 'localhost';
                wsUrl = `${protocol}//${host}:8000/ws`;
                console.log('ğŸ”— Local WebSocket baÄŸlanÄ±yor:', wsUrl);
            }

            console.log('ğŸ”— WebSocket baÄŸlanÄ±yor:', wsUrl);
            updateConnectionStatus('connecting');

            function connect() {
                try {
                    ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        console.log('âœ… WebSocket baÄŸlandÄ±! GerÃ§ek zamanlÄ± mod aktif.');
                        updateConnectionStatus('online');
                        // WebSocket baÅŸarÄ±lÄ±, polling'i durdur
                        if (pollingInterval) {
                            console.log('ğŸ”„ Polling durduruldu (WebSocket aktif)');
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                        }
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('ğŸ“© WebSocket mesaj:', data);
                            handleWebSocketMessage(data);
                        } catch (e) {
                            console.error('WebSocket veri hatasÄ±:', e);
                        }
                    };

                    ws.onclose = () => {
                        console.warn('âš ï¸ WebSocket koptu. Polling fallback aktif.');
                        updateConnectionStatus('online'); // Polling Ã§alÄ±ÅŸtÄ±ÄŸÄ± iÃ§in online
                        ws = null;
                        
                        // Polling'i tekrar baÅŸlat (eÄŸer durdurulmuÅŸsa)
                        if (!pollingInterval) {
                            console.log('ğŸ”„ Polling yeniden baÅŸlatÄ±lÄ±yor...');
                            startPolling();
                        }
                        
                        // Yeniden baÄŸlanmayÄ± dene (3 saniye sonra)
                        setTimeout(connect, 3000);
                    };

                    ws.onerror = (err) => {
                        console.error('âŒ WebSocket baÄŸlantÄ± hatasÄ± (Polling devrede)');
                        // Hata durumunda da online gÃ¶ster (polling Ã§alÄ±ÅŸÄ±yor)
                        updateConnectionStatus('online');
                    };
                } catch (err) {
                    console.error('WebSocket oluÅŸturma hatasÄ±:', err);
                    updateConnectionStatus('online'); // Polling devrede
                }
            }

            connect();
        }

        // WebSocket mesajlarÄ±nÄ± iÅŸle
        function handleWebSocketMessage(data) {
            // EÄŸer bu biletimizle ilgili bir gÃ¼ncelleme ise
            if (data.sira_id && data.sira_id == sira_id) {
                console.log('ğŸ¯ Biletimiz iÃ§in gÃ¼ncelleme:', data);
                updateStatus(); // Durumu gÃ¼ncelle
            }
            // Veya kuyruÄŸumuzda bir deÄŸiÅŸiklik olduysa
            else if (data.kuyruk_id && data.kuyruk_id == kuyruk_id) {
                console.log('ğŸ“Š Kuyruk gÃ¼ncellendi:', data);
                updateStatus(); // Durumu gÃ¼ncelle
            }
        }

        // BaÄŸlantÄ± durumu gÃ¶stergesini gÃ¼ncelle
        function updateConnectionStatus(status) {
            const badge = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            badge.className = `connection-status ${status}`;
            
            if (status === 'online') {
                text.textContent = 'CanlÄ±';
            } else if (status === 'connecting') {
                text.textContent = 'BaÄŸlanÄ±yor...';
            } else {
                text.textContent = 'Ã‡evrimdÄ±ÅŸÄ±';
            }
        }

        // Polling MekanizmasÄ± (Fallback & Yedek)
        function startPolling() {
            if (pollingInterval) {
                console.log('â„¹ï¸ Polling zaten aktif');
                return;
            }
            
            console.log('ğŸ”„ Polling baÅŸlatÄ±lÄ±yor (5 saniye aralÄ±k)');
            pollingInterval = setInterval(() => {
                // WebSocket baÄŸlÄ±ysa polling'i geÃ§ici durdur (kaynak tasarrufu)
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // WebSocket Ã§alÄ±ÅŸÄ±rken polling sessizce bekler
                    return;
                }
                // WebSocket yoksa veya kopuksa polling gÃ¼ncelleme yapar
                updateStatus();
            }, 5000);
        }

        // Page Visibility API (Arka plan kontrolÃ¼)
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            
            if (isPageVisible) {
                console.log('ğŸ‘€ Sayfa gÃ¶rÃ¼nÃ¼r hale geldi');
                updateStatus(); // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda hemen gÃ¼ncelle
                updatePageTitle(); // BaÅŸlÄ±ÄŸÄ± sÄ±fÄ±rla
            } else {
                console.log('ğŸ™ˆ Sayfa arka planda');
            }
        });

        // Ä°lk verileri URL'den bas
        document.getElementById('ticket-number').textContent = numara;
        document.getElementById('queue-name').textContent = kuyruk_ad;
        document.getElementById('hospital-name').textContent = firma_ad;
        document.getElementById('wait-info').textContent = `Ã–nÃ¼nÃ¼zde ${ticketSpecs.bekleyen} kiÅŸi var`;

        // Ä°lk bekleyen sayÄ±sÄ±nÄ± kaydet (URL'den)
        const bekleyen_url = ticketSpecs.bekleyen;
        if (bekleyen_url && bekleyen_url !== '0') {
            lastCount = parseInt(bekleyen_url);
            isFirstLoad = false; // Ä°lk veri URL'den geldi
            console.log(`ğŸ“Š Ä°lk bekleyen sayÄ±sÄ± (URL): ${lastCount}`);
        }

        // Kuyruk iÃ§in ortalama bekleme sÃ¼resini hesapla
        async function fetchAverageWaitTime() {
            if (!kuyruk_id) return;
            
            try {
                const kid = parseInt(kuyruk_id);
                
                // Son 7 gÃ¼nÃ¼n ortalamasÄ±nÄ± al (siramatik ÅŸemasÄ±ndaki fonksiyon)
                const { data, error } = await _supabase
                    .schema('siramatik')
                    .rpc('ortalama_bekleme_suresi', { 
                        p_kuyruk_id: kid,
                        p_gun_sayisi: 7 
                    });

                if (error) {
                    console.warn('Ortalama sÃ¼re RPC hatasÄ±:', error);
                    // Fallback: Manuel hesapla
                    const avgToday = await calculateTodayAverage(kid);
                    avgProcessTime = avgToday > 0 ? avgToday : 5;
                    console.log(`ğŸ“Š Manuel hesaplama: ${avgProcessTime} dk (fallback: 5 dk)`);
                } else if (data !== null && data > 0) {
                    avgProcessTime = data;
                    console.log(`ğŸ“Š Kuyruk ${kuyruk_id} iÃ§in ortalama bekleme (7 gÃ¼n): ${avgProcessTime} dk`);
                } else {
                    // Veri yoksa bugÃ¼nÃ¼n ortalamasÄ±nÄ± dene
                    const avgToday = await calculateTodayAverage(kid);
                    avgProcessTime = avgToday > 0 ? avgToday : 5;
                    console.log(`ğŸ“Š BugÃ¼nÃ¼n ortalamasÄ±: ${avgProcessTime} dk (fallback: 5 dk)`);
                }
            } catch (e) {
                console.error('Ortalama sÃ¼re hatasÄ±:', e);
                avgProcessTime = 5; // Fallback
            }
        }

        // BugÃ¼nÃ¼n ortalamasÄ±nÄ± manuel hesapla (fallback)
        async function calculateTodayAverage(kid) {
            try {
                // TÃ¼rkiye saatiyle bugÃ¼nÃ¼n baÅŸlangÄ±cÄ±
                const simdi = new Date();
                const trBaslangic = new Date(simdi.getTime() + (3 * 60 * 60 * 1000));
                trBaslangic.setUTCHours(0, 0, 0, 0);
                const trBaslangicUtc = new Date(trBaslangic.getTime() - (3 * 60 * 60 * 1000)).toISOString();

                const { data, error } = await _supabase
                    .schema('siramatik')
                    .from('siralar')
                    .select('olusturulma, cagirilma')
                    .eq('kuyruk_id', kid)
                    .in('durum', ['calling', 'completed'])
                    .gte('olusturulma', trBaslangicUtc)
                    .not('cagirilma', 'is', null);

                if (error || !data || data.length === 0) {
                    return 0;
                }

                // Ortalama bekleme sÃ¼resini hesapla (dakika)
                const totalMinutes = data.reduce((sum, row) => {
                    const created = new Date(row.olusturulma);
                    const called = new Date(row.cagirilma);
                    const diffMinutes = (called - created) / 60000;
                    return sum + diffMinutes;
                }, 0);

                const avgMinutes = Math.round(totalMinutes / data.length);
                return avgMinutes > 0 ? avgMinutes : 0;
            } catch (e) {
                console.error('BugÃ¼n ortalama hesaplama hatasÄ±:', e);
                return 0;
            }
        }

        async function updateStatus() {
            const statusEl = document.getElementById('wait-info');
            const numEl = document.getElementById('ticket-number');

            if (!kuyruk_id || !sira_id) {
                console.warn("CanlÄ± takip iÃ§in sira_id veya kuyruk_id eksik.");
                return;
            }

            try {
                const kid = parseInt(kuyruk_id);
                const sid = parseInt(sira_id);
                
                // TÃ¼rkiye saatiyle (UTC+3) bugÃ¼nÃ¼n baÅŸlangÄ±cÄ±nÄ± bulalÄ±m
                const simdi = new Date();
                const trBaslangic = new Date(simdi.getTime() + (3 * 60 * 60 * 1000));
                trBaslangic.setUTCHours(0, 0, 0, 0);
                const trBaslangicUtc = new Date(trBaslangic.getTime() - (3 * 60 * 60 * 1000)).toISOString();

                // 1. Kendi bilet bilgilerimizi Ã§ekelim
                const myTicket = await _supabase
                    .schema('siramatik')
                    .from('siralar')
                    .select('durum, oncelik, olusturulma')
                    .eq('id', sid)
                    .single();

                if (myTicket.error) throw myTicket.error;
                const me = myTicket.data;

                // Durum kontrolÃ¼
                if (me.durum === 'calling') {
                    statusEl.textContent = "SIRA SÄ°ZDE!";
                    statusEl.classList.add('calling-status');
                    document.body.classList.add('calling-active-body');
                    numEl.style.color = "#22c55e";

                    if (!notificationPlayed) {
                        notificationPlayed = true;

                        // 3x alarm Ã§alma (1 saniye aralÄ±kla)
                        let playCount = 0;
                        alertSound.volume = 1.0;

                        const playAlert = () => {
                            if (playCount < 3) {
                                console.log(`ğŸ“¢ SIRA SÄ°ZDE! Alarm ${playCount + 1}/3`);
                                
                                // Sesi sÄ±fÄ±rdan baÅŸlat
                                alertSound.pause();
                                alertSound.currentTime = 0;
                                
                                // Sesi Ã§al
                                alertSound.play().catch(e => {
                                    console.error("Alarm Ã§alma hatasÄ±:", e);
                                });

                                playCount++;
                                
                                // 1 saniye sonra tekrar (son ses deÄŸilse)
                                if (playCount < 3) {
                                    setTimeout(playAlert, 1000);
                                }
                            }
                        };
                        
                        // Ä°lk sesi hemen Ã§al
                        playAlert();

                        // GÃ¼Ã§lÃ¼ titreÅŸim (3 kez tekrarlÄ±)
                        if (navigator.vibrate) {
                            navigator.vibrate([500, 200, 500, 200, 500, 200, 500, 200, 500, 200, 1000]);
                        }
                    }
                    return;
                } else if (me.durum === 'completed') {
                    statusEl.textContent = "Ä°ÅLEM TAMAMLANDI";
                    statusEl.classList.remove('calling-status');
                    document.body.classList.remove('calling-active-body');
                    statusEl.style.background = "#94a3b8";
                    notificationPlayed = false;
                    return;
                }

                // Ã–nÃ¼nÃ¼zdekileri saymak iÃ§in 2 ayrÄ± sorgu
                const highPriority = await _supabase
                    .schema('siramatik')
                    .from('siralar')
                    .select('*', { count: 'exact', head: true })
                    .eq('kuyruk_id', kid)
                    .eq('durum', 'waiting')
                    .gte('olusturulma', trBaslangicUtc)
                    .gt('oncelik', me.oncelik);

                const samePriorityBefore = await _supabase
                    .schema('siramatik')
                    .from('siralar')
                    .select('*', { count: 'exact', head: true })
                    .eq('kuyruk_id', kid)
                    .eq('durum', 'waiting')
                    .gte('olusturulma', trBaslangicUtc)
                    .eq('oncelik', me.oncelik)
                    .lt('olusturulma', me.olusturulma);

                if (highPriority.error) throw highPriority.error;
                if (samePriorityBefore.error) throw samePriorityBefore.error;

                const count = (highPriority.count || 0) + (samePriorityBefore.count || 0);
                console.log(`ğŸ” SayaÃ§: YÃ¼ksek:${highPriority.count}, AynÄ±:${samePriorityBefore.count}, Toplam:${count}`);

                // GeliÅŸmiÅŸ sÄ±ra azalma kontrolÃ¼
                if (isFirstLoad) {
                    // Ä°lk yÃ¼kleme: Sadece kaydet
                    lastCount = count;
                    isFirstLoad = false;
                    console.log(`ğŸ“Š Ä°lk bekleyen sayÄ±sÄ± (API): ${count}`);
                } else if (lastCount !== -1 && count < lastCount && count >= 0) {
                    // Bekleyen azaldÄ± - ses + titreÅŸim + animasyon
                    console.log(`ğŸ”” Bekleyen azaldÄ±: ${lastCount} â†’ ${count}`);
                    
                    // SayÄ± animasyonu
                    numEl.classList.add('animate-decrease');
                    setTimeout(() => numEl.classList.remove('animate-decrease'), 600);
                    
                    // Ses + TitreÅŸim
                    if (isAudioUnlocked) {
                        tickSound.pause();
                        tickSound.currentTime = 0;
                        tickSound.play().catch(e => console.log("Tick sesi Ã§alÄ±namadÄ±:", e));
                    }
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    // Sayfa arka plandaysa baÅŸlÄ±ÄŸÄ± gÃ¼ncelle
                    if (!isPageVisible) {
                        updatePageTitle(`ğŸ”” ${count} kiÅŸi kaldÄ±!`);
                    }
                    
                    lastCount = count;
                } else {
                    lastCount = count;
                }

                // Durum mesajÄ± gÃ¼ncelle
                document.body.classList.remove('calling-active-body');
                statusEl.classList.remove('calling-status');
                numEl.style.color = "#764ba2";

                if (count === 0) {
                    statusEl.textContent = "SÄ±radaki sizsiniz!";
                    statusEl.style.color = "#764ba2";
                    statusEl.style.fontWeight = "bold";
                    updateEstimatedTime(0);
                } else {
                    statusEl.textContent = `Ã–nÃ¼nÃ¼zde ${count} kiÅŸi var`;
                    statusEl.style.color = "#667eea";
                    updateEstimatedTime(count);
                }

                // Sayfa baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
                if (isPageVisible) {
                    updatePageTitle();
                }

                if (me.durum === 'waiting') notificationPlayed = false;

            } catch (e) {
                console.error("Takip HatasÄ±:", e);
            }
        }

        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleTimeString('tr-TR');
        }

        // Tahmini bekleme sÃ¼resini gÃ¼ncelle
        function updateEstimatedTime(count) {
            const estimatedEl = document.getElementById('estimated-time');
            const minutesEl = document.getElementById('est-minutes');
            
            if (count === 0) {
                estimatedEl.style.display = 'none';
            } else {
                // Dinamik ortalama sÃ¼re ile hesapla
                const minutes = Math.ceil(count * avgProcessTime);
                minutesEl.textContent = minutes;
                estimatedEl.style.display = 'inline-block';
                
                console.log(`â± Tahmini bekleme: ${count} kiÅŸi Ã— ${avgProcessTime} dk = ${minutes} dk`);
            }
        }

        // Sayfa baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle (Arka plan bildirimleri iÃ§in)
        function updatePageTitle(customTitle = null) {
            const titleEl = document.getElementById('page-title');
            const faviconEl = document.getElementById('favicon');
            
            if (customTitle) {
                titleEl.textContent = customTitle;
                // Favicon'u bildirim ikonu yap
                faviconEl.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ””</text></svg>";
            } else {
                // Normal baÅŸlÄ±k
                titleEl.textContent = `${firma_ad} - SÄ±ra Takip`;
                faviconEl.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ«</text></svg>";
            }
        }

        // Sayfa yÃ¼klendiÄŸinde
        setInterval(updateTime, 1000);
        updateTime();
        
        // Ä°lk baÅŸlÄ±k ayarÄ±
        updatePageTitle();

        // ===== EKRAN YÃ–NÃœ KÄ°LÄ°DÄ° =====
        // Screen Orientation API ile portre modunu kilitle
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('portrait').then(() => {
                console.log('ğŸ”’ Ekran portre modunda kilitlendi');
            }).catch(err => {
                console.log('â„¹ï¸ Ekran kilidi desteklenmiyor (CSS fallback aktif)');
            });
        }

        // Oryantasyon deÄŸiÅŸimini dinle ve uyar
        window.addEventListener('orientationchange', () => {
            if (window.orientation === 90 || window.orientation === -90) {
                console.warn('âš ï¸ Telefon yatay konumda - LÃ¼tfen dikey konuma getirin');
            }
        });
    </script>
</body>

</html>