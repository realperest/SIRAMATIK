<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Ekranƒ± - Sƒ±ramatik</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%236366f1' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'>S</text></svg>">
    <link rel="stylesheet" href="static/style.css">
    <style>
        body {
            margin: 0;
            background: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px 400px 30px 40px;
            text-align: center;
            position: relative;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 56px;
            margin: 0;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .header .subtitle {
            font-size: 22px;
            opacity: 0.7;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        .cagri-listesi {
            padding: 20px 40px;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .spotlight-area {
            min-height: 380px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .spotlight-item {
            background: linear-gradient(135deg, #ff0055 0%, #ff00a2 100%);
            width: 98%;
            padding: 40px;
            border-radius: 40px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 5px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .spotlight-item::after {
            content: "SIRA Sƒ∞ZDE!";
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 26px;
            font-weight: bold;
            letter-spacing: 5px;
            color: rgba(255, 255, 255, 0.8);
            animation: blink 1s infinite;
        }

        .spotlight-numara {
            font-size: 204px;
            font-weight: 900;
            text-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            color: white;
        }

        .spotlight-detay {
            text-align: center;
            color: white;
        }

        .spotlight-servis {
            font-size: 52px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .spotlight-oda {
            font-size: 62px;
            font-weight: bold;
            color: #22c55e;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .spotlight-oda .pin-icon,
        .cagri-oda .pin-icon {
            display: inline-block;
            vertical-align: middle;
            width: 0.85em;
            height: 0.85em;
            fill: #22c55e;
        }

        .cagri-oda {
            color: #22c55e;
            font-weight: bold;
        }

        .cagri-item {
            background: rgba(255, 0, 85, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 85, 0.2);
            padding: 15px 40px;
            margin: 5px 0;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top center;
            width: 100%;
            box-sizing: border-box;
        }

        .cagri-numara {
            font-weight: bold;
            color: #fff;
            font-size: 40px;
        }

        .cagri-detay {
            text-align: right;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .cagri-departman {
            font-size: 20px;
            opacity: 0.8;
        }

        .cagri-oda {
            font-size: 28px;
            font-weight: bold;
            color: #22c55e;
        }

        .zaman {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 100px;
            font-weight: 900;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 10px 40px;
            border-radius: 20px;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            font-size: 28px;
            color: #7f8c8d;
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            }

            15% {
                transform: scale(1.05);
                box-shadow: 0 0 80px rgba(255, 0, 85, 0.8);
            }

            30% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            }

            45% {
                transform: scale(1.05);
                box-shadow: 0 0 80px rgba(255, 0, 85, 0.8);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .settings-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(12px);
            padding: 24px;
            box-sizing: border-box;
        }

        .settings-panel {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            padding: 36px 40px;
            border-radius: 24px;
            max-width: 560px;
            width: 100%;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.35), 0 0 0 1px rgba(255,255,255,0.1);
        }

        .settings-panel h2 {
            margin: 0 0 8px 0;
            color: #0f172a;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .settings-desc {
            color: #64748b;
            font-size: 15px;
            line-height: 1.5;
            text-align: left;
            margin: 0 0 28px 0;
        }

        .settings-section {
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .settings-section:last-of-type {
            border-bottom: none;
        }

        .settings-section h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .settings-panel label:not(.toggle-wrap) {
            display: block;
            margin: 14px 0 6px;
            font-weight: 600;
            color: #334155;
            text-align: left;
            font-size: 14px;
        }

        .settings-panel select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background: #fff;
            min-height: 120px;
        }

        .settings-panel select:focus {
            border-color: #667eea;
            outline: none;
        }

        .settings-hint {
            color: #94a3b8;
            font-size: 12px;
            display: block;
            text-align: left;
            margin-top: 6px;
        }

        .settings-section-ses {
            background: #f1f5f9;
            margin-left: -40px;
            margin-right: -40px;
            padding: 20px 40px 24px;
            border-radius: 16px;
            border: none;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            color: #334155;
            font-weight: 500;
        }

        .toggle-wrap {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .toggle-wrap input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: relative;
            display: block;
            width: 48px;
            height: 26px;
            background: #cbd5e1;
            border-radius: 26px;
            transition: background 0.25s, box-shadow 0.25s;
        }

        .toggle-wrap input:checked + .toggle-slider {
            background: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.25s;
        }

        .toggle-wrap {
            position: relative;
        }

        .toggle-wrap input:checked + .toggle-slider::after {
            left: 24px;
        }

        .settings-actions {
            margin-top: 28px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .settings-panel .btn-save,
        .settings-panel .btn-cancel,
        .settings-panel .btn-reset {
            margin: 0;
            padding: 12px 22px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-save {
            background: #22c55e;
            color: white;
        }

        .btn-save:hover {
            background: #16a34a;
        }

        .btn-cancel {
            background: #64748b;
            color: white;
        }

        .btn-cancel:hover {
            background: #475569;
        }

        .btn-reset {
            background: #f59e0b;
            color: white;
        }

        .btn-reset:hover {
            background: #d97706;
        }

        .btn-reset-gray {
            background: #94a3b8;
        }

        .btn-reset-gray:hover {
            background: #64748b;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 id="firma-adi">üè• Y√ºkleniyor...</h1>
        <div class="subtitle" id="firma-baslik">Sƒ±ra √áaƒürƒ± Sistemi</div>
        <div class="zaman" id="saat"></div>
    </div>

    <div id="spotlight-container" class="spotlight-area"></div>
    <div class="cagri-listesi" id="history-container"></div>

    <button class="settings-button" onclick="openTVSettings()" title="Ekran Ayarlarƒ±">‚öôÔ∏è</button>

    <div class="settings-modal" id="tv-settings-modal">
        <div class="settings-panel">
            <h2>üì∫ Ekran Ayarlarƒ±</h2>
            <p class="settings-desc">Bu ekranda hangi b√∂l√ºm ve kuyruklara ait √ßaƒürƒ±larƒ±n g√∂sterileceƒüini ve ses se√ßeneklerini ayarlayƒ±n.</p>

            <section class="settings-section">
                <h3>üìã G√∂sterim</h3>
                <label for="servis-filter">B√∂l√ºmler (Servisler):</label>
                <select id="servis-filter" multiple size="5"></select>
                <small class="settings-hint">Ctrl/Cmd ile √ßoklu se√ßim yapabilirsiniz.</small>

                <label for="kuyruk-filter">Kuyruklar (Opsiyonel):</label>
                <select id="kuyruk-filter" multiple size="5"></select>
                <small class="settings-hint">Bo≈ü bƒ±rakƒ±lƒ±rsa se√ßili b√∂l√ºmlerin t√ºm kuyruklarƒ± listelenir.</small>
            </section>

            <section class="settings-section settings-section-ses">
                <h3>üîä Ses Ayarlarƒ±</h3>
                <div class="setting-row">
                    <span class="setting-label">Ses (ding-dong ve m√ºzik)</span>
                    <label class="toggle-wrap">
                        <input type="checkbox" id="setting-ses-acik" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Sesli duyuru (sƒ±ra numarasƒ± okunsun)</span>
                    <label class="toggle-wrap">
                        <input type="checkbox" id="setting-sesli-duyuru" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </section>

            <div class="settings-actions">
                <button class="btn-save" onclick="saveTVSettings()">üíæ Kaydet</button>
                <button class="btn-reset btn-reset-gray" onclick="clearTVSelections()">üóëÔ∏è Temizle</button>
                <button class="btn-reset" onclick="resetTVSettings()">üîÑ Sƒ±fƒ±rla</button>
                <button class="btn-cancel" onclick="closeTVSettings()">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <!-- ≈ûƒ∞FRE MODAL -->
    <div id="password-modal" class="settings-modal" style="display: none; z-index: 10002;">
        <div class="settings-panel" style="max-width: 400px; text-align: center;">
            <h2>üîí Yetkili Giri≈üi</h2>
            <p>Ekran ayarlarƒ±na eri≈ümek i√ßin l√ºtfen m√ºdahale ≈üifresini girin.</p>
            <input type="password" id="modal-password-input" placeholder="≈ûifre"
                onkeypress="if(event.key === 'Enter') verifyPassword()"
                style="width: 100%; padding: 15px; font-size: 18px; margin: 20px 0; border: 2px solid #ddd; border-radius: 10px; text-align: center;">

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-cancel" onclick="closePasswordModal()">ƒ∞ptal</button>
                <button class="btn-save" onclick="verifyPassword()">Giri≈ü Yap</button>
            </div>
        </div>
    </div>

    <!-- Initialization Overlay -->
    <div id="start-overlay" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10, 14, 23, 0.98); z-index: 999999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; text-align: center; font-family: 'Segoe UI', system-ui, sans-serif;
        backdrop-filter: blur(10px);
    ">
        <div style="font-size: 80px; margin-bottom: 30px; animation: bounce 2s infinite;">üì∫</div>
        <h1 style="font-size: 48px; margin: 0 0 20px 0; font-weight:800; letter-spacing:-1px;">TV Ekranƒ± Hazƒ±r</h1>
        <p style="font-size: 20px; color: #8892b0; margin-bottom: 50px; max-width: 600px; line-height: 1.6;">
            Tarayƒ±cƒ± politikalarƒ± gereƒüi sesin √ßalabilmesi i√ßin kullanƒ±cƒ± etkile≈üimi gerekmektedir.
        </p>
        <button onclick="baslatTV()" style="
            padding: 25px 80px; font-size: 24px; font-weight: 800;
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white; border: none; border-radius: 20px;
            cursor: pointer; box-shadow: 0 20px 40px rgba(0, 176, 155, 0.3);
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 2px;
            display: flex; align-items: center; gap: 15px;
        ">
            <span>BA≈ûLAT</span> üöÄ
        </button>
    </div>

    <script src="static/app.js"></script>
    <script>
        let FIRMA_ID = localStorage.getItem('global_firma_id') || 1;
        let audioContext = null;
        let isMuted = false;
        let lastCagriId = null;
        let seenIds = {};
        let tvSettings = { servisIds: [], kuyrukIds: [], sesliDuyuru: true, sesAcik: true };
        let isFirstLoad = true;
        let displayedCalls = [];
        let updateTimeout = null;

        function baslatTV() {
            unlockAudio();
            playDingDong();

            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log("Tam ekran reddedildi:", e));
            }

            const ov = document.getElementById('start-overlay');
            if (ov) {
                ov.style.transition = 'opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1), transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)';
                ov.style.opacity = '0';
                ov.style.transform = 'scale(1.1)';
                setTimeout(() => ov.style.display = 'none', 600);
            }
        }

        function unlockAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        window.addEventListener('click', unlockAudio, { once: false });
        window.addEventListener('keydown', unlockAudio, { once: false });

        function toggleMute() {
            unlockAudio();
            isMuted = !isMuted;
            const btn = document.getElementById('mute-toggle');
            if (btn) {
                btn.innerHTML = isMuted ? 'üîá' : 'üîä';
                btn.style.background = isMuted ? 'rgba(231, 76, 60, 0.5)' : 'rgba(0,0,0,0.5)';
            }
        }

        async function playDingDong() {
            if (isMuted || !audioContext) return;

            try {
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
            } catch (e) { console.error("Audio resume error", e); }

            const osc1 = audioContext.createOscillator();
            const gain1 = audioContext.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(660, audioContext.currentTime);
            gain1.gain.setValueAtTime(0.5, audioContext.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            osc1.connect(gain1);
            gain1.connect(audioContext.destination);
            osc1.start();
            osc1.stop(audioContext.currentTime + 0.8);

            setTimeout(() => {
                if (isMuted) return;
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(550, audioContext.currentTime);
                gain2.gain.setValueAtTime(0.5, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.start();
                osc2.stop(audioContext.currentTime + 1.2);
            }, 600);
        }

        // Sayƒ±yƒ± T√ºrk√ße s√∂yle (0-999): 71 ‚Üí "yetmi≈ü bir"
        function sayiToTurkce(n) {
            if (n === 0) return 'sƒ±fƒ±r';
            const birlik = ['', 'bir', 'iki', '√º√ß', 'd√∂rt', 'be≈ü', 'altƒ±', 'yedi', 'sekiz', 'dokuz'];
            const onluk = ['', 'on', 'yirmi', 'otuz', 'kƒ±rk', 'elli', 'altmƒ±≈ü', 'yetmi≈ü', 'seksen', 'doksan'];
            if (n < 10) return birlik[n];
            if (n < 100) return (onluk[Math.floor(n / 10)] + ' ' + birlik[n % 10]).trim();
            if (n < 1000) {
                const yuz = Math.floor(n / 100);
                const kalan = n % 100;
                const yuzStr = yuz === 1 ? 'y√ºz' : birlik[yuz] + ' y√ºz';
                return kalan === 0 ? yuzStr : yuzStr + ' ' + sayiToTurkce(kalan);
            }
            return String(n);
        }

        // K0071 ‚Üí "K sƒ±fƒ±r sƒ±fƒ±r yetmi≈ü bir" (soldaki her 0 i√ßin "sƒ±fƒ±r", sonra sayƒ± T√ºrk√ße)
        function numaraToSpeechText(numara) {
            if (!numara || typeof numara !== 'string') return numara;
            const m = numara.trim().match(/^([A-Za-z√á√ßƒûƒüƒ∞ƒ±√ñ√∂≈û≈ü√ú√º])(\d+)$/);
            if (!m) return numara;
            const harf = m[1];
            const rakamlar = m[2];
            const sifirSayisi = (rakamlar.match(/^0*/) || [''])[0].length;
            const kalan = rakamlar.slice(sifirSayisi) || '0';
            const sayi = parseInt(kalan, 10);
            const sifirKelimeler = sifirSayisi > 0 ? ' sƒ±fƒ±r'.repeat(sifirSayisi).trim() : '';
            const sayiKelime = sayiToTurkce(sayi);
            return sifirKelimeler ? harf + ' ' + sifirKelimeler + ' ' + sayiKelime : harf + ' ' + sayiKelime;
        }

        function announceSira(numara) {
            if (isMuted || !numara || !tvSettings.sesliDuyuru) return;
            if (!('speechSynthesis' in window)) return;
            const metin = numaraToSpeechText(numara);
            const u = new SpeechSynthesisUtterance(metin);
            u.lang = 'tr-TR';
            u.rate = 0.9;
            u.volume = 1; // Web Speech API'de maksimum ses
            const sesler = speechSynthesis.getVoices();
            const trSes = sesler.find(v => v.lang.startsWith('tr')) || sesler.find(v => v.lang.startsWith('tr-TR'));
            if (trSes) u.voice = trSes;
            speechSynthesis.cancel();
            speechSynthesis.speak(u);
        }

        function saatGuncelle() {
            const now = new Date();
            const el = document.getElementById('saat');
            if (el) el.textContent = now.toLocaleTimeString('tr-TR');
        }
        setInterval(saatGuncelle, 1000);
        saatGuncelle();

        function loadTVSettings() {
            const saved = localStorage.getItem('tv_settings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    tvSettings = { ...tvSettings, ...parsed };
                    if (typeof parsed.sesliDuyuru === 'boolean') tvSettings.sesliDuyuru = parsed.sesliDuyuru;
                    if (typeof parsed.sesAcik === 'boolean') tvSettings.sesAcik = parsed.sesAcik;
                } catch (e) {
                    console.error('Ayarlar okunamadƒ±:', e);
                }
            }
            isMuted = !tvSettings.sesAcik;
        }

        function openTVSettings() {
            document.getElementById('password-modal').style.display = 'flex';
            const input = document.getElementById('modal-password-input');
            input.value = '';
            setTimeout(() => input.focus(), 100);
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
        }

        async function verifyPassword() {
            const password = document.getElementById('modal-password-input').value;
            if (!password) return;

            try {
                const res = await apiCall('/api/auth/ekran-login', {
                    method: 'POST',
                    body: JSON.stringify({ sifre: password })
                });

                if (res.status === 'authorized') {
                    closePasswordModal();

                    if (res.firma_id != FIRMA_ID) {
                        localStorage.setItem('global_firma_id', res.firma_id);
                        alert(`Ekran ${res.firma_ad} firmasƒ±na baƒülandƒ±. Sayfa yenileniyor...`);
                        location.reload();
                        return;
                    }

                    document.getElementById('tv-settings-modal').style.display = 'flex';
                    loadSettingsData();
                }
            } catch (err) {
                alert('‚ùå Ge√ßersiz m√ºdahale ≈üifresi!');
                const input = document.getElementById('modal-password-input');
                input.value = '';
                input.focus();
            }
        }

        function closeTVSettings() {
            document.getElementById('tv-settings-modal').style.display = 'none';
        }

        async function loadSettingsData() {
            try {
                const [servisler, kuyruklar] = await Promise.all([
                    apiCall(`/api/servisler/${FIRMA_ID}`),
                    apiCall(`/api/kuyruklar/firma/${FIRMA_ID}`)
                ]);

                const sSelect = document.getElementById('servis-filter');
                sSelect.innerHTML = '';
                servisler.forEach(s => {
                    const opt = new Option(s.ad, s.id);
                    opt.selected = tvSettings.servisIds.includes(s.id);
                    sSelect.add(opt);
                });

                const updateKuyruklar = () => {
                    const kSelect = document.getElementById('kuyruk-filter');
                    kSelect.innerHTML = '';
                    const selectedServisIds = Array.from(sSelect.selectedOptions).map(o => parseInt(o.value));

                    const filteredKuyruklar = selectedServisIds.length === 0
                        ? kuyruklar
                        : kuyruklar.filter(k => selectedServisIds.includes(k.servis_id));

                    filteredKuyruklar.forEach(k => {
                        const opt = new Option(`${k.ad} (${k.kod})`, k.id);
                        opt.selected = tvSettings.kuyrukIds.includes(k.id);
                        kSelect.add(opt);
                    });
                };

                sSelect.onchange = updateKuyruklar;
                updateKuyruklar();

                document.getElementById('setting-ses-acik').checked = tvSettings.sesAcik;
                document.getElementById('setting-sesli-duyuru').checked = tvSettings.sesliDuyuru;
            } catch (err) {
                console.error("Veri y√ºkleme hatasƒ±:", err);
            }
        }

        function saveTVSettings() {
            const sSelect = document.getElementById('servis-filter');
            const kSelect = document.getElementById('kuyruk-filter');
            const sesAcikEl = document.getElementById('setting-ses-acik');
            const sesliDuyuruEl = document.getElementById('setting-sesli-duyuru');

            tvSettings = {
                servisIds: Array.from(sSelect.selectedOptions).map(o => parseInt(o.value)),
                kuyrukIds: Array.from(kSelect.selectedOptions).map(o => parseInt(o.value)),
                sesAcik: sesAcikEl ? sesAcikEl.checked : true,
                sesliDuyuru: sesliDuyuruEl ? sesliDuyuruEl.checked : true
            };

            isMuted = !tvSettings.sesAcik;
            localStorage.setItem('tv_settings', JSON.stringify(tvSettings));
            alert('‚úÖ Ayarlar kaydedildi!');
            closeTVSettings();
            cagrilariGuncelle();
        }

        function clearTVSelections() {
            const sSelect = document.getElementById('servis-filter');
            const kSelect = document.getElementById('kuyruk-filter');
            Array.from(sSelect.options).forEach(o => o.selected = false);
            sSelect.dispatchEvent(new Event('change'));
            Array.from(kSelect.options).forEach(o => o.selected = false);
        }

        function resetTVSettings() {
            if (confirm('‚ö†Ô∏è Ayarlarƒ± sƒ±fƒ±rlamak istiyor musunuz? Sayfa yenilenecek.')) {
                localStorage.removeItem('tv_settings');
                location.reload();
            }
        }

        async function cagrilariGuncelle() {
            try {
                let data = await apiCall(`/api/ekran/son-cagrilar/${FIRMA_ID}?limit=20`);

                if (tvSettings.servisIds.length > 0 || tvSettings.kuyrukIds.length > 0) {
                    data = data.filter(cagri => {
                        if (tvSettings.kuyrukIds.length > 0) {
                            return tvSettings.kuyrukIds.includes(cagri.kuyruk_id);
                        }
                        return tvSettings.servisIds.includes(cagri.servis_id);
                    });
                }

                const simdi = Date.now();

                // Backend'den gelen √ßaƒürƒ±larƒ± zaman sƒ±rasƒ±na g√∂re i≈üle
                // API genelde en yeni ‚Üí en eski d√∂nd√ºƒü√º i√ßin,
                // burada ters √ßevirip en eskiden yeniye doƒüru unshift ediyoruz
                // B√∂ylece dizinin ba≈üƒ±nda her zaman EN YENƒ∞ √ßaƒürƒ± olur.
                const orderedData = data.slice().reverse();

                // Backend'den gelen yeni √ßaƒürƒ±larƒ± displayedCalls'a ekle
                orderedData.forEach(cagri => {
                    if (!seenIds[cagri.id]) {
                        seenIds[cagri.id] = simdi;
                        const exists = displayedCalls.find(c => c.id === cagri.id);
                        if (!exists) displayedCalls.unshift(cagri);
                    }
                });

                displayedCalls = displayedCalls.filter(c => (simdi - seenIds[c.id]) < 600000);
                Object.keys(seenIds).forEach(id => {
                    if (simdi - seenIds[id] >= 600000) delete seenIds[id];
                });

                const spotlightContainer = document.getElementById('spotlight-container');
                const historyContainer = document.getElementById('history-container');

                if (displayedCalls.length === 0) {
                    spotlightContainer.innerHTML = '';
                    historyContainer.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 80px; margin-bottom: 20px; opacity:0.3;">‚è≥</div>
                            <div>Sƒ±radaki √ßaƒürƒ± bekleniyor...</div>
                        </div>
                    `;
                    lastCagriId = null;
                    return;
                }

                const latest = displayedCalls[0];
                const gecenSure = simdi - seenIds[latest.id];

                const isNewCall = (lastCagriId !== latest.id);
                if (isNewCall) {
                    if (!isFirstLoad && !isMuted && audioContext) {
                        if (audioContext.state === 'suspended') audioContext.resume();
                        playDingDong();
                        setTimeout(() => announceSira(latest.numara), 2700);
                    }
                    lastCagriId = latest.id;
                }
                isFirstLoad = false;

                const servisLabel = (c) => {
                    const servis = c.servis_ad || c.servis;
                    const kuyruk = c.kuyruk_ad || c.kuyruk;
                    return servis && kuyruk ? `${servis} ‚Äî ${kuyruk}` : (servis || kuyruk || '‚Äî');
                };
                const needsAnimation = gecenSure < 5000;
                spotlightContainer.innerHTML = `
                    <div class="spotlight-item" style="${needsAnimation ? 'animation: heartbeat 1.5s ease-in-out infinite;' : 'animation: none; box-shadow: 0 0 30px rgba(255, 0, 85, 0.3);'}">
                        <div class="spotlight-numara">${latest.numara}</div>
                        <div class="spotlight-detay">
                            <div class="spotlight-servis">${servisLabel(latest)}</div>
                            ${latest.konum ? `<div class="spotlight-oda"><svg class="pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${latest.konum}</div>` : ''}
                        </div>
                    </div>
                `;

                const historyData = displayedCalls.slice(1, 6);
                historyContainer.innerHTML = historyData.map((cagri, i) => {
                    const width = (95 - (i * 5)) + "%";
                    const scale = (0.99 - (i * 0.02)).toFixed(2);
                    const opacity = [0.95, 0.85, 0.75, 0.65, 0.55][i] || 0.45;
                    const blur = (i * 0.5) + "px";
                    const marginTop = 15 + "px";

                    return `
                        <div class="cagri-item" style="
                            width: ${width}; 
                            background: rgba(255, 0, 85, ${opacity}); 
                            border-color: rgba(255, 0, 85, ${opacity * 1.5});
                            filter: blur(${blur});
                            transform: scale(${scale});
                            opacity: ${opacity};
                            margin-top: ${marginTop};
                            margin-left: auto;
                            margin-right: auto;
                            transition: all 0.5s ease-out;
                        ">
                            <div class="cagri-numara" style="font-size: ${40 - (i * 4)}px;">${cagri.numara}</div>
                            <div class="cagri-detay">
                                <div class="cagri-departman" style="font-size: ${20 - (i * 2)}px;">${servisLabel(cagri)}</div>
                                ${cagri.konum ? `<div class="cagri-oda" style="font-size: ${28 - (i * 3)}px;"><svg class="pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${cagri.konum}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('TV Update Error:', error);
            }
        }

        async function bildirCihaz() {
            try {
                // TV ekranƒ± i√ßin basit ama stabil bir fingerprint
                let fingerprint = localStorage.getItem('tv_device_fingerprint');
                if (!fingerprint) {
                    fingerprint = `tv_${FIRMA_ID}_${window.location.hostname}`;
                    localStorage.setItem('tv_device_fingerprint', fingerprint);
                }

                const deviceInfo = {
                    firma_id: parseInt(FIRMA_ID),
                    ad: 'TV-' + FIRMA_ID,
                    tip: 'ekran',
                    device_fingerprint: fingerprint,
                    mac_address: null,
                    ip: null,
                    ayarlar: tvSettings,
                    metadata: {
                        servis_ids: tvSettings.servisIds,
                        ekran_tipi: tvSettings.ekranTipi
                    }
                };

                await apiCall('/api/cihaz/kayit', {
                    method: 'POST',
                    body: JSON.stringify(deviceInfo)
                });
            } catch (err) { console.error("Heartbeat error", err); }
        }

        async function initFirma() {
            try {
                console.log('[TV] Firma bilgisi y√ºkleniyor, FIRMA_ID:', FIRMA_ID);
                
                if (!FIRMA_ID || FIRMA_ID === 'null' || FIRMA_ID === 'undefined') {
                    console.error('[TV] FIRMA_ID ge√ßersiz:', FIRMA_ID);
                    document.getElementById('firma-adi').textContent = 'Firma ID Bulunamadƒ±';
                    return;
                }
                
                const firma = await apiCall(`/api/firma/${FIRMA_ID}`);
                console.log('[TV] Firma bilgisi geldi:', firma);
                
                if (firma && firma.ad) {
                    document.getElementById('firma-adi').textContent = firma.ad;
                    document.title = firma.ad + " - Sƒ±ra Ekranƒ±";
                    console.log('[TV] Firma adƒ± g√ºncellendi:', firma.ad);
                } else {
                    console.warn('[TV] Firma adƒ± bulunamadƒ± veya ge√ßersiz, response:', firma);
                    document.getElementById('firma-adi').textContent = 'Firma Adƒ± Bulunamadƒ±';
                }
                bildirCihaz();
            } catch (err) {
                console.error("[TV] Firma bilgisi alƒ±namadƒ±", err);
                console.error("[TV] Hata detayƒ±:", err.message, err.stack);
                document.getElementById('firma-adi').textContent = 'Firma Bilgisi Y√ºklenemedi: ' + (err.message || 'Bilinmeyen hata');
            }
        }

        function debouncedUpdate() {
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                cagrilariGuncelle();
            }, 300);
        }

        initFirma();
        loadTVSettings();
        cagrilariGuncelle();

        async function handleFastCall(sira) {
            // Filtreleme kontrol√º
            if (tvSettings.servisIds.length > 0 || tvSettings.kuyrukIds.length > 0) {
                const kId = parseInt(sira.kuyruk_id);
                const sId = parseInt(sira.servis_id);

                if (tvSettings.kuyrukIds.length > 0 && !tvSettings.kuyrukIds.includes(kId)) return;
                else if (tvSettings.servisIds.length > 0 && !tvSettings.servisIds.includes(sId)) return;
            }

            const simdi = Date.now();

            // Sƒ±rayƒ± listeye ekle
            if (!seenIds[sira.id]) {
                seenIds[sira.id] = simdi;
                displayedCalls.unshift(sira);
            } else {
                // Zaten varsa en ba≈üa ta≈üƒ± (tekrar √ßaƒürƒ±lma durumu)
                const idx = displayedCalls.findIndex(c => c.id == sira.id);
                if (idx > -1) displayedCalls.splice(idx, 1);
                displayedCalls.unshift(sira);
            }

            // Ekranƒ± g√ºncelle (API √ßaƒüƒ±rmadan)
            const spotlightContainer = document.getElementById('spotlight-container');
            const historyContainer = document.getElementById('history-container');

            // Spotlight
            const latest = sira;
            const needsAnimation = true;

            const servisLabel = (c) => {
                const servis = c.servis_ad || c.servis;
                const kuyruk = c.kuyruk_ad || c.kuyruk;
                return servis && kuyruk ? `${servis} ‚Äî ${kuyruk}` : (servis || kuyruk || '‚Äî');
            };
            spotlightContainer.innerHTML = `
                <div class="spotlight-item" style="animation: heartbeat 1.5s ease-in-out infinite;">
                    <div class="spotlight-numara">${latest.numara}</div>
                    <div class="spotlight-detay">
                        <div class="spotlight-servis">${servisLabel(latest)}</div>
                        ${latest.konum ? `<div class="spotlight-oda"><svg class="pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${latest.konum}</div>` : ''}
                    </div>
                </div>
            `;

            // Liste
            const historyData = displayedCalls.slice(1, 6);
            historyContainer.innerHTML = historyData.map((cagri, i) => {
                const width = (95 - (i * 5)) + "%";
                const scale = (0.99 - (i * 0.02)).toFixed(2);
                const opacity = [0.95, 0.85, 0.75, 0.65, 0.55][i] || 0.45;
                const blur = (i * 0.5) + "px";
                const marginTop = 15 + "px";

                return `
                    <div class="cagri-item" style="
                        width: ${width}; 
                        background: rgba(255, 0, 85, ${opacity}); 
                        border-color: rgba(255, 0, 85, ${opacity * 1.5});
                        filter: blur(${blur});
                        transform: scale(${scale});
                        opacity: ${opacity};
                        margin-top: ${marginTop};
                        margin-left: auto;
                        margin-right: auto;
                        transition: all 0.5s ease-out;
                    ">
                        <div class="cagri-numara" style="font-size: ${40 - (i * 4)}px;">${cagri.numara}</div>
                        <div class="cagri-detay">
                            <div class="cagri-departman" style="font-size: ${20 - (i * 2)}px;">${servisLabel(cagri)}</div>
                            ${cagri.konum ? `<div class="cagri-oda" style="font-size: ${28 - (i * 3)}px;"><svg class="pin-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${cagri.konum}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Ses √ßal, ardƒ±ndan sesli duyuru
            playDingDong();
            setTimeout(() => announceSira(sira.numara), 2700);
            lastCagriId = sira.id;
        }

        // Polling mekanizmasƒ± (WebSocket yedek sistemi)
        let pollingInterval = null;
        
        function isWebSocketConnected() {
            return window.ws && window.ws.readyState === WebSocket.OPEN;
        }
        
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // WebSocket baƒülƒ± deƒüilse polling ba≈ülat (biraz daha sƒ±k: 3 saniyede bir)
            pollingInterval = setInterval(() => {
                if (!isWebSocketConnected()) {
                    // WebSocket yoksa polling ile g√ºncelle
                    cagrilariGuncelle();
                } else {
                    // WebSocket baƒülandƒ±ysa polling'i durdur
                    stopPolling();
                }
            }, 3000); // 3 saniye
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        function checkWebSocketAndManagePolling() {
            if (isWebSocketConnected()) {
                stopPolling();
            } else {
                startPolling();
            }
        }
        
        initWebSocket((data) => {
            if (data.type === 'call_ticket') {
                handleFastCall(data.sira);
            } else if (data.type === 'new_ticket' || data.type === 'complete_ticket' || data.type === 'start_ticket') {
                debouncedUpdate();
            }
        });
        
        // ƒ∞lk kontrol: WebSocket durumunu kontrol et ve polling'i ba≈ülat/durdur
        setTimeout(() => {
            checkWebSocketAndManagePolling();
        }, 2000);
        
        // Periyodik kontrol: Her 5 saniyede bir WebSocket durumunu kontrol et
        setInterval(() => {
            checkWebSocketAndManagePolling();
        }, 5000);
    </script>
</body>

</html>