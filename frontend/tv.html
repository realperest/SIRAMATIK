<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Ekranƒ± - Sƒ±ramatik</title>
    <link rel="stylesheet" href="static/style.css">
    <style>
        body {
            margin: 0;
            background: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px 400px 30px 40px;
            /* Saate yer ayƒ±rƒ±yoruz */
            text-align: center;
            position: relative;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 56px;
            margin: 0;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .header .subtitle {
            font-size: 22px;
            opacity: 0.7;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        .cagri-listesi {
            padding: 20px 40px;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Yeni √áaƒürƒ± (Spotlight) Alanƒ± */
        .spotlight-area {
            min-height: 320px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .spotlight-item {
            background: linear-gradient(135deg, #ff0055 0%, #ff00a2 100%);
            width: 90%;
            padding: 40px;
            border-radius: 40px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 5px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .spotlight-item::after {
            content: "SIRA Sƒ∞ZDE!";
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 5px;
            color: rgba(255, 255, 255, 0.8);
            color: rgba(255, 255, 255, 0.8);
            animation: none;
            /* Varsayƒ±lan: Yanƒ±p s√∂nmez */
        }

        .spotlight-item.animasyonlu {
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        .spotlight-item.animasyonlu::after {
            animation: blink 1s infinite;
        }

        .spotlight-numara {
            font-size: 130px;
            font-weight: 900;
            text-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            color: white;
        }

        .spotlight-detay {
            text-align: center;
            color: white;
        }

        .spotlight-servis {
            font-size: 40px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .spotlight-oda {
            font-size: 50px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        /* Normal/Ge√ßmi≈ü √áaƒürƒ± √ñƒüesi (Daraltƒ±lmƒ±≈ü & √ñl√ßeklenmi≈ü) */
        .cagri-item {
            background: rgba(255, 0, 85, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 85, 0.2);
            padding: 15px 40px;
            margin: 5px 0;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top center;
            width: 100%;
            box-sizing: border-box;
        }

        .cagri-numara {
            font-weight: bold;
            color: #fff;
            font-size: 40px;
        }

        .cagri-detay {
            text-align: right;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .cagri-departman {
            font-size: 20px;
            opacity: 0.8;
        }

        .cagri-oda {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
        }

        .zaman {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 100px;
            font-weight: 900;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 10px 40px;
            border-radius: 20px;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            font-size: 28px;
            color: #7f8c8d;
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            }

            15% {
                transform: scale(1.05);
                box-shadow: 0 0 80px rgba(255, 0, 85, 0.8);
            }

            30% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            }

            45% {
                transform: scale(1.05);
                box-shadow: 0 0 80px rgba(255, 0, 85, 0.8);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes slideIn {
            0% {
                transform: translateY(-20px) scale(0.9);
                opacity: 0;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Sol Alt Ayarlar Butonu */
        .settings-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        /* Ayarlar Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .settings-panel {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .settings-panel h2 {
            margin-top: 0;
            color: #667eea;
            font-size: 24px;
        }

        .settings-panel label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
            color: #444;
            text-align: left;
        }

        .settings-panel select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .settings-panel button {
            margin: 10px 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: #22c55e;
            color: white;
        }

        .btn-save:hover {
            background: #16a34a;
        }

        .btn-cancel {
            background: #e74c3c;
            color: white;
        }

        .btn-cancel:hover {
            background: #c0392b;
        }

        .btn-reset {
            background: #f39c12;
            color: white;
        }

        .btn-reset:hover {
            background: #d68910;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 id="firma-adi">üè• Y√ºkleniyor...</h1>
        <div class="subtitle" id="firma-baslik">Sƒ±ra √áaƒürƒ± Sistemi</div>
        <div class="zaman" id="saat"></div>
    </div>

    <!-- Yeni √áaƒürƒ± (Spotlight) -->
    <div id="spotlight-container" class="spotlight-area"></div>

    <!-- Ge√ßmi≈ü √áaƒürƒ±lar -->
    <div class="cagri-listesi" id="history-container"></div>

    <!-- Sol Alt Ayarlar Butonu -->
    <button class="settings-button" onclick="openTVSettings()" title="Ekran Ayarlarƒ±">
        ‚öôÔ∏è
    </button>

    <!-- SES KONTROL√ú (Corner Toggle) -->
    <div id="mute-toggle" onclick="toggleMute()"
        style="position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.5); backdrop-filter: blur(5px); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; z-index:9999;">
        üîä
    </div>

    <!-- ≈ûifre Sorgulama Modalƒ± -->
    <div id="password-ask-modal" class="settings-modal" style="display:none; z-index: 10002;">
        <div class="settings-panel" style="max-width: 400px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 20px;">üîí</div>
            <h3 style="margin-bottom: 15px; color: #2c3e50;">M√ºdahale ≈ûifresi</h3>
            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">Ayarlara eri≈ümek i√ßin ≈üifreyi giriniz.</p>
            <input type="password" id="ask-password-input"
                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-size: 24px; text-align: center; margin-bottom: 25px; outline: none; box-sizing: border-box;"
                placeholder="****">
            <div style="display: flex; gap: 10px;">
                <button id="ask-password-confirm" class="btn-save" style="flex: 2; margin: 0;">Gƒ∞Rƒ∞≈û</button>
                <button id="ask-password-cancel" class="btn-cancel" style="flex: 1; margin: 0;">ƒ∞PTAL</button>
            </div>
        </div>
    </div>

    <!-- Ayarlar Modal -->
    <div class="settings-modal" id="tv-settings-modal">
        <div class="settings-panel">
            <h2>üì∫ Ekran Ayarlarƒ±</h2>
            <p style="color: #666; font-size: 14px; text-align: left;">Bu ekranda hangi b√∂l√ºm ve kuyruklara ait
                √ßaƒürƒ±larƒ±n g√∂sterileceƒüini se√ßin.</p>

            <label for="servis-filter">B√∂l√ºmler (Servisler):</label>
            <select id="servis-filter" multiple size="5" style="height: 120px;">
                <!-- Dinamik dolar -->
            </select>
            <small style="color: #999; display: block; text-align: left;">Ctrl/Cmd ile √ßoklu se√ßim
                yapabilirsiniz</small>

            <label for="kuyruk-filter">Kuyruklar (Opsiyonel):</label>
            <select id="kuyruk-filter" multiple size="5" style="height: 120px;">
                <!-- Dinamik dolar -->
            </select>
            <small style="color: #999; display: block; text-align: left;">Bo≈ü bƒ±rakƒ±lƒ±rsa se√ßili b√∂l√ºmlerin t√ºm
                kuyruklarƒ± listelenir</small>

            <div style="margin-top: 25px; text-align: center;">
                <button class="btn-save" onclick="saveTVSettings()">üíæ Kaydet</button>
                <button class="btn-reset" onclick="resetTVSettings()">üîÑ Sƒ±fƒ±rla</button>
                <button class="btn-cancel" onclick="closeTVSettings()">‚ùå ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <script src="static/app.js"></script>
    <script>
        let FIRMA_ID = localStorage.getItem('global_firma_id') || 1;
        let audioContext = null;
        let isMuted = false;

        function unlockAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        window.addEventListener('click', unlockAudio, { once: false });
        window.addEventListener('keydown', unlockAudio, { once: false });

        function toggleMute() {
            unlockAudio();
            isMuted = !isMuted;
            const btn = document.getElementById('mute-toggle');
            btn.innerHTML = isMuted ? 'üîá' : 'üîä';
            btn.style.background = isMuted ? 'rgba(231, 76, 60, 0.5)' : 'rgba(0,0,0,0.5)';
        }

        function playDingDong() {
            if (isMuted || !audioContext) return;
            if (audioContext.state === 'suspended') audioContext.resume();

            const osc1 = audioContext.createOscillator();
            const gain1 = audioContext.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(660, audioContext.currentTime);
            gain1.gain.setValueAtTime(0.5, audioContext.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            osc1.connect(gain1);
            gain1.connect(audioContext.destination);
            osc1.start();
            osc1.stop(audioContext.currentTime + 0.8);

            setTimeout(() => {
                if (isMuted) return;
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(550, audioContext.currentTime);
                gain2.gain.setValueAtTime(0.5, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.start();
                osc2.stop(audioContext.currentTime + 1.2);
            }, 600);
        }

        function saatGuncelle() {
            const now = new Date();
            const el = document.getElementById('saat');
            if (el) el.textContent = now.toLocaleTimeString('tr-TR');
        }
        setInterval(saatGuncelle, 1000);
        saatGuncelle();

        let lastDataJson = '';
        let lastCagriId = null;
        let lastCagirilmaSayisi = 0; // RECALL takibi i√ßin (Sayƒ±)
        let seenIds = {};
        let isFirstLoad = true;
        let tvSettings = { servisIds: [], kuyrukIds: [] };

        function loadTVSettings() {
            const saved = localStorage.getItem('tv_settings');
            if (saved) {
                try {
                    tvSettings = JSON.parse(saved);
                } catch (e) {
                    console.error('Ayarlar okunamadƒ±:', e);
                }
            }
        }

        async function openTVSettings() {
            const password = await askPasswordModal();
            if (!password) return;

            try {
                const res = await apiCall('/auth/ekran-login', {
                    method: 'POST',
                    body: JSON.stringify({ sifre: password })
                });

                if (res.status === 'authorized') {
                    if (res.firma_id != FIRMA_ID) {
                        localStorage.setItem('global_firma_id', res.firma_id);
                        alert(`Ekran ${res.firma_ad} firmasƒ±na baƒülandƒ±. Sayfa yenileniyor...`);
                        location.reload();
                        return;
                    }
                    document.getElementById('tv-settings-modal').style.display = 'flex';
                    loadSettingsData();
                }
            } catch (err) {
                alert('‚ùå Ge√ßersiz m√ºdahale ≈üifresi!');
            }
        }

        function askPasswordModal() {
            return new Promise((resolve) => {
                const modal = document.getElementById('password-ask-modal');
                const input = document.getElementById('ask-password-input');
                const confirmBtn = document.getElementById('ask-password-confirm');
                const cancelBtn = document.getElementById('ask-password-cancel');

                input.value = '';
                modal.style.display = 'flex';
                input.focus();

                const cleanup = () => {
                    modal.style.display = 'none';
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    input.onkeydown = null;
                };

                confirmBtn.onclick = () => {
                    const val = input.value;
                    cleanup();
                    resolve(val);
                };

                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(null);
                };

                input.onkeydown = (e) => {
                    if (e.key === 'Enter') confirmBtn.click();
                    if (e.key === 'Escape') cancelBtn.click();
                };
            });
        }

        function closeTVSettings() {
            document.getElementById('tv-settings-modal').style.display = 'none';
        }

        async function loadSettingsData() {
            try {
                const [servisler, kuyruklar] = await Promise.all([
                    apiCall(`/servisler/${FIRMA_ID}`),
                    apiCall(`/kuyruklar/firma/${FIRMA_ID}`)
                ]);

                const sSelect = document.getElementById('servis-filter');
                sSelect.innerHTML = '';
                servisler.forEach(s => {
                    const opt = new Option(s.ad, s.id);
                    opt.selected = tvSettings.servisIds.includes(s.id);
                    sSelect.add(opt);
                });

                const updateKuyruklar = () => {
                    const kSelect = document.getElementById('kuyruk-filter');
                    kSelect.innerHTML = '';
                    const selectedServisIds = Array.from(sSelect.selectedOptions).map(o => parseInt(o.value));

                    const filteredKuyruklar = selectedServisIds.length === 0
                        ? kuyruklar
                        : kuyruklar.filter(k => selectedServisIds.includes(k.servis_id));

                    filteredKuyruklar.forEach(k => {
                        const opt = new Option(`${k.ad} (${k.kod})`, k.id);
                        opt.selected = tvSettings.kuyrukIds.includes(k.id);
                        kSelect.add(opt);
                    });
                };

                sSelect.onchange = updateKuyruklar;
                updateKuyruklar();

            } catch (err) {
                console.error("Veri y√ºkleme hatasƒ±:", err);
            }
        }

        function saveTVSettings() {
            const sSelect = document.getElementById('servis-filter');
            const kSelect = document.getElementById('kuyruk-filter');

            tvSettings = {
                servisIds: Array.from(sSelect.selectedOptions).map(o => parseInt(o.value)),
                kuyrukIds: Array.from(kSelect.selectedOptions).map(o => parseInt(o.value))
            };

            localStorage.setItem('tv_settings', JSON.stringify(tvSettings));
            alert('‚úÖ Ayarlar kaydedildi!');
            closeTVSettings();
            cagrilariGuncelle();
        }

        function resetTVSettings() {
            if (confirm('‚ö†Ô∏è Ayarlarƒ± sƒ±fƒ±rlamak istiyor musunuz?')) {
                localStorage.removeItem('tv_settings');
                location.reload();
            }
        }

        async function cagrilariGuncelle() {
            try {
                let data = await apiCall(`/ekran/son-cagrilar/${FIRMA_ID}?limit=20`);

                if (tvSettings.servisIds.length > 0 || tvSettings.kuyrukIds.length > 0) {
                    data = data.filter(c => {
                        if (tvSettings.kuyrukIds.length > 0) {
                            return tvSettings.kuyrukIds.includes(c.kuyruk_id);
                        }
                        return tvSettings.servisIds.includes(c.servis_id);
                    });
                }

                const spotlightContainer = document.getElementById('spotlight-container');
                const historyContainer = document.getElementById('history-container');

                if (!data || data.length === 0) {
                    spotlightContainer.innerHTML = '';
                    historyContainer.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 80px; margin-bottom: 20px; opacity:0.3;">‚è≥</div>
                            <div>Sƒ±radaki √ßaƒürƒ± bekleniyor...</div>
                        </div>
                    `;
                    lastCagriId = null;
                    return;
                }

                const latest = data[0];

                let isNew = false;
                // cagirilma_sayisi deƒüi≈ümi≈üse TEKRAR √áAƒûIR yapƒ±lmƒ±≈ütƒ±r
                if (lastCagriId !== latest.id || lastCagirilmaSayisi !== latest.cagirilma_sayisi) {
                    isNew = true;
                    if (!isFirstLoad) {
                        if (typeof playDingDong === 'function') playDingDong();
                    }
                    lastCagriId = latest.id;
                    lastCagirilmaSayisi = latest.cagirilma_sayisi;
                }
                isFirstLoad = false;

                const animClass = isNew ? 'animasyonlu' : '';

                spotlightContainer.innerHTML = `
                    <div class="spotlight-item ${animClass}" id="main-spotlight">
                        <div class="spotlight-numara">${latest.numara}</div>
                        <div class="spotlight-detay">
                            <div class="spotlight-servis">${latest.servis}</div>
                            ${latest.konum ? `<div class="spotlight-oda">üìç ${latest.konum}</div>` : ''}
                        </div>
                    </div>
                `;

                if (isNew) {
                    setTimeout(() => {
                        const el = document.getElementById('main-spotlight');
                        if (el) el.classList.remove('animasyonlu');
                    }, 5000);
                }

                const historyData = data.slice(1, 6);

                historyContainer.innerHTML = historyData.map((cagri, i) => {
                    const scale = (1 - (i * 0.05)).toFixed(2);
                    const width = (100 - (i * 4)) + "%";
                    const opacity = [0.8, 0.6, 0.4, 0.2, 0.1][i] || 0.05;
                    const blur = (i * 1.5) + "px";

                    return `
                        <div class="cagri-item" style="
                            width: ${width}; 
                            background: rgba(255, 0, 85, ${opacity}); 
                            border-color: rgba(255, 0, 85, ${opacity});
                            filter: blur(${blur});
                            transform: scale(${scale});
                            opacity: ${opacity};
                            margin-top: 15px;
                            margin-left: auto;
                            margin-right: auto;
                            animation: slideIn 0.5s ease-out;
                        ">
                            <div class="cagri-numara">${cagri.numara}</div>
                            <div class="cagri-detay">
                                <div class="cagri-departman">${cagri.servis}</div>
                                ${cagri.konum ? `<div class="cagri-oda">üìç ${cagri.konum}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('TV Update Error:', error);
            }
        }

        async function bildirCihaz() {
            try {
                await apiCall('/admin/cihaz/bildir', {
                    method: 'POST',
                    body: JSON.stringify({
                        firma_id: parseInt(FIRMA_ID),
                        ad: 'TV-' + FIRMA_ID,
                        tip: 'screen1',
                        metadata: {
                            servis_ids: tvSettings.servisIds,
                            ekran_tipi: tvSettings.ekranTipi
                        }
                    })
                });
            } catch (err) { console.error("Heartbeat error", err); }
        }

        async function initFirma() {
            try {
                const firma = await apiCall(`/firma/${FIRMA_ID}`);
                if (firma && firma.ad) {
                    document.getElementById('firma-adi').textContent = firma.ad;
                    document.title = firma.ad + " - Sƒ±ra Ekranƒ±";
                }
                bildirCihaz();
                setInterval(bildirCihaz, 30000);
            } catch (err) {
                console.error("Firma bilgisi alƒ±namadƒ±", err);
            }
        }

        const overlay = document.createElement('div');
        overlay.id = 'start-overlay';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 14, 23, 0.98); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; font-family: 'Segoe UI', system-ui, sans-serif;
            backdrop-filter: blur(10px);
        `;
        overlay.innerHTML = `
            <div style="font-size: 80px; margin-bottom: 30px; animation: bounce 2s infinite;">üì∫</div>
            <h1 style="font-size: 48px; margin: 0 0 20px 0; font-weight:800; letter-spacing:-1px;">TV Ekranƒ± Hazƒ±r</h1>
            <p style="font-size: 20px; color: #8892b0; margin-bottom: 50px; max-width: 600px; line-height: 1.6;">
                Tarayƒ±cƒ± politikalarƒ± gereƒüi sesin √ßalabilmesi i√ßin kullanƒ±cƒ± etkile≈üimi gerekmektedir.
            </p>
            <button id="btn-baslat" style="
                padding: 25px 80px; font-size: 24px; font-weight: 800;
                background: linear-gradient(135deg, #00b09b, #96c93d);
                color: white; border: none; border-radius: 20px;
                cursor: pointer; box-shadow: 0 20px 40px rgba(0, 176, 155, 0.3);
                transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 2px;
                display: flex; align-items: center; gap: 15px;
            ">
                <span>BA≈ûLAT</span> üöÄ
            </button>
        `;
        document.body.appendChild(overlay);

        document.getElementById('btn-baslat').onclick = () => {
            unlockAudio();
            playDingDong();
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log("Tam ekran reddedildi:", e));
            }
            overlay.style.transition = 'opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1), transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)';
            overlay.style.opacity = '0';
            overlay.style.transform = 'scale(1.1)';
            setTimeout(() => overlay.remove(), 600);
        };

        initFirma();
        loadTVSettings();
        cagrilariGuncelle();

        let updateTimeout = null;

        function debouncedUpdate() {
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                cagrilariGuncelle();
            }, 300);
        }

        initWebSocket((data) => {
            if (data.type === 'call_ticket') {
                debouncedUpdate();
            }
        });


    </script>
</body>

</html>