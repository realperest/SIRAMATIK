<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Ekranƒ± - Sƒ±ramatik</title>
    <link rel="stylesheet" href="static/style.css">
    <style>
        body {
            margin: 0;
            background: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 48px;
            margin: 0;
        }

        .header .subtitle {
            font-size: 24px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .cagri-listesi {
            padding: 40px;
        }

        .cagri-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            margin: 25px 0;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        .cagri-numara {
            font-size: 96px;
            font-weight: bold;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .cagri-detay {
            text-align: right;
        }

        .cagri-departman {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .cagri-oda {
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
        }

        .zaman {
            position: fixed;
            top: 30px;
            right: 30px;
            font-size: 32px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 25px;
            border-radius: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            font-size: 36px;
            color: #7f8c8d;
        }

        @keyframes slideIn {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .cagri-item:first-child {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <div class="zaman" id="saat"></div>

    <div class="header">
        <h1 id="firma-adi">üè• Y√ºkleniyor...</h1>
        <div class="subtitle" id="firma-baslik">Sƒ±ra √áaƒürƒ± Sistemi</div>
    </div>

    <div class="cagri-listesi" id="cagrilar"></div>

    <!-- SES KONTROL√ú (Corner Toggle) -->
    <div id="mute-toggle" onclick="toggleMute()"
        style="position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.5); backdrop-filter: blur(5px); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; z-index:9999;">
        üîä
    </div>

    <script src="static/app.js"></script>
    <script>
        const FIRMA_ID = 1;
        let audioContext = null;
        let isMuted = false;

        // Sayfada herhangi bir tƒ±klama ile sesi "unlocked" yap
        function unlockAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("üîä Audio unlocked");
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Global tƒ±klama ve tu≈ü basƒ±mƒ±yla sesi aktif et (browser kƒ±sƒ±tlamasƒ± i√ßin)
        window.addEventListener('click', unlockAudio, { once: false });
        window.addEventListener('keydown', unlockAudio, { once: false });

        function toggleMute() {
            unlockAudio(); // Toggle basƒ±ldƒ±ƒüƒ±nda da Context'i a√ß
            isMuted = !isMuted;
            const btn = document.getElementById('mute-toggle');
            btn.innerHTML = isMuted ? 'üîá' : 'üîä';
            btn.style.background = isMuted ? 'rgba(231, 76, 60, 0.5)' : 'rgba(0,0,0,0.5)';

            if (!isMuted) {
                playDingDong(); // Sesi a√ßtƒ±ƒüƒ±nda test i√ßin √ßal
            }
        }

        function playDingDong() {
            if (isMuted) return;
            if (!audioContext) return;

            if (audioContext.state === 'suspended') audioContext.resume();

            const osc1 = audioContext.createOscillator();
            const gain1 = audioContext.createGain();

            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(660, audioContext.currentTime); // Ding
            osc1.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.1);

            gain1.gain.setValueAtTime(0.5, audioContext.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

            osc1.connect(gain1);
            gain1.connect(audioContext.destination);

            osc1.start();
            osc1.stop(audioContext.currentTime + 0.8);

            // Dong
            setTimeout(() => {
                if (isMuted) return;
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();

                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(550, audioContext.currentTime); // Dong

                gain2.gain.setValueAtTime(0.5, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);

                osc2.connect(gain2);
                gain2.connect(audioContext.destination);

                osc2.start();
                osc2.stop(audioContext.currentTime + 1.2);
            }, 600);
        }

        // Saati g√ºncelle
        function saatGuncelle() {
            const now = new Date();
            document.getElementById('saat').textContent = now.toLocaleTimeString('tr-TR');
        }
        setInterval(saatGuncelle, 1000);
        saatGuncelle();

        let lastDataJson = '';
        let lastCagriId = null;

        // √áaƒürƒ±larƒ± y√ºkle
        async function cagrilariGuncelle() {
            try {
                // Backend sorgusundan gelen (son 1 dakikadaki) verileri g√∂steriyoruz.
                const data = await apiCall(`/ekran/son-cagrilar/${FIRMA_ID}?limit=5`);

                // SES KONTROL√ú
                if (data && data.length > 0) {
                    const latest = data[0];
                    if (lastCagriId !== null && latest.id !== lastCagriId) {
                        console.log("üîî YENƒ∞ √áAƒûRI:", latest.numara);
                        if (audioContext) {
                            if (audioContext.state === 'suspended') audioContext.resume();
                            playDingDong();
                        }
                    }
                    lastCagriId = latest.id;
                }

                const container = document.getElementById('cagrilar');

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 80px; margin-bottom: 20px; opacity:0.3;">‚è≥</div>
                            <div>Sƒ±radaki √ßaƒürƒ± bekleniyor...</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.map((cagri, index) => `
                        <div class="cagri-item">
                            <div class="cagri-numara">${cagri.numara}</div>
                            <div class="cagri-detay">
                                <div class="cagri-departman">${cagri.servis}</div>
                                ${cagri.konum ? `<div class="cagri-oda">üìç ${cagri.konum}</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('TV Update Error:', error);
            }
        }

        // ƒ∞lk y√ºkleme
        // Firma bilgilerini ger√ßeƒüiyle g√ºncelle
        async function initFirma() {
            try {
                const firma = await apiCall(`/firma/${FIRMA_ID}`);
                if (firma && firma.ad) {
                    document.getElementById('firma-adi').textContent = firma.ad;
                    document.title = firma.ad + " - Sƒ±ra Ekranƒ±";
                }
            } catch (err) {
                console.error("Firma bilgisi alƒ±namadƒ±", err);
            }
        }

        initFirma();
        cagrilariGuncelle();

        // Her 2 saniyede bir g√ºncelle
        setInterval(cagrilariGuncelle, 1000);
    </script>
</body>

</html>