<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AG-Grid Kurumsal Analiz (Pivot Pro) - Sıramatik</title>

    <!-- AG Grid Enterprise v31.3 (31.0.x'te sütun genişliği geri yükleme hatası vardı; 31.2+ düzeltildi) -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.3.2/dist/ag-grid-enterprise.min.js"></script>
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- HTML -> PDF (Better Turkish character support via browser rendering) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Explicit html2canvas for paged rendering (html2pdf bundle may not expose window.html2canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.2/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.2/styles/ag-theme-quartz.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --admin-bg: #0f172a;
            --sidebar-bg: #1e293b;
            --accent: #6366f1;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--admin-bg);
            color: #f1f5f9;
            margin: 0;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-nav {
            padding: 0 25px;
            height: 60px;
            background: #1e293b;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 800;
            color: #818cf8;
        }

        #grid-wrapper {
            flex: 1;
            padding: 15px;
            background: #0f172a;
            position: relative;
        }

        #myGrid {
            height: 100%;
            width: 100%;
        }

        /* AG Grid Quartz Dark Themes & Header Visibility */
        .ag-theme-quartz-dark {
            --ag-background-color: #0f172a;
            --ag-header-background-color: #111827;
            --ag-header-foreground-color: #ffffff;
            --ag-header-column-separator-display: block;
            --ag-header-column-separator-color: rgba(255, 255, 255, 0.1);
            /* Zebra Striping */
            --ag-odd-row-background-color: #1e293b;
            --ag-row-hover-color: rgba(99, 102, 241, 0.1);
            --ag-selected-row-background-color: rgba(99, 102, 241, 0.2);
        }

        /* Sütun başlığı: dar sütunlarda yazı boyutu küçülsün */
        .ag-header-cell {
            container-type: inline-size;
            container-name: header-cell;
        }
        .ag-header-cell-label,
        .ag-header-cell-text {
            font-size: clamp(9px, 6.5cqw, 13px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* BRUTE FORCE: Ensure header text is visible in normal mode */
        .ag-header-cell-label,
        .ag-header-cell-text,
        .ag-cell-label-container {
            color: #ffffff !important;
            font-weight: 700 !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .ag-header {
            background-color: #0f172a !important;
        }

        .btn-refresh {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 13px;
        }
    </style>
</head>

<body class="ag-theme-quartz-dark">
    <header class="top-nav">
        <div class="logo">
            <i class="fas fa-th-large"></i> AG-GRID ANALİZ (PRO)
        </div>

        <div style="display: flex; gap: 10px; align-items: center; flex: 1; margin-left: 20px;">
            <!-- Grup Kontrolleri -->
            <div style="display: flex; gap: 4px;">
                <button class="btn-refresh" style="background: #334155; padding: 6px 10px;" onclick="expandAllGroups()"
                    title="Tüm Grupları Aç">
                    <i class="fas fa-plus-square"></i>
                </button>
                <button class="btn-refresh" style="background: #334155; padding: 6px 10px;"
                    onclick="collapseAllGroups()" title="Tüm Grupları Kapat">
                    <i class="fas fa-minus-square"></i>
                </button>
            </div>

            <div style="flex: 1;"></div> <!-- Spacer -->

            <label style="font-size: 11px; color: #94a3b8;">ARALIK:</label>
            <select id="timeRange" onchange="loadData(); saveTimeRange(this.value)">
                <option value="today">Bugün</option>
                <option value="this_week">Bu Hafta</option>
                <option value="this_month" selected>Bu Ay</option>
                <option value="last_month">Geçen Ay</option>
                <option value="last_year">Geçen Yıl</option>
                <option value="all_time">Tüm Zamanlar</option>
            </select>
            <!-- Rapor Şablonları -->
            <div
                style="display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px; gap: 8px; border: 1px solid rgba(255,255,255,0.05);">
                <label style="font-size: 10px; color: #94a3b8; font-weight: 700;">ŞABLONLAR:</label>
                <select id="presetSelect" onchange="loadPreset(this.value)" style="width: 140px; background: #0f172a;">
                    <option value="">-- Şablon Seç --</option>
                </select>
                <input type="text" id="newPresetName" placeholder="Rapor Adı..."
                    style="width: 100px; padding: 5px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; font-size: 11px;">
                <button class="btn-refresh" style="background: #a855f7; padding: 6px 10px;" onclick="saveNewPreset()"
                    title="Bu Düzeni Kaydet">
                    <i class="fas fa-save"></i>
                </button>
                <button class="btn-refresh" style="background: #ef4444; padding: 6px 10px;" onclick="deletePreset()"
                    title="Seçili Şablonu Sil">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <!-- Hücre Ayarları -->
            <div
                style="display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px; gap: 5px; border: 1px solid rgba(255,255,255,0.05);">
                <label style="font-size: 10px; color: #94a3b8; font-weight: 700;"> BASAMAK:</label>
                <button class="btn-refresh" style="background: #475569; padding: 4px 8px; font-size: 10px;"
                    onclick="setDecimalPlaces(0)">0</button>
                <button class="btn-refresh" style="background: #475569; padding: 4px 8px; font-size: 10px;"
                    onclick="setDecimalPlaces(1)">1</button>
                <button class="btn-refresh" style="background: #475569; padding: 4px 8px; font-size: 10px;"
                    onclick="setDecimalPlaces(2)">2</button>
            </div>

            <button class="btn-refresh" style="background: #f59e0b;" onclick="createDefaultChart()">
                <i class="fas fa-chart-bar"></i> Grafik
            </button>
            <button class="btn-refresh" onclick="loadData()">
                <i class="fas fa-sync"></i> Güncelle
            </button>
            <button class="btn-refresh" onclick="onBtExport()" style="background: #10b981;">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn-refresh" onclick="exportToPDF()" style="background: #e11d48;">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
    </header>

    <div id="grid-wrapper">
        <div id="myGrid" class="ag-theme-quartz-dark"></div>
    </div>

    <!-- Şablon Çakışma Modali -->
    <div id="presetOverwriteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:999999; align-items:center; justify-content:center;">
        <div style="width:min(520px, calc(100vw - 32px)); background:#0b1220; border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:16px 16px 14px; box-shadow: 0 20px 60px rgba(0,0,0,0.6);">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                <div style="font-weight:800; color:#e2e8f0;">Bu şablon zaten kayıtlı</div>
                <button onclick="closePresetModal()" style="background:transparent; border:0; color:#94a3b8; cursor:pointer; font-size:18px;">×</button>
            </div>
            <div id="presetOverwriteText" style="color:#cbd5e1; font-size:13px; line-height:1.5; margin-bottom:10px;"></div>

            <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                <label style="font-size:11px; color:#94a3b8; font-weight:700; white-space:nowrap;">YENİ İSİM:</label>
                <input id="presetOverwriteNewName" type="text" placeholder="Yeni şablon adı..."
                    style="flex:1; padding:8px 10px; background:#0f172a; border:1px solid #334155; color:#fff; border-radius:10px; font-size:13px;">
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closePresetModal()" style="background:#334155; color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700;">İptal</button>
                <button onclick="presetModalSaveAsNew()" style="background:#a855f7; color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800;">Yeni isimle kaydet</button>
                <button onclick="presetModalOverwrite()" style="background:#10b981; color:#06281f; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:900;">Şablonu değiştir</button>
            </div>
        </div>
    </div>

    <script>
        const currentHost = window.location.hostname || 'localhost';
        const API_URL = `http://${currentHost}:8000/api`;
        let gridApi;
        let currentUser = null;
        try {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                currentUser = JSON.parse(userStr);
            }
        } catch (e) {
            console.error('[RAPOR] currentUser yüklenirken hata:', e);
        }
        console.log('[RAPOR] currentUser yüklendi:', currentUser);
        let isExpandedGlobal = false; // Grupların açık/kapalı durumunu takip eder
        let decimalPlacesGlobal = 2; // Varsayılan ondalık basamak

        // Hücre Biçimlendirici (Türkçe Standartlarında 1.234,56)
        const numberFormatter = (params) => {
            if (params.value == null || isNaN(params.value)) return params.value;
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimalPlacesGlobal
            }).format(params.value);
        };

        const columnDefs = [
            { headerName: "TARİH", field: "Tarih", filter: 'agDateColumnFilter', sort: 'desc', pinned: 'left' },
            {
                headerName: "YIL", field: "Yıl", enableRowGroup: true, enablePivot: true, hide: true,
                filter: 'agSetColumnFilter',
                filterParams: { comparator: (a, b) => parseInt(a) - parseInt(b) }
            },
            {
                headerName: "AY", field: "Ay", enableRowGroup: true, enablePivot: true, hide: true,
                filter: 'agSetColumnFilter',
                filterParams: {
                    comparator: (a, b) => {
                        const months = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                        return months.indexOf(a) - months.indexOf(b);
                    }
                }
            },
            {
                headerName: "GÜN", field: "Gün", enableRowGroup: true, enablePivot: true, hide: true,
                filter: 'agSetColumnFilter',
                filterParams: { comparator: (a, b) => parseInt(a) - parseInt(b) }
            },
            {
                headerName: "HAFTANIN GÜNÜ", field: "Haftanın Günü", enableRowGroup: true, enablePivot: true, hide: true,
                filter: 'agSetColumnFilter',
                filterParams: {
                    comparator: (a, b) => {
                        const days = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
                        return days.indexOf(a) - days.indexOf(b);
                    }
                }
            },
            {
                headerName: "YILIN HAFTASI", field: "Yılın Haftası", enableRowGroup: true, enablePivot: true, hide: true,
                filter: 'agSetColumnFilter',
                filterParams: {
                    comparator: (a, b) => {
                        const getNum = (s) => parseInt(s.replace('Hafta ', '')) || 0;
                        return getNum(a) - getNum(b);
                    }
                }
            },
            { headerName: "SAAT", field: "Saat", filter: 'agTextColumnFilter' },
            { headerName: "BÖLÜM", field: "Bölüm", enableRowGroup: true, enablePivot: true, filter: 'agSetColumnFilter' },
            { headerName: "KUYRUK", field: "Kuyruk", enableRowGroup: true, enablePivot: true, filter: 'agSetColumnFilter' },
            { headerName: "PERSONEL", field: "Personel", enableRowGroup: true, enablePivot: true, filter: 'agSetColumnFilter' },
            { headerName: "DURUM", field: "Durum", enableRowGroup: true, enablePivot: true, filter: 'agSetColumnFilter' },
            {
                headerName: "BEKLEME (DK)",
                field: "Bekleme (dk)",
                aggFunc: 'avg',
                enableValue: true,
                filter: 'agNumberColumnFilter',
                valueFormatter: numberFormatter,
                type: 'rightAligned'
            },
            {
                headerName: "İŞLEM (DK)",
                field: "İşlem (dk)",
                aggFunc: 'avg',
                enableValue: true,
                filter: 'agNumberColumnFilter',
                valueFormatter: numberFormatter,
                type: 'rightAligned'
            },
            {
                headerName: "BİLET ADET",
                field: "Bilet Adet",
                aggFunc: 'sum',
                enableValue: true,
                valueFormatter: numberFormatter,
                type: 'rightAligned'
            },
            {
                headerName: "PUANLAMA ORANI (%)",
                field: "Puanlama Oranı",
                aggFunc: 'avg',
                enableValue: true,
                enableRowGroup: true,
                enablePivot: true,
                filter: 'agNumberColumnFilter',
                valueFormatter: numberFormatter,
                type: 'rightAligned'
            },
            {
                headerName: "ORTALAMA PUAN",
                field: "Ortalama Puan",
                aggFunc: 'avg',
                enableValue: true,
                enableRowGroup: true,
                enablePivot: true,
                filter: 'agNumberColumnFilter',
                valueFormatter: numberFormatter,
                type: 'rightAligned'
            }
        ];

        const AG_GRID_LOCALE_TR = {
            // Sütun Menüsü ve Filtreler
            contains: 'İçerir',
            notContains: 'İçermez',
            equals: 'Eşittir',
            notEqual: 'Eşit Değil',
            startsWith: 'İle Başlar',
            endsWith: 'İle Biter',
            blank: 'Boş',
            notBlank: 'Boş Değil',
            empty: 'Seçiniz',
            lessThan: 'Daha Az',
            greaterThan: 'Daha Fazla',
            lessThanOrEqual: 'Daha Az veya Eşit',
            greaterThanOrEqual: 'Daha Fazla veya Eşit',
            inRange: 'Arasında',
            inRangeStart: 'Başlangıç',
            inRangeEnd: 'Bitiş',
            filterOoo: 'Filtrele...',
            applyFilter: 'Filtreyi Uygula',
            resetFilter: 'Temizle',
            clearFilter: 'Temizle',
            andCondition: 'VE',
            orCondition: 'VEYA',

            // Tarih Filtresi
            dateFormatOoo: 'gg.aa.yyyy',
            before: 'Önce',
            after: 'Sonra',

            // Sağ Panel (Side Bar)
            columns: 'Sütunlar',
            filters: 'Filtreler',
            pivotMode: 'Pivot Modu',
            groups: 'Satır Grupları',
            rowGroupColumnsEmptyMessage: 'Gruplamak için sütunları buraya sürükleyin',
            values: 'Değerler',
            valueColumnsEmptyMessage: 'Hesaplama için buraya sürükleyin',
            pivots: 'Sütun Etiketleri',
            pivotColumnsEmptyMessage: 'Pivot için buraya sürükleyin',
            searchOoo: 'Ara...',
            selectAll: '(Hepsini Seç)',
            selectAllSearchResults: '(Tüm Arama Sonuçlarını Seç)',

            // Durum Çubuğu
            totalRows: 'Toplam Satır',
            totalAndFilteredRows: 'Satırlar',
            page: 'Sayfa',
            more: 'Daha Fazla',
            to: '-',
            of: '/',
            next: 'Sonraki',
            last: 'Son',
            first: 'İlk',
            previous: 'Önceki',

            // Gruplama ve Toplama
            sum: 'Toplam',
            min: 'Min',
            max: 'Max',
            none: 'Yok',
            count: 'Adet',
            avg: 'Ortalama',
            filteredRows: 'Filtrelenen',
            selectedRows: 'Seçilen',
            totalRows: 'Toplam',
            group: 'Grup',

            // Menü ve Genel
            noRowsToShow: 'Görüntülenecek veri yok',
            loadingOoo: 'Yükleniyor...',
            export: 'Aktar',
            csvExport: 'CSV Olarak Aktar',
            excelExport: 'Excel Olarak Aktar (.xlsx)',
            pinColumn: 'Sütunu Sabitle',
            pinLeft: 'Sola Sabitle',
            pinRight: 'Sağa Sabitle',
            noPin: 'Sabitlemeyi Kaldır',
            autosizeThiscolumn: 'Bu Sütunu Otomatik Boyutlandır',
            autosizeAllColumns: 'Tüm Sütunları Otomatik Boyutlandır',
            groupBy: 'Şuna Göre Grupla',
            ungroupBy: 'Gruplamayı Kaldır',
            resetColumns: 'Sütunları Sıfırla',
            expandAll: 'Hepsini Genişlet',
            collapseAll: 'Hepsini Daralt',
            copy: 'Kopyala',
            copyWithHeaders: 'Başlıklarla Kopyala',
            ctrlC: 'Ctrl+C',
            paste: 'Yapıştır',
            ctrlV: 'Ctrl+V',

            // Hizalama
            alignment: 'Hizalama',
            left: 'Sola Yasla',
            center: 'Ortala',
            right: 'Sağa Yasla',

            // Grafik Terimleri
            chartMenu: 'Grafik',
            pivotChart: 'Pivot Grafik',
            rangeChart: 'Aralık Grafiği',
            columnChart: 'Sütun',
            groupedColumn: 'Gruplanmış',
            stackedColumn: 'Yığılmış',
            normalizedColumn: ' %100 Yığılmış',
            barChart: 'Çubuk',
            groupedBar: 'Gruplanmış',
            stackedBar: 'Yığılmış',
            normalizedBar: '%100 Yığılmış',
            pieChart: 'Pasta',
            pie: 'Pasta',
            doughnut: 'Simit',
            lineChart: 'Çizgi',
            areaChart: 'Alan',
            area: 'Alan',
            stackedArea: 'Yığılmış',
            normalizedArea: '%100 Yığılmış',
            scatterChart: 'Nokta',
            bubbleChart: 'Baloncuk',
            histogramChart: 'Histogram',
            combinationChart: 'Kombinasyon',
            columnLineCombo: 'Sütun & Çizgi',
            AreaColumnCombo: 'Alan & Sütun',
            chartSettings: 'Grafik Ayarları',
            chartFilters: 'Grafik Filtreleri',
            chartTitle: 'Grafik Başlığı',
            chartFormat: 'Format',
            top: 'Üst',
            right: 'Sağ',
            bottom: 'Alt',
            left: 'Sol',
            labels: 'Etiketler',
            data: 'Veri',
            type: 'Tür',
            category: 'Kategori',
            series: 'Seriler',
            noDataToChart: 'Grafik oluşturulacak veri yok.',
            pivotChartTitle: 'Pivot Grafiği',
            rangeChartTitle: 'Aralık Grafiği'
        };

        const gridOptions = {
            columnDefs: columnDefs,
            localeText: AG_GRID_LOCALE_TR,
            headerHeight: 50,
            pivotMode: false,
            pagination: true,
            paginationPageSize: 100,
            enableCharts: true,
            enableRangeSelection: true,
            popupParent: document.body,
            getContextMenuItems: function (params) {
                const result = [
                    'copy',
                    'copyWithHeaders',
                    'paste',
                    'separator',
                    {
                        name: 'Sütun Hizalaması',
                        icon: '<i class="fas fa-align-left"></i>',
                        subMenu: [
                            {
                                name: 'Sola Yasla',
                                action: () => params.api.applyColumnState({
                                    state: [{ colId: params.column.getColId(), cellClass: 'ag-left-aligned-cell' }],
                                    applyOrder: true
                                })
                            },
                            {
                                name: 'Ortala',
                                action: () => params.api.applyColumnState({
                                    state: [{ colId: params.column.getColId(), cellClass: 'ag-center-aligned-cell' }],
                                    applyOrder: true
                                })
                            },
                            {
                                name: 'Sağa Yasla',
                                action: () => params.api.applyColumnState({
                                    state: [{ colId: params.column.getColId(), cellClass: 'ag-right-aligned-cell' }],
                                    applyOrder: true
                                })
                            }
                        ]
                    },
                    'separator',
                    'chartRange',
                    'export'
                ];
                return result;
            },
            defaultColDef: {
                flex: 1,
                minWidth: 100,
                filter: true,
                sortable: true,
                resizable: true,
                floatingFilter: true,
                cellStyle: params => {
                    // Sayısal değerleri sağa hizala
                    if (params.value != null && typeof params.value === 'number') {
                        return { textAlign: 'right' };
                    }
                    return null;
                }
            },
            statusBar: {
                statusPanels: [
                    { statusPanel: 'agTotalAndFilteredRowCountComponent', align: 'left' },
                    { statusPanel: 'agAggregationComponent' }
                ]
            },
            sideBar: ['columns', 'filters']
        };

        // Zaman Arağılını Sakla
        function saveTimeRange(val) {
            localStorage.setItem('ag_grid_time_range', val);
        }

        // Şablon Listesini Güncelle
        async function updatePresetList() {
            const select = document.getElementById('presetSelect');
            if (!select) {
                console.warn('[RAPOR] presetSelect elementi bulunamadı');
                return;
            }
            
            // currentUser kontrolü
            if (!currentUser || !currentUser.firma_id) {
                console.error('[RAPOR] currentUser veya firma_id bulunamadı:', currentUser);
                // 1 saniye sonra tekrar dene
                setTimeout(updatePresetList, 1000);
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('[RAPOR] Token bulunamadı');
                    return;
                }
                
                const apiUrl = `${API_URL}/admin/rapor-sablonlari/${currentUser.firma_id}?rapor_tipi=ag_grid`;
                console.log('[RAPOR] Şablon listesi yükleniyor...', {
                    firma_id: currentUser.firma_id,
                    kullanici_id: currentUser.id,
                    API_URL: apiUrl
                });
                
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    console.error('[RAPOR] HTTP hatası:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('[RAPOR] Hata detayı:', errorText);
                    return;
                }
                
                const result = await response.json();
                console.log('[RAPOR] Şablon listesi response:', result);
                
                // Temizle (İlk option hariç)
                select.innerHTML = '<option value="">-- Şablon Seç --</option>';
                
                if (result && result.status === 'success' && result.data && Array.isArray(result.data)) {
                    console.log('[RAPOR] Şablon sayısı:', result.data.length);
                    if (result.data.length === 0) {
                        console.warn('[RAPOR] Şablon listesi boş!');
                    } else {
                        result.data.forEach(sablon => {
                            const opt = document.createElement('option');
                            opt.value = sablon.id;
                            opt.textContent = sablon.ad || `Şablon #${sablon.id}`;
                            if (sablon.ayarlar) {
                                opt.dataset.ayarlar = JSON.stringify(sablon.ayarlar);
                            }
                            select.appendChild(opt);
                            console.log('[RAPOR] Şablon eklendi:', sablon.ad, sablon.id);
                        });
                    }
                } else {
                    console.error('[RAPOR] Şablon verisi yok veya başarısız:', result);
                    console.error('[RAPOR] Response yapısı:', {
                        hasResult: !!result,
                        status: result?.status,
                        hasData: !!result?.data,
                        dataType: Array.isArray(result?.data) ? 'array' : typeof result?.data,
                        dataLength: Array.isArray(result?.data) ? result.data.length : 'N/A'
                    });
                }
            } catch (error) {
                console.error("[RAPOR] Şablon listesi yüklenemedi:", error);
            }
        }

        // Yeni Şablon Kaydet
        async function saveNewPreset() {
            if (!gridApi) return;
            const presetSelect = document.getElementById('presetSelect');
            const selectedPresetId = (presetSelect && presetSelect.value) ? presetSelect.value.trim() : "";
            const typedName = document.getElementById('newPresetName').value.trim();

            // Eğer comboda seçili şablon varsa, "kaydet" işlemi varsayılan olarak overwrite anlamına gelir.
            // Kullanıcıya seçim sor.
            if (selectedPresetId) {
                const selectedOption = presetSelect.options[presetSelect.selectedIndex];
                const selectedName = selectedOption.textContent;
                openPresetModal(selectedPresetId, selectedName, typedName);
                return;
            }

            const name = typedName;
            if (!name) {
                alert("Lütfen bir rapor adı girin!");
                return;
            }

            const success = await savePresetByName(name);
            if (success) {
                document.getElementById('newPresetName').value = '';
                await updatePresetList();
                // Yeni kaydedilen şablonu seç
                const select = document.getElementById('presetSelect');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].textContent === name) {
                        select.value = select.options[i].value;
                        break;
                    }
                }
                alert(`"${name}" şablonu başarıyla kaydedildi!`);
            }
        }

        async function savePresetByName(name, sablonId = null) {
            // Tam sütun state'i (genişlik, pinned, flex, hide, sort, rowGroup, pivot, aggFunc vb.)
            let columnState = gridApi.getColumnState();
            // Hücre biçimlendirmesi (cellClass) getColumnState'ta gelmeyebilir; her sütundan ekle (sadece string/array)
            const allCols = gridApi.getColumns();
            if (allCols && columnState) {
                columnState = columnState.map(cs => {
                    const col = allCols.find(c => c.getColId() === cs.colId);
                    let cellClass = col && col.getColDef() ? col.getColDef().cellClass : undefined;
                    if (typeof cellClass === 'function') cellClass = undefined;
                    const out = { ...cs };
                    if (cellClass != null) out.cellClass = cellClass;
                    return out;
                });
            }
            const state = {
                columnState: columnState,
                filterModel: gridApi.getFilterModel(),
                pivotMode: gridApi.isPivotMode(),
                isExpanded: isExpandedGlobal,
                decimalPlaces: decimalPlacesGlobal,
                paginationPageSize: gridApi.getGridOption('paginationPageSize') || 100
            };

            try {
                const token = localStorage.getItem('token');
                
                // Kontroller
                if (!token) {
                    console.error('[RAPOR] Token bulunamadı!');
                    alert('Oturum bulunamadı. Lütfen tekrar giriş yapın.');
                    return false;
                }
                
                if (!currentUser || !currentUser.firma_id) {
                    console.error('[RAPOR] currentUser bilgisi eksik:', currentUser);
                    alert('Kullanıcı bilgisi eksik. Lütfen sayfayı yenileyin.');
                    return false;
                }
                
                console.log('[RAPOR] Şablon kaydediliyor:', {
                    name,
                    firma_id: currentUser.firma_id,
                    sablonId: sablonId || 'yeni',
                    state
                });
                
                let response;
                
                if (sablonId) {
                    // Güncelleme
                    console.log('[RAPOR] PUT isteği gönderiliyor:', `${API_URL}/admin/rapor-sablonu/${sablonId}`);
                    response = await fetch(`${API_URL}/admin/rapor-sablonu/${sablonId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ad: name, ayarlar: state })
                    });
                } else {
                    // Yeni kayıt
                    const requestData = {
                        firma_id: currentUser.firma_id,
                        ad: name,
                        ayarlar: state,
                        rapor_tipi: 'ag_grid'
                    };
                    console.log('[RAPOR] POST isteği gönderiliyor:', `${API_URL}/admin/rapor-sablonu`);
                    console.log('[RAPOR] Request data:', requestData);
                    
                    response = await fetch(`${API_URL}/admin/rapor-sablonu`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                }
                
                console.log('[RAPOR] Response status:', response.status, response.statusText);
                
                const result = await response.json();
                console.log('[RAPOR] Response data:', result);
                
                if (result.status === 'success') {
                    console.log('[RAPOR] ✓ Şablon başarıyla kaydedildi');
                    return true;
                } else {
                    console.error('[RAPOR] Kayıt başarısız:', result);
                    alert(result.detail || 'Şablon kaydedilemedi');
                    return false;
                }
            } catch (error) {
                console.error("[RAPOR] Şablon kaydetme hatası:", error);
                console.error("[RAPOR] Hata detayı:", error.stack);
                alert("Şablon kaydedilemedi: " + error.message);
                return false;
            }
        }

        // --- Şablon overwrite / save-as modal yönetimi ---
        let __presetModalSelectedId = "";
        let __presetModalSelectedName = "";
        function openPresetModal(selectedPresetId, selectedPresetName, typedName) {
            __presetModalSelectedId = selectedPresetId || "";
            __presetModalSelectedName = selectedPresetName || "";
            const modal = document.getElementById('presetOverwriteModal');
            const text = document.getElementById('presetOverwriteText');
            const input = document.getElementById('presetOverwriteNewName');
            if (!modal || !text || !input) return;

            text.innerText = `"${__presetModalSelectedName}" şablonu zaten kayıtlı. Ne yapmak istiyorsunuz?`;
            input.value = (typedName && typedName !== __presetModalSelectedName) ? typedName : "";
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 0);
        }

        function closePresetModal() {
            const modal = document.getElementById('presetOverwriteModal');
            if (modal) modal.style.display = 'none';
        }

        async function presetModalOverwrite() {
            if (!__presetModalSelectedId) {
                closePresetModal();
                return;
            }
            const success = await savePresetByName(__presetModalSelectedName, __presetModalSelectedId);
            if (success) {
                await updatePresetList();
                document.getElementById('presetSelect').value = __presetModalSelectedId;
                document.getElementById('newPresetName').value = '';
                closePresetModal();
                alert(`"${__presetModalSelectedName}" şablonu güncellendi!`);
            }
        }

        async function presetModalSaveAsNew() {
            const input = document.getElementById('presetOverwriteNewName');
            const newName = input ? input.value.trim() : "";
            if (!newName) {
                alert("Lütfen yeni şablon için bir isim girin!");
                return;
            }
            const success = await savePresetByName(newName);
            if (success) {
                await updatePresetList();
                // Yeni kaydedilen şablonu seç
                const select = document.getElementById('presetSelect');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].textContent === newName) {
                        select.value = select.options[i].value;
                        break;
                    }
                }
                document.getElementById('newPresetName').value = '';
                closePresetModal();
                alert(`"${newName}" şablonu başarıyla kaydedildi!`);
            }
        }

        // Varsayılan durum filtresi: sadece "Bitti" (başlangıçta ve şablon seçilmediğinde)
        function applyDefaultDurumFilter() {
            if (!gridApi) return;
            gridApi.setFilterModel({ Durum: { filterType: 'set', values: ['Bitti'] } });
        }

        // Şablon Yükle
        function loadPreset(sablonId) {
            if (!gridApi) return;
            if (!sablonId) {
                applyDefaultDurumFilter();
                return;
            }
            
            const select = document.getElementById('presetSelect');
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.ayarlar) return;
            
            const state = JSON.parse(selectedOption.dataset.ayarlar);

            if (state) {
                const applyColumnStateOnly = () => {
                    if (!state.columnState || state.columnState.length === 0) return;
                    gridApi.applyColumnState({ state: state.columnState, applyOrder: true });
                    const cellClassUpdates = state.columnState
                        .filter(cs => cs.cellClass != null)
                        .map(cs => ({ colId: cs.colId, cellClass: cs.cellClass }));
                    if (cellClassUpdates.length) gridApi.updateColumnDefs(cellClassUpdates);
                };

                // Sütun state'ini hemen uygula (genişlik, pinned, flex, hide, sort vb.)
                applyColumnStateOnly();
                // Grid bazen sütunları sonradan yeniden çiziyor; genişliklerin kalıcı olması için kısa süre sonra tekrar uygula
                setTimeout(applyColumnStateOnly, 280);

                if (state.filterModel != null) gridApi.setFilterModel(state.filterModel);
                if (state.pivotMode !== undefined) gridApi.setGridOption('pivotMode', state.pivotMode);

                // Sayfa başına satır sayısı
                if (state.paginationPageSize != null) {
                    gridApi.setGridOption('paginationPageSize', state.paginationPageSize);
                }

                // Ondalık basamak
                if (state.decimalPlaces !== undefined) {
                    decimalPlacesGlobal = state.decimalPlaces;
                }

                // Grup açık/kapalı
                if (state.isExpanded) {
                    setTimeout(() => gridApi.expandAll(), 200);
                    isExpandedGlobal = true;
                } else {
                    setTimeout(() => gridApi.collapseAll(), 200);
                    isExpandedGlobal = false;
                }

                // Hücreleri yeniden çiz (cellClass vb. için)
                gridApi.refreshCells({ force: true });
                localStorage.setItem(`ag_grid_last_preset_${currentUser.firma_id}`, sablonId);
            }
        }

        // Grup İşlemleri
        function expandAllGroups() {
            if (!gridApi) return;
            gridApi.expandAll();
            isExpandedGlobal = true;
        }

        function collapseAllGroups() {
            if (!gridApi) return;
            gridApi.collapseAll();
            isExpandedGlobal = false;
        }

        // Hücre Ayarları
        function setDecimalPlaces(n) {
            decimalPlacesGlobal = n;
            if (gridApi) {
                gridApi.refreshCells({ force: true });
            }
        }

        // Şablon Sil
        async function deletePreset() {
            const sablonId = document.getElementById('presetSelect').value;
            if (!sablonId) return;

            const select = document.getElementById('presetSelect');
            const selectedOption = select.options[select.selectedIndex];
            const sablonAdi = selectedOption.textContent;

            if (confirm(`"${sablonAdi}" şablonunu silmek istediğinize emin misiniz?`)) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_URL}/admin/rapor-sablonu/${sablonId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        await updatePresetList();
                        document.getElementById('presetSelect').value = '';
                        alert("Şablon silindi.");
                    } else {
                        alert(result.detail || 'Şablon silinemedi');
                    }
                } catch (error) {
                    console.error("Şablon silme hatası:", error);
                    alert("Şablon silinemedi: " + error.message);
                }
            }
        }

        // Grafik Oluştur (Otomatik Görünüm Bazlı)
        function createDefaultChart() {
            if (!gridApi) return;

            // Ekranda o an görünür olan tüm sütun kimliklerini (ID) al
            const visibleCols = gridApi.getAllDisplayedColumns().map(col => col.getColId());

            if (gridApi.isPivotMode()) {
                // Pivot modundaysa mevcut özet tabloyu grafiğe dök
                gridApi.createPivotChart({
                    chartType: 'groupedColumn'
                });
            } else {
                // Normal moddaysa, herhangi bir seçim yapılmasına gerek kalmadan 
                // ekrandaki tüm satır ve sütunları kapsayan aralık grafiği oluştur
                gridApi.createRangeChart({
                    chartType: 'groupedColumn',
                    cellRange: {
                        columns: visibleCols
                    },
                    suppressChartRanges: false // Grafik aralıklarını tabloda renklendir (görsel takip için)
                });
            }
        }

        async function loadData() {
            if (!gridApi) return;
            try {
                const range = document.getElementById('timeRange').value;
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/admin/reports/${currentUser.firma_id}?report_type=transaction_log&time_range=${range}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                const data = result.data || [];

                const mappedData = data.map(r => {
                    const rawDate = r.tarih || "";
                    let year = "---", month = "---", dayOfMonth = "---", dayOfWeek = "---", weekOfYear = "---";

                    if (rawDate && rawDate.includes('.')) {
                        const parts = rawDate.split('.');
                        if (parts.length === 3) {
                            const d = parseInt(parts[0]);
                            const m = parseInt(parts[1]) - 1;
                            const y = parseInt(parts[2]);
                            const dateObj = new Date(y, m, d);

                            if (!isNaN(dateObj.getTime())) {
                                year = String(y);
                                month = dateObj.toLocaleString('tr-TR', { month: 'long' });
                                dayOfMonth = String(d);
                                dayOfWeek = dateObj.toLocaleString('tr-TR', { weekday: 'long' });

                                // Hafta Numarası Hesaplama
                                const startOfYear = new Date(y, 0, 1);
                                const diff = dateObj - startOfYear;
                                const oneDay = 1000 * 60 * 60 * 24;
                                weekOfYear = "Hafta " + Math.ceil((diff / oneDay + startOfYear.getDay() + 1) / 7);
                            }
                        }
                    }

                    return {
                        "Tarih": rawDate,
                        "Yıl": year,
                        "Ay": month,
                        "Gün": dayOfMonth,
                        "Haftanın Günü": dayOfWeek,
                        "Yılın Haftası": weekOfYear,
                        "Saat": r.saat || "??",
                        "Bölüm": r.servis || "---",
                        "Kuyruk": r.kuyruk || "---",
                        "Personel": r.personel || "---",
                        "Durum": r.durum === 'completed' ? 'Bitti' : r.durum === 'calling' ? 'Çağrıda' : 'Beklemede',
                        "Bekleme (dk)": parseFloat(r.bekleme) || 0,
                        "İşlem (dk)": parseFloat(r.islem) || 0,
                        "Bilet Adet": 1,
                        "Puanlama Oranı": parseFloat(r.puanlama_orani) || 0,
                        "Ortalama Puan": parseFloat(r.ortalama_puan) || 0
                    };
                });

                gridApi.setGridOption('rowData', mappedData);

                // Başlangıçta her zaman durum = Bitti filtresi uygula (veri ilk geldiğinde)
                applyDefaultDurumFilter();

                // Şablon listesini güncelle ve gerekirse son şablonu yükle
                if (!window.layoutLoaded) {
                    await updatePresetList();
                    const lastPresetId = localStorage.getItem(`ag_grid_last_preset_${currentUser.firma_id}`);
                    if (lastPresetId) {
                        document.getElementById('presetSelect').value = lastPresetId;
                        setTimeout(() => loadPreset(lastPresetId), 150);
                    }

                    const savedRange = localStorage.getItem('ag_grid_time_range');
                    if (savedRange) document.getElementById('timeRange').value = savedRange;

                    window.layoutLoaded = true;
                } else {
                    // Yenileme sonrası şablon seçili değilse varsayılan durum filtresini uygula
                    if (!document.getElementById('presetSelect').value) {
                        applyDefaultDurumFilter();
                    }
                }

                // Eğer aktif şablon yoksa sütunları sığdır
                if (!document.getElementById('presetSelect').value) {
                    setTimeout(() => gridApi.sizeColumnsToFit(), 200);
                }
            } catch (e) {
                console.error("Data Load Error", e);
            }
        }

        function onBtExport() {
            if (gridApi) gridApi.exportDataAsExcel();
        }
        // PDF Olarak Yeni Sekmede Aç (Önizleme)
        function exportToPDF() {
            if (!gridApi) return;

            try {
                // Popup blocker'a takılmamak için sekmeyi kullanıcı tıklaması anında aç
                // (PDF hazır olunca bu sekmeyi blob URL'e yönlendireceğiz)
                let preOpenedWin = null;
                try {
                    preOpenedWin = window.open('', '_blank');
                    if (preOpenedWin) {
                        preOpenedWin.document.open();
                        preOpenedWin.document.write(`
                            <!doctype html>
                            <html lang="tr">
                            <head>
                              <meta charset="utf-8" />
                              <meta name="viewport" content="width=device-width, initial-scale=1" />
                              <title>PDF Hazırlanıyor...</title>
                              <style>
                                body{font-family: Arial, sans-serif; margin:0; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; height:100vh;}
                                .box{max-width:520px; padding:24px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:12px;}
                                h1{font-size:18px; margin:0 0 8px 0;}
                                p{margin:0; opacity:0.85; font-size:13px; line-height:1.5;}
                                .row{display:flex; gap:12px; align-items:center; margin-top:14px;}
                                .spinner{width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,0.25); border-top-color:#fff; animation:spin 0.9s linear infinite;}
                                @keyframes spin{to{transform:rotate(360deg);}}
                                .small{font-size:12px; opacity:0.9; margin-top:10px;}
                                .bar{height:8px; background:rgba(255,255,255,0.12); border-radius:999px; overflow:hidden; margin-top:10px;}
                                .bar > div{height:100%; width:0%; background:#60a5fa;}
                              </style>
                            </head>
                            <body>
                              <div class="box">
                                <h1>PDF hazırlanıyor...</h1>
                                <p>Rapor büyükse bu işlem biraz sürebilir. Sekmeyi kapatmayın.</p>
                                <div class="row">
                                  <div class="spinner" aria-label="Yükleniyor"></div>
                                  <div id="pdfProgressText">Başlatılıyor...</div>
                                </div>
                                <div class="bar"><div id="pdfProgressBar"></div></div>
                                <div class="small" id="pdfProgressDetail"> </div>
                              </div>
                            </body>
                            </html>
                        `);
                        preOpenedWin.document.close();
                    }
                } catch (e) {
                    preOpenedWin = null;
                }

                const updateProgressUI = (current, total) => {
                    const pct = total > 0 ? Math.round((current / total) * 100) : 0;
                    const txt = `PDF hazırlanıyor... (${current}/${total})`;
                    // Ana sayfadaki overlay
                    try {
                        if (window.__pdfOverlayEl) {
                            window.__pdfOverlayEl.querySelector('#_txt').innerText = txt;
                            window.__pdfOverlayEl.querySelector('#_bar').style.width = `${pct}%`;
                        }
                    } catch (e) { }
                    // Önceden açılan sekme (aynı origin olduğu için DOM güncelleyebiliriz)
                    try {
                        if (preOpenedWin && !preOpenedWin.closed) {
                            const t = preOpenedWin.document.getElementById('pdfProgressText');
                            const b = preOpenedWin.document.getElementById('pdfProgressBar');
                            const d = preOpenedWin.document.getElementById('pdfProgressDetail');
                            if (t) t.innerText = txt;
                            if (b) b.style.width = `${pct}%`;
                            if (d) d.innerText = pct ? `%${pct}` : '';
                        }
                    } catch (e) { }
                };

                // --- STERİL SÜTUN VE VERİ HAZIRLIĞI ---
                const displayedCols = gridApi.getAllDisplayedColumns() || [];
                const exportColumns = [];
                const columnIdsRaw = [];

                displayedCols.forEach((col, index) => {
                    const id = col.getColId();
                    const def = col.getColDef();
                    let hName = def.headerName || id || "Sütun " + (index + 1);

                    if (id === 'ag-Grid-AutoColumn') hName = "GRUP / DETAY";

                    if (hName && !id.includes('selection')) {
                        exportColumns.push(String(hName).trim());
                        columnIdsRaw.push(id);
                    }
                });

                // Sütun sayısı kontrolü - çok fazla sütun varsa uyar
                if (exportColumns.length > 15) {
                    if (!confirm(`${exportColumns.length} sütun var. PDF oluşturma işlemi uzun sürebilir veya başarısız olabilir. Devam etmek istiyor musunuz?`)) {
                        return;
                    }
                }

                const dataBody = [];
                const decPlaces = (typeof decimalPlacesGlobal !== 'undefined') ? decimalPlacesGlobal : 2;

                // Sadece ekranda görünen satırları al (rendered nodes)
                // forEachNodeAfterFilterAndSort tüm node'ları gezer, biz sadece displayed olanları istiyoruz
                const displayedRowCount = gridApi.getDisplayedRowCount();
                for (let i = 0; i < displayedRowCount; i++) {
                    const node = gridApi.getDisplayedRowAtIndex(i);
                    if (!node) continue;
                    
                    const row = [];
                    columnIdsRaw.forEach(id => {
                        let value = "";
                        // Hiyerarşik Veri Okuma (Grup/Pivot/Normal)
                        if (id === 'ag-Grid-AutoColumn') {
                            value = node.key || "";
                        } else {
                            if (node.groupData && node.groupData[id] !== undefined) value = node.groupData[id];
                            else if (node.aggData && node.aggData[id] !== undefined) value = node.aggData[id];
                            else if (node.data && node.data[id] !== undefined) value = node.data[id];
                        }

                        // Sayısal değerleri formatla (hem number hem de string içinde sayı olanları)
                        if (typeof value === 'number' || (!isNaN(parseFloat(value)) && isFinite(value))) {
                            const numVal = typeof value === 'number' ? value : parseFloat(value);
                            value = new Intl.NumberFormat('tr-TR', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: decPlaces
                            }).format(numVal);
                        }

                        // Width hatasını engellemek için her zaman string ve temiz veri
                        let str = String(value != null ? value : "").trim();
                        // Gizli karakterleri ve sembolleri temizle, çok uzun metinleri kısalt
                        str = str.replace(/[^\x20-\x7E\u00C0-\u017F\s]/g, "");
                        // NBSP gibi boşlukları normalize et (bazı kaynaklarda harfler arası boşluk olarak gelebiliyor)
                        str = str.replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
                        // Çok uzun metinleri kısalt (100 karakter limit)
                        if (str.length > 100) {
                            str = str.substring(0, 97) + "...";
                        }
                        row.push(str);
                    });
                    dataBody.push(row);
                }

                if (dataBody.length === 0) {
                    alert("Tabloda dışa aktarılacak veri bulunamadı.");
                    return;
                }

                // --- PDF OLUŞTURMA (Paged HTML2Canvas -> jsPDF) ---
                // Uzun tabloları tek dev canvas yapmak Chrome'da boş PDF sorununa yol açabiliyor.
                // Sayfalara bölüp her sayfayı ayrı render ederek hem Türkçe karakterleri hem stabiliteyi koruyoruz.
                const jsPDFLib = window.jspdf ? window.jspdf.jsPDF : (typeof jsPDF !== 'undefined' ? jsPDF : null);
                const canHtml2Canvas = (typeof window.html2canvas !== 'undefined');
                if (jsPDFLib && canHtml2Canvas) {
                    const overlay = document.createElement('div');
                    overlay.style.position = 'fixed';
                    overlay.style.left = '0';
                    overlay.style.top = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.background = 'rgba(15, 23, 42, 0.55)';
                    // Overlay mutlaka render konteynerinin ÜSTÜNDE olmalı ki kullanıcı tabloyu görmesin
                    overlay.style.zIndex = '1000001';
                    overlay.style.display = 'flex';
                    overlay.style.alignItems = 'center';
                    overlay.style.justifyContent = 'center';
                    overlay.style.fontFamily = "'Inter', Arial, sans-serif";
                    overlay.style.color = '#ffffff';
                    overlay.style.fontWeight = '700';
                    overlay.innerHTML = `
                        <div style="width: min(520px, calc(100vw - 32px)); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 18px 18px;">
                          <div style="display:flex; gap:12px; align-items:center;">
                            <div style="width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,0.25); border-top-color:#fff; animation: _spin 0.9s linear infinite;"></div>
                            <div id="_txt">PDF hazırlanıyor...</div>
                          </div>
                          <div style="height:8px; background: rgba(255,255,255,0.12); border-radius:999px; overflow:hidden; margin-top:10px;">
                            <div id="_bar" style="height:100%; width:0%; background:#60a5fa;"></div>
                          </div>
                          <style>@keyframes _spin { to { transform: rotate(360deg); } }</style>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                    // progress updater için referans
                    window.__pdfOverlayEl = overlay;

                    const container = document.createElement('div');
                    container.style.position = 'fixed';
                    container.style.left = '0';
                    container.style.top = '0';
                    // Render konteyneri overlay'in altında kalsın (yine de canvas render edilir)
                    container.style.zIndex = '1000000';
                    container.style.background = '#ffffff';
                    container.style.width = '1122px'; // approx A4 landscape @96dpi
                    container.style.padding = '24px';
                    container.style.fontFamily = "'Inter', Arial, sans-serif";
                    container.style.color = '#0f172a';
                    container.style.pointerEvents = 'none';
                    document.body.appendChild(container);

                    const waitFonts = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();

                    (async () => {
                        try {
                            await waitFonts;

                            const doc = new jsPDFLib({ orientation: 'landscape', unit: 'pt', format: 'a4', compress: true });
                            const pageWidth = doc.internal.pageSize.getWidth();
                            const pageHeight = doc.internal.pageSize.getHeight();

                            // Render ayarları
                            const rowsPerPage = 45; // daha düşük = daha stabil
                            const totalPages = Math.max(1, Math.ceil(dataBody.length / rowsPerPage));

                            for (let page = 0; page < totalPages; page++) {
                                container.innerHTML = '';

                                const title = document.createElement('div');
                                title.style.fontSize = '16px';
                                title.style.fontWeight = '800';
                                title.style.marginBottom = '6px';
                                title.innerText = "RAPOR ÖNİZLEME - SIRAMATİK";

                                const dateInfo = document.createElement('div');
                                dateInfo.style.fontSize = '11px';
                                dateInfo.style.color = '#334155';
                                dateInfo.style.marginBottom = '12px';
                                dateInfo.innerText = `Tarih: ${new Date().toLocaleString('tr-TR')}  |  Sayfa: ${page + 1}/${totalPages}`;

                                const table = document.createElement('table');
                                table.style.width = '100%';
                                table.style.borderCollapse = 'collapse';
                                table.style.tableLayout = 'fixed';
                                table.style.fontSize = exportColumns.length > 12 ? '8px' : '9px';

                                const thead = document.createElement('thead');
                                const trh = document.createElement('tr');
                                exportColumns.forEach(h => {
                                    const th = document.createElement('th');
                                    th.innerText = h;
                                    th.style.background = '#0f172a';
                                    th.style.color = '#ffffff';
                                    th.style.border = '1px solid #cbd5e1';
                                    th.style.padding = '6px';
                                    th.style.textAlign = 'left';
                                    th.style.wordBreak = 'break-word';
                                    trh.appendChild(th);
                                });
                                thead.appendChild(trh);
                                table.appendChild(thead);

                                const tbody = document.createElement('tbody');
                                const start = page * rowsPerPage;
                                const end = Math.min(dataBody.length, start + rowsPerPage);
                                for (let i = start; i < end; i++) {
                                    const r = dataBody[i];
                                    const tr = document.createElement('tr');
                                    r.forEach(cell => {
                                        const td = document.createElement('td');
                                        td.innerText = cell;
                                        td.style.border = '1px solid #e2e8f0';
                                        td.style.padding = '5px';
                                        td.style.verticalAlign = 'top';
                                        td.style.wordBreak = 'break-word';
                                        
                                        // Sayısal değerleri sağa hizala
                                        const cleanCell = String(cell).replace(/\./g, '').replace(',', '.').replace(/\s/g, '');
                                        if (cleanCell && !isNaN(cleanCell) && cleanCell !== '') {
                                            td.style.textAlign = 'right';
                                        } else {
                                            td.style.textAlign = 'left';
                                        }
                                        
                                        tr.appendChild(td);
                                    });
                                    tbody.appendChild(tr);
                                }
                                table.appendChild(tbody);

                                container.appendChild(title);
                                container.appendChild(dateInfo);
                                container.appendChild(table);

                                updateProgressUI(page + 1, totalPages);

                                const canvas = await window.html2canvas(container, {
                                    scale: 1.5,
                                    useCORS: true,
                                    backgroundColor: '#ffffff',
                                    scrollX: 0,
                                    scrollY: 0
                                });

                                const imgData = canvas.toDataURL('image/jpeg', 0.92);
                                const imgWidth = pageWidth;
                                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                                if (page > 0) doc.addPage();
                                doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
                            }

                            const blob = doc.output('blob');
                            const url = URL.createObjectURL(blob);
                            window.__lastExportedPdfUrl = url;
                            if (preOpenedWin && !preOpenedWin.closed) {
                                preOpenedWin.location.href = url;
                            } else {
                                window.open(url, '_blank');
                            }
                        } catch (e) {
                            console.error("Paged PDF Error:", e);
                            alert(`PDF oluşturulamadı: ${e.message || e}`);
                        } finally {
                            if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                            if (window.__pdfOverlayEl === overlay) window.__pdfOverlayEl = null;
                            if (container && container.parentNode) container.parentNode.removeChild(container);
                        }
                    })();

                    return;
                }

                // html2pdf yoksa eski yöntem (jsPDF) fallback
                const jsPDFLibFallback = window.jspdf ? window.jspdf.jsPDF : (typeof jsPDF !== 'undefined' ? jsPDF : null);
                if (!jsPDFLibFallback) {
                    alert("PDF kütüphanesi yüklenemedi.");
                    return;
                }

                const doc = new jsPDFLibFallback('l', 'pt', 'a4');
                doc.setFont('helvetica');
                doc.setFontSize(14);
                doc.text("RAPOR ONIZLEME - SIRAMATIK", 30, 40);
                doc.setFontSize(9);
                doc.text(`Tarih: ${new Date().toLocaleString('tr-TR')}`, 30, 55);

                doc.autoTable({
                    head: [exportColumns],
                    body: dataBody,
                    startY: 70,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: exportColumns.length > 12 ? 6 : 7, cellPadding: 2, overflow: 'linebreak' },
                    headStyles: { fillColor: [15, 23, 42], textColor: [255, 255, 255] },
                    margin: { left: 30, right: 30 },
                    tableWidth: 'auto'
                });

                const blobUrl = doc.output('bloburl');
                window.open(blobUrl, '_blank');

            } catch (err) {
                console.error("PDF Fatal Error:", err);
                console.error("Error Details:", {
                    message: err.message,
                    stack: err.stack,
                    name: err.name
                });
                alert(`PDF oluşturulamadı: ${err.message}\n\nLütfen:\n1. Bazı sütunları kapatarak tabloyu sadeleştirin\n2. Sayfayı yenileyip tekrar deneyin\n3. Tarayıcı konsolunu kontrol edin`);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const gridDiv = document.querySelector('#myGrid');
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
            // Şablon listesini hemen yükle
            await updatePresetList();
            loadData();
        });
    </script>
</body>

</html>