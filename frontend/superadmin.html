<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼per Admin Paneli - SÄ±ramatik Sistem YÃ¶netimi</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%236366f1' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'>S</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent-primary: #f59e0b;
            /* AltÄ±n/Turuncu - Sistem rengi */
            --accent-secondary: #d97706;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            background-image: radial-gradient(circle at top right, rgba(245, 158, 11, 0.1), transparent),
                radial-gradient(circle at bottom left, rgba(217, 119, 6, 0.05), transparent);
        }

        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 40px;
            color: var(--accent-primary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-primary);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 40px rgba(245, 158, 11, 0.2);
        }

        .welcome-text h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .welcome-text p {
            opacity: 0.9;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            padding: 24px;
            border-radius: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: var(--text-muted);
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .section-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .btn-plus {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px;
            color: var(--text-muted);
            font-weight: 500;
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 18px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            text-transform: uppercase;
        }

        .role-badge {
            background: #3b82f6;
            color: white;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1e293b;
            padding: 35px;
            border-radius: 24px;
            width: 600px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--glass-border);
            padding: 12px 16px;
            border-radius: 12px;
            color: white;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            border-color: var(--accent-primary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
        }

        .info-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--accent-primary);
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
            color: var(--accent-primary);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .tr-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Loading Spinner */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(245, 158, 11, 0.1);
            border-left-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loader-text {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body onload="init()">
    <div id="connection-badges" class="connection-badges" title="W: WebSocket, P: Polling" style="position:fixed;top:8px;right:8px;display:flex;gap:4px;z-index:10000;">
        <span id="connection-w" class="connection-badge inactive" title="WebSocket" style="width:20px;height:20px;min-width:20px;min-height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;color:#fff;">W</span>
        <span id="connection-p" class="connection-badge inactive" title="Polling" style="width:20px;height:20px;min-width:20px;min-height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;color:#fff;">P</span>
    </div>
    <div id="page-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">SÄ°STEM YÃœKLENÄ°YOR...</div>
    </div>
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-crown"></i>
            <span>SÃœPER ADMÄ°N</span>
        </div>
        <nav id="super-nav">
            <div class="nav-item active" onclick="showView('dashboard')"><i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-item" onclick="showView('firmalar')"><i class="fas fa-building"></i> Firmalar</div>
            <div class="nav-item" onclick="showView('kullanicilar')"><i class="fas fa-users-cog"></i> Sistem
                KullanÄ±cÄ±larÄ±</div>
            <div class="nav-item" onclick="alert('YakÄ±nda...')"><i class="fas fa-cogs"></i> Global Ayarlar</div>
            <div class="nav-item" onclick="alert('YakÄ±nda...')"><i class="fas fa-database"></i> Yedekleme</div>
        </nav>
        <div style="margin-top: auto;">
            <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ Yap</div>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <h2 id="view-title">Sistem Ã–zeti</h2>
            <div id="user-info" style="display:flex; align-items:center; gap:10px;">
                <span id="admin-name" style="font-weight:600;">SÃ¼per Admin</span>
                <div
                    style="width:40px; height:40px; background:var(--accent-primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                    <i class="fas fa-user-shield"></i>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-container">
            <div class="welcome-card">
                <div class="welcome-text">
                    <h1>HoÅŸ Geldiniz, <span id="welcome-name">SÃ¼per Admin</span></h1>
                    <p>SÄ±ramatik sistemindeki tÃ¼m firmalarÄ± ve global yapÄ±landÄ±rmalarÄ± buradan yÃ¶netebilirsiniz.</p>
                </div>
                <i class="fas fa-rocket" style="font-size: 80px; opacity: 0.3;"></i>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Toplam Firma</h3>
                    <div class="value" id="stat-firmalar">...</div>
                </div>
                <div class="stat-card">
                    <h3>Aktif Kuyruklar</h3>
                    <div class="value" id="stat-kuyruklar">...</div>
                </div>
                <div class="stat-card">
                    <h3>Sistem Versiyonu</h3>
                    <div class="value">v1.2.0-PRO</div>
                </div>
                <div class="stat-card">
                    <h3>Lisans Durumu</h3>
                    <div class="value"><span class="status-badge">SINIRSIZ</span></div>
                </div>
            </div>

            <div class="info-box">
                <i class="fas fa-info-circle" style="font-size: 24px;"></i>
                <div>
                    <strong>SÃ¼per Admin Modu Aktif:</strong>
                    Bu panel sadece tÃ¼m firmalarÄ± gÃ¶rebilen Ã¶zel yetkili kullanÄ±cÄ±lara aÃ§Ä±ktÄ±r.
                    Yeni kurulumlar ve sistem geneli bakÄ±mlar iÃ§in bu ekranÄ± kullanÄ±n.
                </div>
            </div>
        </div>

        <!-- Firmalar View -->
        <div id="view-firmalar" class="view-container" style="display:none;">
            <div class="section-card">
                <div class="section-header">
                    <h3>KayÄ±tlÄ± Firmalar</h3>
                    <button class="btn-plus" onclick="openFirmaModal()">
                        <i class="fas fa-plus"></i> Yeni Firma TanÄ±mla
                    </button>
                </div>
                <table id="firmalar-table">
                    <thead>
                        <tr>
                            <th>Firma AdÄ±</th>
                            <th>SektÃ¶r</th>
                            <th>E. Åžifresi</th>
                            <th>SÃ¶zleÅŸme BitiÅŸ</th>
                            <th>Servis AlÄ±mÄ±</th>
                            <th>Fatura Adresi</th>
                            <th>Durum</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="firmalar-body">
                        <tr>
                            <td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">
                                YÃ¼kleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- KullanÄ±cÄ±lar View -->
        <div id="view-kullanicilar" class="view-container" style="display:none;">
            <div class="section-card">
                <div class="section-header">
                    <h3>Sistem KullanÄ±cÄ±larÄ±</h3>
                    <button class="btn-plus" onclick="openUserModal()">
                        <i class="fas fa-user-plus"></i> Yeni KullanÄ±cÄ± Ekle
                    </button>
                </div>
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Ad Soyad</th>
                            <th>KullanÄ±cÄ± AdÄ±</th>
                            <th>Rol</th>
                            <th>BaÄŸlÄ± Firma</th>
                            <th>Durum</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="users-body">
                        <tr>
                            <td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">
                                YÃ¼kleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Yeni KullanÄ±cÄ± TanÄ±mla</h2>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ad Soyad</label>
                        <input type="text" id="user-ad-soyad" required oninput="autoGenerateUsername(this.value)">
                    </div>
                    <div class="form-group">
                        <label>Ekran Ä°smi (TV/Kiosk'ta gÃ¶rÃ¼nÃ¼r)</label>
                        <input type="text" id="user-ekran-ismi" required
                            placeholder="Cihaz ekranlarÄ±nda gÃ¶rÃ¼necek isim">
                        <small style="color:var(--text-muted); font-size:11px;">GÃ¼venlik iÃ§in gerÃ§ek isimden farklÄ±
                            olabilir. Ã–rn: ALPER ATASOY</small>
                    </div>
                    <div class="form-group">
                        <label>KullanÄ±cÄ± AdÄ±</label>
                        <input type="text" id="user-kullanici-adi" required>
                    </div>
                    <div class="form-group">
                        <label>Email (Opsiyonel)</label>
                        <input type="email" id="user-email">
                    </div>
                    <div class="form-group" id="pwd-group">
                        <label>Åžifre</label>
                        <input type="password" id="user-password" placeholder="Åžifre belirleyin">
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="user-rol" onchange="toggleFirmaSelect(this.value)">
                            <option value="staff">Personel</option>
                            <option value="admin">Firma YÃ¶neticisi</option>
                            <option value="manager">MÃ¼dÃ¼r</option>
                            <option value="superadmin">SÄ°STEM SÃœPER ADMÄ°N</option>
                        </select>
                    </div>
                    <div class="form-group" id="firma-select-group">
                        <label>BaÄŸlÄ± Firma</label>
                        <select id="user-firma-id">
                            <option value="">LÃ¼tfen Firma SeÃ§in</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="user-aktif">
                            <option value="true">Aktif</option>
                            <option value="false">Pasif</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn" onclick="closeUserModal()">Ä°ptal</button>
                    <button type="submit" class="btn-plus">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firma Modal -->
    <div id="firma-modal" class="modal">
        <div class="modal-content">
            <h2 id="firma-modal-title">Firma DÃ¼zenle</h2>
            <form id="firma-form">
                <input type="hidden" id="edit-firma-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Firma AdÄ±</label>
                        <input type="text" id="edit-firma-ad" required oninput="autoGenerateFirmaPassword(this.value)">
                    </div>
                    <div class="form-group">
                        <label>SektÃ¶r</label>
                        <input type="text" id="edit-firma-sektor">
                    </div>
                </div>

                <div class="form-group">
                    <label>Ekran MÃ¼dahale Åžifresi (TV/Kiosk)</label>
                    <div style="display:flex; gap:10px;">
                        <div style="position:relative; flex:1;">
                            <input type="password" id="edit-firma-ekran-sifre" required placeholder="Ã–rn: 153624"
                                style="width:100%; padding-right:35px;">
                            <i class="fas fa-eye"
                                style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--text-muted);"
                                onclick="toggleModalPassword('edit-firma-ekran-sifre', this)"></i>
                        </div>
                        <label style="display:flex; align-items:center; gap:5px; font-size:12px; cursor:pointer;"
                            title="Bu kilitli ise firma admini ÅŸifreyi deÄŸiÅŸtiremez">
                            <input type="checkbox" id="edit-firma-sifre-kilitli" style="width:18px; height:18px;">
                            <i class="fas fa-lock"></i> Kilitli
                        </label>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Lisans Tipi</label>
                        <select id="edit-firma-lisans-tipi">
                            <option value="Kiralama">Kiralama (Abonelik)</option>
                            <option value="SatÄ±n Alma">SatÄ±n Alma (Ã–mÃ¼r Boyu)</option>
                            <option value="Demo">Demo / Deneme</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>SÃ¶zleÅŸme BaÅŸlangÄ±Ã§</label>
                        <input type="date" id="edit-firma-sozlesme-baslangic">
                    </div>
                    <div class="form-group">
                        <label>SÃ¶zleÅŸme BitiÅŸ Tarihi</label>
                        <input type="date" id="edit-firma-sozlesme-bitis" required>
                    </div>
                    <div class="form-group">
                        <label>Servis AlÄ±m Tarihi</label>
                        <input type="date" id="edit-firma-servis-alim-tarihi">
                    </div>
                </div>

                <div class="form-group">
                    <label>Fatura Adresi</label>
                    <textarea id="edit-firma-fatura-adresi"
                        style="width: 100%; height: 70px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--glass-border); border-radius: 12px; color: white; padding: 12px; outline: none; resize: none;"
                        placeholder="Fatura kesim adresi (unvan, adres, vergi no vb.)"></textarea>
                </div>

                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="edit-firma-erteleme-kilitli" style="width:18px; height:18px;">
                        <i class="fas fa-lock"></i> Erteleme kilitli (firma admini erteleme ayarÄ±nÄ± deÄŸiÅŸtiremesin)
                    </label>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Cihaz Limiti (Max Cihaz)</label>
                        <input type="number" id="edit-firma-max-cihaz" value="10" min="1">
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="edit-firma-aktif">
                            <option value="true">Aktif</option>
                            <option value="false">Pasif</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Rakip Ä°nceleme / Notlar</label>
                    <textarea id="edit-firma-rakip-inceleme"
                        style="width: 100%; height: 60px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--glass-border); border-radius: 12px; color: white; padding: 12px; outline: none; resize: none;"
                        placeholder="Rakip analizi veya Ã¶zel notlar"></textarea>
                </div>
                <div class="form-group">
                    <label>Notlar / SÃ¶zleÅŸme DetaylarÄ±</label>
                    <textarea id="edit-firma-notlar"
                        style="width: 100%; height: 80px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--glass-border); border-radius: 12px; color: white; padding: 12px; outline: none; resize: none;"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn" onclick="closeFirmaModal()">Ä°ptal</button>
                    <button type="submit" class="btn-plus">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="static/config.js"></script>
    <script src="static/app.js"></script>
    <script>
        // GÃœVENLÄ°K KONTROLÃœ - Sadece superadmin rolÃ¼ eriÅŸebilir
        const savedToken = localStorage.getItem('token');
        const savedUser = localStorage.getItem('user');

        if (!savedToken || !savedUser) {
            window.location.href = 'index.html';
        } else {
            const user = JSON.parse(savedUser);
            if (user.rol !== 'superadmin') {
                // YanlÄ±ÅŸ rol, kendi sayfasÄ±na yÃ¶nlendir
                const rolePages = {
                    'admin': 'admin.html',
                    'staff': 'personel.html',
                    'dep_manager': 'personel.html',
                    'manager': 'personel.html',
                    'gmy': 'personel.html',
                    'gm': 'personel.html'
                };
                window.location.href = rolePages[user.rol] || 'index.html';
            }
        }

        function showLoading() { document.getElementById('page-loader').style.display = 'flex'; }
        function hideLoading() {
            const loader = document.getElementById('page-loader');
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        }

        let currentUser = null;
        let allFirmalar = [];
        let allUsers = [];

        async function init() {
            showLoading();
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            if (!token || !user || user.rol !== 'superadmin') {
                hideLoading();
                window.location.href = 'index.html';
                return;
            }

            currentUser = user;
            const displayNm = user.ekran_ismi || user.ad_soyad;
            document.getElementById('admin-name').textContent = displayNm;
            document.getElementById('welcome-name').textContent = displayNm;

            try {
                // Ã–n yÃ¼kleme
                await fetchFirmalar();
                showView('dashboard');
            } catch (err) {
                console.error("Init fetch error:", err);
            } finally {
                hideLoading();
            }
        }

        function showView(viewId) {
            // Nav aktifliÄŸi
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Sidebar'daki ilgili nav-item'Ä± aktif yap (text bazlÄ± veya index bazlÄ± basit bir match)
            const views = ['dashboard', 'firmalar', 'kullanicilar'];
            const labels = ['Dashboard', 'Firmalar', 'Sistem KullanÄ±cÄ±larÄ±'];
            const idx = views.indexOf(viewId);
            if (idx !== -1) {
                const navItems = document.querySelectorAll('#super-nav .nav-item');
                if (navItems[idx]) navItems[idx].classList.add('active');
            }

            // View gÃ¶sterimi
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.style.display = 'none';
            });
            document.getElementById('view-' + viewId).style.display = 'block';

            // BaÅŸlÄ±k
            const titles = {
                'dashboard': 'Sistem Ã–zeti',
                'firmalar': 'Firma YÃ¶netimi',
                'kullanicilar': 'Sistem KullanÄ±cÄ±larÄ±'
            };
            document.getElementById('view-title').textContent = titles[viewId];

            // Veriyi tazele
            if (viewId === 'dashboard') loadDashboard();
            if (viewId === 'firmalar') renderFirmalar();
            if (viewId === 'kullanicilar') fetchAndRenderUsers();
        }

        async function fetchFirmalar() {
            try {
                allFirmalar = await apiCall('/admin/all-firmalar');
                const fSelect = document.getElementById('user-firma-id');
                fSelect.innerHTML = '<option value="">LÃ¼tfen Firma SeÃ§in</option>' +
                    allFirmalar.map(f => `<option value="${f.id}">${f.ad}</option>`).join('');
            } catch (err) {
                console.error("Firma yÃ¼kleme hatasÄ±", err);
            }
        }

        function loadDashboard() {
            document.getElementById('stat-firmalar').textContent = allFirmalar.length;
            renderFirmalar();
            checkContracts();
        }

        function checkContracts() {
            const today = new Date();
            const warningLimit = new Date();
            warningLimit.setMonth(today.getMonth() + 2);

            const expiringArr = allFirmalar.filter(f => {
                if (!f.sozlesme_bitis) return false;
                const end = new Date(f.sozlesme_bitis);
                return end <= warningLimit && end >= today;
            });

            const dashboard = document.getElementById('view-dashboard');
            const oldWarning = document.getElementById('contract-warning-box');
            if (oldWarning) oldWarning.remove();

            if (expiringArr.length > 0) {
                const warningBox = document.createElement('div');
                warningBox.id = 'contract-warning-box';
                warningBox.className = 'info-box';
                warningBox.style.background = 'rgba(239, 68, 68, 0.1)';
                warningBox.style.border = '1px solid #ef4444';
                warningBox.style.color = '#ef4444';

                let firmsHtml = expiringArr.map(f => `<li><strong>${f.ad}</strong> (${new Date(f.sozlesme_bitis).toLocaleDateString('tr-TR')})</li>`).join('');

                warningBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px;"></i>
                    <div>
                        <strong>SÃ¶zleÅŸme UyarÄ±larÄ± (Son 2 Ay):</strong>
                        <ul style="margin-top:10px; padding-left:20px;">${firmsHtml}</ul>
                    </div>
                `;
                dashboard.insertBefore(warningBox, dashboard.querySelector('.info-box'));
            }
        }

        function renderFirmalar() {
            const tbody = document.getElementById('firmalar-body');
            if (allFirmalar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px;">HenÃ¼z firma tanÄ±mlanmamÄ±ÅŸ.</td></tr>';
                return;
            }
            tbody.innerHTML = allFirmalar.map(f => {
                const sozlesmeDate = f.sozlesme_bitis ? new Date(f.sozlesme_bitis).toLocaleDateString('tr-TR') : '---';
                const servisAlimDate = f.servis_alim_tarihi ? new Date(f.servis_alim_tarihi).toLocaleDateString('tr-TR') : '-';
                const faturaShort = (f.fatura_adresi || '').trim();
                const faturaDisplay = faturaShort.length > 35 ? faturaShort.substring(0, 35) + 'â€¦' : (faturaShort || '-');

                // SÃ¶zleÅŸme rengi
                let sozlesmeStil = '';
                if (f.sozlesme_bitis) {
                    const today = new Date();
                    const end = new Date(f.sozlesme_bitis);
                    const diffMonths = (end - today) / (1000 * 60 * 60 * 24 * 30);
                    if (diffMonths < 0) sozlesmeStil = 'color:#ef4444; font-weight:800;';
                    else if (diffMonths < 2) sozlesmeStil = 'color:#f59e0b; font-weight:700;';
                }

                return `
                <tr class="tr-row">
                    <td style="font-weight:600; color:var(--accent-primary);">${f.ad}</td>
                    <td style="font-size:13px;">${f.sektor || 'Genel'}</td>
                    <td style="font-family:monospace; font-weight:700; color:#fbbf24; white-space:nowrap;">
                        <span id="pwd-${f.id}" class="blur-pwd" data-pwd="${(f.ekran_sifre || '---').replace(/"/g, '&quot;')}">****</span>
                        <i class="fas fa-eye" style="cursor:pointer; margin-left:8px; opacity:0.7; font-size:12px;" 
                           onclick="togglePassword('pwd-${f.id}', this)" title="GÃ¶ster/Gizle"></i>
                    </td>
                    <td style="font-size:12px; ${sozlesmeStil}">${sozlesmeDate}</td>
                    <td style="font-size:12px;">${servisAlimDate}</td>
                    <td style="font-size:12px; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${(f.fatura_adresi || '').replace(/"/g, '&quot;')}">${faturaDisplay}</td>
                    <td><span class="status-badge" style="background:${f.aktif ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color:${f.aktif ? '#10b981' : '#ef4444'};">${f.aktif ? 'AKTÄ°F' : 'PASÄ°F'}</span></td>
                    <td>
                        <button class="action-btn" title="DÃ¼zenle" onclick="openFirmaModal(${f.id})"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        function togglePassword(spanId, icon) {
            const span = document.getElementById(spanId);
            const realPwd = span.getAttribute('data-pwd');

            if (span.textContent === '****') {
                span.textContent = realPwd;
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                span.style.color = '#fff';
            } else {
                span.textContent = '****';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                span.style.color = '#fbbf24';
            }
        }

        function toggleModalPassword(inputId, icon) {
            const el = document.getElementById(inputId);
            if (el.type === 'password') {
                el.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                el.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Firma Modal FonksiyonlarÄ±
        function openFirmaModal(id = null) {
            const f = id ? allFirmalar.find(x => x.id == id) : null;
            document.getElementById('edit-firma-id').value = id || "";
            document.getElementById('firma-modal-title').textContent = id ? "Firma DÃ¼zenle" : "Yeni Firma TanÄ±mla";

            if (f) {
                document.getElementById('edit-firma-ad').value = f.ad;
                document.getElementById('edit-firma-sektor').value = f.sektor || "";
                document.getElementById('edit-firma-ekran-sifre').value = f.ekran_sifre || "153624";
                document.getElementById('edit-firma-sifre-kilitli').checked = !!f.sifre_kilitli;
                document.getElementById('edit-firma-lisans-tipi').value = f.lisans_tipi || "Kiralama";
                document.getElementById('edit-firma-max-cihaz').value = f.max_cihaz || 10;
                document.getElementById('edit-firma-notlar').value = f.notlar || "";
                document.getElementById('edit-firma-fatura-adresi').value = f.fatura_adresi || "";
                document.getElementById('edit-firma-rakip-inceleme').value = f.rakip_inceleme || "";
                document.getElementById('edit-firma-erteleme-kilitli').checked = !!f.erteleme_kilitli;
                if (f.sozlesme_bitis) {
                    const d = new Date(f.sozlesme_bitis);
                    document.getElementById('edit-firma-sozlesme-bitis').value = d.toISOString().split('T')[0];
                } else {
                    document.getElementById('edit-firma-sozlesme-bitis').value = "";
                }
                if (f.sozlesme_baslangic) {
                    const d = new Date(f.sozlesme_baslangic);
                    document.getElementById('edit-firma-sozlesme-baslangic').value = d.toISOString().split('T')[0];
                } else {
                    document.getElementById('edit-firma-sozlesme-baslangic').value = "";
                }
                if (f.servis_alim_tarihi) {
                    const d = new Date(f.servis_alim_tarihi);
                    document.getElementById('edit-firma-servis-alim-tarihi').value = d.toISOString().split('T')[0];
                } else {
                    document.getElementById('edit-firma-servis-alim-tarihi').value = "";
                }
                document.getElementById('edit-firma-aktif').value = f.aktif.toString();
            } else {
                document.getElementById('edit-firma-ad').value = "";
                document.getElementById('edit-firma-sektor').value = "";
                document.getElementById('edit-firma-ekran-sifre').value = "153624";
                document.getElementById('edit-firma-sifre-kilitli').checked = false;
                document.getElementById('edit-firma-lisans-tipi').value = "Kiralama";
                document.getElementById('edit-firma-max-cihaz').value = 10;
                document.getElementById('edit-firma-notlar').value = "";
                document.getElementById('edit-firma-fatura-adresi').value = "";
                document.getElementById('edit-firma-rakip-inceleme').value = "";
                document.getElementById('edit-firma-erteleme-kilitli').checked = false;
                document.getElementById('edit-firma-sozlesme-baslangic').value = "";
                document.getElementById('edit-firma-servis-alim-tarihi').value = "";
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                document.getElementById('edit-firma-sozlesme-bitis').value = nextYear.toISOString().split('T')[0];
                document.getElementById('edit-firma-aktif').value = "true";
            }
            document.getElementById('firma-modal').style.display = 'flex';
        }

        function closeFirmaModal() { document.getElementById('firma-modal').style.display = 'none'; }

        document.getElementById('firma-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-firma-id').value;
            const data = {
                ad: document.getElementById('edit-firma-ad').value,
                sektor: document.getElementById('edit-firma-sektor').value,
                ekran_sifre: document.getElementById('edit-firma-ekran-sifre').value,
                sifre_kilitli: document.getElementById('edit-firma-sifre-kilitli').checked,
                sozlesme_bitis: document.getElementById('edit-firma-sozlesme-bitis').value,
                sozlesme_baslangic: document.getElementById('edit-firma-sozlesme-baslangic').value || null,
                servis_alim_tarihi: document.getElementById('edit-firma-servis-alim-tarihi').value || null,
                fatura_adresi: document.getElementById('edit-firma-fatura-adresi').value,
                rakip_inceleme: document.getElementById('edit-firma-rakip-inceleme').value,
                erteleme_kilitli: document.getElementById('edit-firma-erteleme-kilitli').checked,
                lisans_tipi: document.getElementById('edit-firma-lisans-tipi').value,
                max_cihaz: parseInt(document.getElementById('edit-firma-max-cihaz').value),
                notlar: document.getElementById('edit-firma-notlar').value,
                aktif: document.getElementById('edit-firma-aktif').value === 'true'
            };
            try {
                if (id) {
                    await apiCall(`/admin/firma/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                    showToast("Firma gÃ¼ncellendi");
                } else {
                    await apiCall(`/admin/firma`, { method: 'POST', body: JSON.stringify(data) });
                    showToast("Firma oluÅŸturuldu");
                }
                closeFirmaModal();
                await fetchFirmalar();
                renderFirmalar();
            } catch (err) { alert("Hata: " + err.message); }
        };

        async function fetchAndRenderUsers() {
            try {
                allUsers = await apiCall('/admin/all-users');
                const tbody = document.getElementById('users-body');
                tbody.innerHTML = allUsers.map(u => `
                    <tr class="tr-row">
                        <td>
                            <div style="font-weight:600;">${u.ad_soyad}</div>
                            <div style="font-size:12px; color:var(--accent-primary); font-weight:500;">ðŸ“º Ekran: ${u.ekran_ismi || u.ad_soyad}</div>
                            <div style="font-size:11px; color:var(--text-muted); opacity:0.7;">${u.email || '-'}</div>
                        </td>
                        <td style="font-family:monospace; color:var(--accent-primary);">${u.kullanici_adi}</td>
                        <td><span class="role-badge" style="background:${getRoleColor(u.rol)};">${getRoleLabel(u.rol)}</span></td>
                        <td style="font-size:13px;">${u.rol === 'superadmin' ? '<i class="fas fa-globe-europe"></i> SÄ°STEM GENELÄ°' : (u.firma_ad || '<span style="color:red">Firma Yok!</span>')}</td>
                        <td><span class="status-badge" style="background:${u.aktif ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color:${u.aktif ? '#10b981' : '#ef4444'};">${u.aktif ? 'AKTÄ°F' : 'PASÄ°F'}</span></td>
                        <td>
                            <button class="action-btn" onclick="openUserModal(${u.id})"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        function getRoleLabel(rol) {
            const labels = {
                'staff': 'Personel',
                'admin': 'Admin',
                'manager': 'MÃ¼dÃ¼r',
                'superadmin': 'SÃœPER ADMÄ°N'
            };
            return labels[rol] || rol.toUpperCase();
        }

        function getRoleColor(rol) {
            if (rol === 'superadmin') return '#f59e0b';
            if (rol === 'admin') return '#10b981';
            return '#3b82f6';
        }

        function toggleFirmaSelect(role) {
            const group = document.getElementById('firma-select-group');
            const fSelect = document.getElementById('user-firma-id');
            if (role === 'superadmin') {
                group.style.display = 'none';
                fSelect.value = "";
                fSelect.required = false;
            } else {
                group.style.display = 'block';
                fSelect.required = true;
            }
        }

        function openUserModal(userId = null) {
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('user-id').value = userId || "";
            document.getElementById('modal-title').textContent = userId ? "KullanÄ±cÄ± DÃ¼zenle" : "Yeni KullanÄ±cÄ± TanÄ±mla";
            document.getElementById('pwd-group').style.display = 'block';
            document.getElementById('user-password').required = !userId;

            const u = userId ? allUsers.find(x => x.id == userId) : null;

            if (u) {
                document.getElementById('user-id').value = u.id;
                document.getElementById('user-ad-soyad').value = u.ad_soyad;
                document.getElementById('user-ekran-ismi').value = u.ekran_ismi || u.ad_soyad;
                document.getElementById('user-kullanici-adi').value = u.kullanici_adi;
                document.getElementById('user-email').value = u.email || "";
                document.getElementById('user-rol').value = u.rol;
                document.getElementById('user-firma-id').value = u.firma_id || "";
                document.getElementById('user-aktif').value = u.aktif.toString();
                toggleFirmaSelect(u.rol);
            } else {
                document.getElementById('user-ekran-ismi').value = "";
                toggleFirmaSelect('staff');
            }

            document.getElementById('user-modal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        function trToEn(text) {
            const tr = {
                'Ã§': 'c',
                'ÄŸ': 'g',
                'Ä±': 'i',
                'Ã¶': 'o',
                'ÅŸ': 's',
                'Ã¼': 'u',
                'Ã‡': 'c',
                'Äž': 'g',
                'Ä°': 'i',
                'Ã–': 'o',
                'Åž': 's',
                'Ãœ': 'u'
            };
            return text.replace(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄžÄ°Ã–ÅžÃœ]/g, (m) => tr[m]).toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        function autoGenerateUsername(name) {
            document.getElementById('user-kullanici-adi').value = trToEn(name);
            // Yeni kullanÄ±cÄ±ysa ekran ismini de default doldur
            if (!document.getElementById('user-id').value) {
                document.getElementById('user-ekran-ismi').value = name;
            }
        }

        function autoGenerateFirmaPassword(firmaAd) {
            // Sadece yeni firma kaydÄ± yapÄ±lÄ±yorsa otomatik doldur
            if (document.getElementById('edit-firma-id').value) return;

            if (!firmaAd) {
                document.getElementById('edit-firma-ekran-sifre').value = "";
                return;
            }

            // Ä°lk kelimeyi al, TÃ¼rkÃ§e karakterleri temizle ve ters Ã§evir
            const firstWord = firmaAd.trim().split(' ')[0];
            const cleanWord = trToEn(firstWord);
            const reversed = cleanWord.split('').reverse().join('');
            document.getElementById('edit-firma-ekran-sifre').value = reversed;
        }

        document.getElementById('user-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const data = {
                ad_soyad: document.getElementById('user-ad-soyad').value,
                ekran_ismi: document.getElementById('user-ekran-ismi').value,
                kullanici_adi: document.getElementById('user-kullanici-adi').value,
                email: document.getElementById('user-email').value || null,
                rol: document.getElementById('user-rol').value,
                firma_id: document.getElementById('user-rol').value === 'superadmin' ? null : parseInt(document.getElementById('user-firma-id').value),
                aktif: document.getElementById('user-aktif').value === 'true'
            };

            try {
                if (!id) {
                    data.password = document.getElementById('user-password').value;
                    await apiCall('/admin/user', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showToast("KullanÄ±cÄ± oluÅŸturuldu");
                } else {
                    const pwd = document.getElementById('user-password').value;
                    if (pwd) data.password = pwd;
                    await apiCall(`/admin/user/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showToast("KullanÄ±cÄ± gÃ¼ncellendi");
                }
                closeUserModal();
                fetchAndRenderUsers();
            } catch (err) {
                alert("Hata: " + err.message);
            }
        };

        function logout() {
            localStorage.clear();
            window.location.href = 'personel.html';
        }
        // init(); // Added to body onload
    </script>
</body>

</html>