<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sıra Numarası Al - Sıramatik</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%236366f1' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'>S</text></svg>">
    <link rel="stylesheet" href="static/style.css">
    <style>
        /* Responsive: 7" tablet ~320px, 8" ~400px, 10" ~600px, 15" ~1366px, 60" TV ~1920px+ */
        :root {
            --kiosk-header-h1: clamp(16px, 4vw, 36px);
            --kiosk-header-p: clamp(12px, 2.2vw, 18px);
            --kiosk-banner-title: clamp(14px, 3vw, 24px);
            --kiosk-banner-sub: clamp(11px, 1.8vw, 18px);
            --kiosk-section-title: clamp(18px, 4vw, 36px);
            --kiosk-card-pad: clamp(8px, 1.5vw, 24px);
            --kiosk-grid-gap: clamp(8px, 1.5vw, 20px);
            --kiosk-grid-min: min(160px, 38vw);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: clamp(6px, 1.2vw, 20px) clamp(10px, 2vw, 20px);
            height: 100vh;
            height: 100dvh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }

        .header {
            margin-bottom: clamp(8px, 1.5vh, 20px);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: var(--kiosk-header-h1);
            margin-bottom: 2px;
        }

        .header p {
            font-size: var(--kiosk-header-p);
            opacity: 0.9;
        }

        /* Sağ Üst Geri Dön Butonu */
        .exit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(231, 76, 60, 0.9);
            /* Kırmızı */
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: none;
            /* Başlangıçta gizli */
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            z-index: 1000;
            will-change: transform;
        }

        .exit-button:hover {
            background: rgba(192, 57, 43, 1);
            /* Koyu kırmızı */
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.5);
        }

        .exit-button.show {
            display: flex;
            /* Gösterildiğinde flex yap */
        }

        .exit-button .x-icon {
            font-size: 24px;
            font-weight: bold;
            line-height: 1;
        }

        .departman-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--kiosk-grid-min), 1fr));
            gap: var(--kiosk-grid-gap);
            width: 100%;
            max-width: min(1400px, 98vw);
            margin: 0 auto;
            flex: 1;
            min-height: 0;
            align-content: center;
            padding: clamp(6px, 1vw, 16px);
            box-sizing: border-box;
        }

        .departman-card {
            background: white;
            color: #667eea;
            padding: var(--kiosk-card-pad);
            border-radius: clamp(12px, 2vw, 20px);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 0;
            max-height: 45vh;
            overflow: hidden;
            will-change: transform;
            box-sizing: border-box;
        }

        .departman-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .departman-card h2 {
            font-size: clamp(14px, 2.2vmin, 28px);
            margin: clamp(4px, 1vh, 10px) 0;
        }

        .departman-card .kod {
            font-size: clamp(20px, 4vmin, 48px);
            font-weight: bold;
            color: #764ba2;
        }

        .departman-card .bekleyen {
            font-size: clamp(10px, 1.4vmin, 16px);
            color: #666;
            margin-top: 2px;
        }

        #departman-secimi {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        #alt-secenekler-konteynir {
            flex: 1;
            min-height: 0;
            display: none;
            flex-direction: column;
            justify-content: center;
            margin-top: clamp(8px, 1.5vh, 20px) !important;
            padding: clamp(10px, 2vw, 20px) !important;
            overflow: hidden;
        }

        /* --- Numara alındı / Bilet ekranı (responsive 7"-60") --- */
        #numara-ekrani {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: clamp(10px, 2vw, 20px);
            animation: fadeInSimple 0.15s ease-out;
            overflow: auto;
            will-change: opacity;
            box-sizing: border-box;
        }

        @keyframes fadeInSimple {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .bilet-konteynir {
            display: grid;
            grid-template-columns: minmax(200px, 1fr) minmax(180px, 320px);
            gap: clamp(12px, 2.5vw, 30px);
            background: rgba(255, 255, 255, 0.15);
            padding: clamp(16px, 3vw, 40px);
            border-radius: clamp(16px, 3vw, 40px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            align-items: center;
            width: 100%;
            max-width: min(800px, 96vw);
            box-sizing: border-box;
        }

        @media (max-width: 700px) {
            .bilet-konteynir {
                grid-template-columns: 1fr;
                max-width: min(420px, 96vw);
            }
        }

        #numara-ekrani .info-section {
            min-width: 0;
        }

        #numara-ekrani .info-section h2 {
            font-size: clamp(18px, 4vw, 32px);
            opacity: 0.9;
        }

        #numara-ekrani .numara {
            font-size: clamp(48px, 18vmin, 140px);
            font-weight: 900;
            margin: clamp(8px, 1.5vh, 20px) 0;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        #numara-ekrani .mesaj {
            font-size: clamp(14px, 2.8vw, 24px);
            min-height: 1.2em;
        }

        #numara-ekrani .bekleme-info {
            background: rgba(255,255,255,0.2);
            padding: clamp(8px, 1.5vw, 15px);
            border-radius: clamp(8px, 1.5vw, 15px);
            display: inline-block;
            margin-top: clamp(6px, 1vh, 10px);
            font-size: clamp(11px, 2vw, 16px);
        }

        #numara-ekrani .tahmini-bekleme {
            margin-top: clamp(6px, 1vh, 10px);
            font-size: clamp(12px, 2vw, 17px);
            opacity: 0.95;
            font-weight: 600;
        }

        .print-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: clamp(12px, 2vw, 25px) clamp(16px, 3vw, 40px);
            border-radius: clamp(10px, 2vw, 20px);
            font-size: clamp(14px, 2.5vw, 24px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(8px, 1.5vw, 15px);
            width: 100%;
            margin-top: clamp(12px, 2vh, 30px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }

        .qr-section {
            background: white;
            padding: clamp(12px, 2.5vw, 30px);
            border-radius: clamp(12px, 2.5vw, 30px);
            color: #2c3e50;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: min(280px, 75vw);
            min-width: 0;
            box-sizing: border-box;
        }

        .qr-section p {
            margin: clamp(8px, 1.5vh, 15px) 0 5px;
            font-size: clamp(14px, 2.5vw, 22px);
            font-weight: bold;
        }

        #qrcode {
            display: inline-block;
            max-width: 100%;
            height: auto;
            padding: clamp(4px, 1vw, 6px);
            background: white;
        }

        #qrcode canvas, #qrcode img {
            max-width: min(200px, 55vw) !important;
            height: auto !important;
        }

        .qr-section .back-btn {
            padding: clamp(6px, 1.2vw, 10px) clamp(10px, 2vw, 14px);
            font-size: clamp(11px, 2vw, 13px);
        }

        #qr-sayac {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: clamp(8px, 1.5vw, 12px);
            font-size: clamp(12px, 2vw, 16px);
        }

        .qr-aciklama {
            font-size: clamp(11px, 1.8vw, 13px);
            color: #7f8c8d;
            margin-bottom: clamp(8px, 1.5vw, 12px);
            text-align: center;
        }

        .print-btn:hover {
            transform: scale(1.03);
            background: #27ae60;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Dijital Fiş Tasarımı */
        #fis-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .fis-paper {
            background: white;
            color: #333;
            width: 320px;
            padding: 20px 15px;
            border-radius: 5px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            position: relative;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        .fis-paper::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 0;
            width: 100%;
            height: 15px;
            background: linear-gradient(-45deg, white 5px, transparent 0), linear-gradient(45deg, white 5px, transparent 0);
            background-size: 10px 15px;
            background-repeat: repeat-x;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .departman-card.active {
            background: #ffd700;
            color: #1a1a2e;
            transform: scale(1.05);
            box-shadow: 0 0 30px #ffd700;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
            will-change: opacity, transform;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sol Alt Ayarlar Butonu */
        .settings-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            min-width: 50px;
            min-height: 50px;
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        /* Ayarlar Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }

        .settings-panel {
            background: white;
            color: #333;
            padding: 25px;
            border-radius: 20px;
            max-width: 1200px;
            width: 95%;
            max-height: 95vh;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .settings-panel h2 {
            flex-shrink: 0;
            margin-bottom: 10px;
        }
        
        .settings-panel > p {
            flex-shrink: 0;
            margin-bottom: 15px;
        }
        
        .settings-panel .settings-grid {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 10px;
        }
        
        .settings-panel .settings-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .settings-panel .settings-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .settings-panel .settings-grid::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .settings-panel .settings-grid::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 900px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .settings-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }
        
        .settings-section-full {
            grid-column: 1 / -1;
        }

        .settings-panel h2 {
            margin-top: 0;
            color: #667eea;
        }

        .settings-panel label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
        }

        .settings-panel select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .settings-panel button {
            margin: 10px 5px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: #22c55e;
            color: white;
        }

        .btn-save:hover {
            background: #16a34a;
        }

        .btn-cancel {
            background: #e74c3c;
            color: white;
        }

        .btn-cancel:hover {
            background: #c0392b;
        }

        .btn-reset {
            background: #f39c12;
            color: white;
        }

        .btn-reset:hover {
            background: #d68910;
        }

        /* Akıllı takip bannerı - ekran boyutuna göre ölçeklenir */
        .kiosk-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: clamp(8px, 1.5vh, 15px) clamp(10px, 2vw, 25px);
            border-radius: clamp(8px, 1.5vw, 15px);
            margin: 0 auto clamp(6px, 1vh, 15px);
            max-width: min(900px, 96vw);
            box-shadow: 0 8px 30px rgba(245, 87, 108, 0.4);
            animation: pulse 3s infinite;
            will-change: transform;
            flex-shrink: 0;
        }
        .kiosk-banner-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(8px, 2vw, 20px);
            flex-wrap: wrap;
        }
        .kiosk-banner-icon { font-size: clamp(24px, 5vw, 48px); }
        .kiosk-banner-text { text-align: left; }
        .kiosk-banner-title {
            font-size: var(--kiosk-banner-title);
            font-weight: bold;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .kiosk-banner-sub {
            font-size: var(--kiosk-banner-sub);
            opacity: 0.95;
        }

        .kiosk-section-title {
            font-size: var(--kiosk-section-title);
            margin-bottom: clamp(12px, 2vh, 40px);
            flex-shrink: 0;
        }

        .alt-secenekler-konteynir {
            display: none;
            flex: 1;
            min-height: 0;
            flex-direction: column;
            justify-content: center;
            margin-top: clamp(12px, 2vh, 50px);
            padding: clamp(12px, 2.5vw, 40px);
            background: rgba(255,255,255,0.1);
            border-radius: clamp(12px, 2vw, 30px);
            border: 2px dashed rgba(255,255,255,0.3);
            overflow: hidden;
        }
        .kiosk-alt-baslik {
            font-size: clamp(18px, 3.5vw, 32px);
            margin-bottom: clamp(12px, 2vh, 30px);
            color: #ffd700;
            flex-shrink: 0;
        }
    </style>
</head>

<body>
    <!-- Bağlantı Durum Badge (Küçük, Sağ Üst Köşe) -->
    <div id="connection-status" style="position:fixed; top:15px; right:15px; background:#f39c12; color:white; text-align:center; padding:8px 12px; z-index:99999; font-weight:bold; font-size: 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display:none; min-width: 120px; transition: all 0.3s ease;">
        <i class="fas fa-sync fa-spin"></i> <span id="connection-text">Kontrol ediliyor...</span>
    </div>

    <!-- Sol Alt Ayarlar Butonu -->
    <button class="settings-button" onclick="openSettings()" title="Kiosk Ayarları">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Şifre Sorgulama Modalı (Her zaman en üstte olacak şekilde daha yüksek z-index) -->
    <div id="password-ask-modal" class="settings-modal" style="display:none; z-index: 11000;">
        <div class="settings-panel" style="max-width: 400px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 20px;"></div>
            <h3 style="margin-bottom: 15px; color: #2c3e50;">Müdahale Şifresi</h3>
            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">Ayarlara erişmek için şifreyi giriniz.</p>
            <input type="password" id="ask-password-input"
                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-size: 24px; text-align: center; margin-bottom: 25px; outline: none;"
                placeholder="****">
            <div style="display: flex; gap: 10px;">
                <button id="ask-password-confirm" class="btn-save" style="flex: 2; margin: 0;">GİRİŞ</button>
                <button id="ask-password-cancel" class="btn-cancel" style="flex: 1; margin: 0;">İPTAL</button>
            </div>
        </div>
    </div>

    <!-- Ayarlar / İlk Kurulum Modal -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-panel">
            <h2 style="margin-bottom: 10px; color: #667eea;">Kiosk Ayarları</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Bu kiosk'un hangi bölüm ve kuyruklara hizmet vereceğini seçin.</p>

            <div class="settings-grid">
                <!-- CİHAZ BİLGİLERİ -->
                <div class="settings-section">
                    <h3>Cihaz Bilgileri</h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="device-name-input" style="display:block; margin-bottom:6px; font-size:14px; color:#475569; font-weight:500;">Tablet Adı</label>
                        <input id="device-name-input" type="text" class="admin-input"
                            style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px;"
                            placeholder="Örn: LABORATUVAR GİRİŞ TABLETİ">
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="kiosk-cihaz-tipi" style="display:block; margin-bottom:6px; font-size:14px; color:#475569; font-weight:500;">Cihaz Tipi</label>
                        <select id="kiosk-cihaz-tipi" class="admin-input" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px;">
                            <option value="">Seçiniz</option>
                            <option value="TABLET">TABLET</option>
                            <option value="TV">TV</option>
                            <option value="PC">PC</option>
                            <option value="TELEFON">TELEFON</option>
                            <option value="EL_MODULU">EL MODÜLÜ</option>
                        </select>
                        <small style="display:block; margin-top:4px; font-size:11px; color:#64748b;">Sadece ilk kurulumda değiştirilebilir.</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="kiosk-kullanim-tipi" style="display:block; margin-bottom:6px; font-size:14px; color:#475569; font-weight:500;">Kullanım Tipi</label>
                        <select id="kiosk-kullanim-tipi" class="admin-input" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px;">
                            <option value="">Seçiniz</option>
                            <option value="KIOSK">KIOSK</option>
                            <option value="EKRAN">EKRAN</option>
                            <option value="KULLANICI_EKRANI">KULLANICI EKRANI</option>
                            <option value="TELEFON">TELEFON</option>
                            <option value="EL_MODULU">EL MODÜLÜ</option>
                        </select>
                        <small style="display:block; margin-top:4px; font-size:11px; color:#64748b;">Sadece ilk kurulumda değiştirilebilir.</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="device-fingerprint-display" style="display:block; margin-bottom:6px; font-size:14px; color:#475569; font-weight:500;">Tablet Kodu (Parmak İzi)</label>
                        <input id="device-fingerprint-display" type="text"
                            style="width:100%; padding:8px 10px; border-radius:8px; border:1px dashed #cbd5e1; font-size:12px; font-family:monospace; background:#f1f5f9; color:#64748b;"
                            readonly>
                        <small style="display:block; margin-top:4px; font-size:11px; color:#64748b;">
                            Bu kod veritabanında cihazı benzersiz tanımlamak için kullanılır. Otomatik oluşturulur ve değiştirilemez.
                        </small>
                    </div>
                </div>

                <!-- EKRAN AYARLARI -->
                <div class="settings-section">
                    <h3>Ekran Ayarları</h3>
                    <div style="margin-bottom: 15px;">
                        <label for="fullscreen-checkbox" style="display:flex; align-items:center; gap:8px; font-size:14px; color:#475569; cursor:pointer; font-weight:500;">
                            <input type="checkbox" id="fullscreen-checkbox" style="width:18px; height:18px;">
                            Tam ekran çalışsın
                        </label>
                        <small style="display:block; margin-top:4px; margin-left:26px; font-size:11px; color:#64748b;">
                            Aktifse sayfa açıldığında mümkün olduğunda tam ekrana geçmeye çalışır.
                        </small>
                    </div>
                    <div>
                        <label for="orientation-select" style="display:block; margin-bottom:6px; font-size:14px; color:#475569; font-weight:500;">Ekran Yönü</label>
                        <select id="orientation-select" class="admin-input" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px;">
                            <option value="auto">Otomatik (Cihazın yönüne göre)</option>
                            <option value="portrait">Dikey odaklı</option>
                            <option value="landscape" selected>Yatay odaklı</option>
                        </select>
                        <small style="display:block; margin-top:4px; font-size:11px; color:#64748b;">
                            Yatay kilidi birçok tarayıcıda yalnızca tam ekranda çalışır. iOS Safari ve bazı cihazlarda işletim sistemi yön kilidine izin vermeyebilir.
                        </small>
                    </div>
                </div>

                <!-- BÖLÜM SEÇİMİ -->
                <div class="settings-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">Bölümler (Servisler)</h3>
                        <button onclick="clearServisSelection()" style="background:#6b7280; color:white; padding:6px 12px; border:none; border-radius:6px; font-size:12px; cursor:pointer; font-weight:500;">
                            <i class="fas fa-times"></i> Temizle
                        </button>
                    </div>
                    <select id="servis-filter" multiple size="6" style="width:100%; padding:6px; border:2px solid #cbd5e1; border-radius:8px; font-size:13px; height:140px;">
                        <!-- Dinamik olarak doldurulacak -->
                    </select>
                    <small style="display:block; margin-top:6px; font-size:11px; color:#64748b;">
                        Ctrl/Cmd tuşu ile birden fazla seçim yapabilirsiniz
                    </small>
                </div>

                <!-- KUYRUK SEÇİMİ -->
                <div class="settings-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">Kuyruklar (Opsiyonel)</h3>
                        <button onclick="clearKuyrukSelection()" style="background:#6b7280; color:white; padding:6px 12px; border:none; border-radius:6px; font-size:12px; cursor:pointer; font-weight:500;">
                            <i class="fas fa-times"></i> Temizle
                        </button>
                    </div>
                    <select id="kuyruk-filter" multiple size="6" style="width:100%; padding:6px; border:2px solid #cbd5e1; border-radius:8px; font-size:13px; height:140px;">
                        <!-- Dinamik olarak doldurulacak -->
                    </select>
                    <small style="display:block; margin-top:6px; font-size:11px; color:#64748b;">
                        Boş bırakırsanız seçili bölümlerin tüm kuyrukları gösterilir
                    </small>
                </div>

                <!-- BÖLÜM SEÇİMİNİ ATLA -->
                <div class="settings-section settings-section-full">
                    <label
                        style="display: flex; align-items: center; cursor: pointer; font-size: 15px; color: #2c3e50; font-weight: 600; margin: 0;">
                        <input type="checkbox" id="hide-servis-checkbox"
                            style="width: 22px; height: 22px; margin-right: 12px; cursor: pointer;">
                        Bölüm Seçimini Atla (Direkt Hizmetleri Göster)
                    </label>
                    <p style="margin: 8px 0 0 34px; font-size: 12px; color: #64748b; line-height: 1.4;">
                        Aktif edilirse, "Hangi Bölüme Gideceksiniz?" ekranı gösterilmez, seçili bölümlerin tüm hizmetleri
                        doğrudan listelenir.
                    </p>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; flex-shrink: 0;">
                <button class="btn-save" onclick="saveSettings()" style="min-width:120px;">
                    <i class="fas fa-save"></i> Kaydet
                </button>
                <button class="btn-reset" onclick="resetSettings()" style="min-width:140px;">
                    <i class="fas fa-power-off"></i> KIOSK SIFIRLA
                </button>
                <button class="btn-cancel" onclick="closeSettings()" style="min-width:120px;">
                    <i class="fas fa-times"></i> İptal
                </button>
            </div>
        </div>
    </div>
    <!-- Sağ Üst Geri Dön Butonu -->
    <button class="exit-button" id="exit-btn" onclick="location.reload()" title="Ana sayfaya dön">
        <span class="x-icon">✕</span>
        <span>Geri Dön</span>
    </button>

    <div class="header">
        <h1 id="hospital-name"> Yükleniyor...</h1>
        <p id="hospital-subtitle">Sıra Numarası Alma Sistemi</p>
    </div>

    <!-- Akıllı Takip Uyarısı -->
    <div class="kiosk-banner">
        <div class="kiosk-banner-inner">
            <div class="kiosk-banner-icon"></div>
            <div class="kiosk-banner-text">
                <div class="kiosk-banner-title">BU CİHAZ AKILLI SIRA TAKİP SİSTEMİ KULLANIR</div>
                <div class="kiosk-banner-sub">Lütfen seçimden önce cep telefonunuzun kamerasını açınız</div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        /* Ekran yönü için basit yardımcı sınıflar (ileride genişletilebilir) */
        body.orientation-portrait .bilet-konteynir {
            max-width: 520px;
            margin: 0 auto;
            flex-direction: column;
        }

        body.orientation-landscape .bilet-konteynir {
            max-width: 1200px;
        }

        /* Küçük ekranlar (8" tablet vb.): grid daha dar hücreler */
        @media (max-width: 600px), (max-height: 500px) {
            :root {
                --kiosk-grid-min: min(120px, 42vw);
            }
        }

        /* Küçük ekranlarda bilet ekranı tek kolon (yukarıdaki clamp’ler boyutları zaten ölçekliyor) */
        @media (max-width: 700px) {
            .qr-section {
                justify-self: center;
            }
        }
    </style>

    <div id="departman-secimi">
        <h2 class="kiosk-section-title">Hangi Bölüme Gideceksiniz?</h2>
        <div class="departman-grid" id="departman-listesi"></div>
    </div>

    <!-- Alt seçenekler alanı -->
    <div id="alt-secenekler-konteynir" class="alt-secenekler-konteynir">
        <h3 id="alt-secenek-baslik" class="kiosk-alt-baslik">Hizmet Türü Seçiniz</h3>
        <div id="alt-secenek-listesi" class="departman-grid"></div>
    </div>

    <div id="fis-modal">
        <div class="fis-paper">
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;" id="fis-hospital">İRMET HOSPITAL</div>
            <div style="border-top: 1px dashed #ccc; margin: 8px 0;"></div>
            <div style="font-size: 12px; margin: 5px 0;">SIRA BİLETİ</div>
            <div style="font-size: 48px; font-weight: bold; margin: 10px 0;" id="fis-numara">Y004</div>
            <div style="font-size: 16px; margin-bottom: 8px;" id="fis-kuyruk">YATMA İŞLEMLERİ</div>
            <div style="border-top: 1px dashed #ccc; margin: 8px 0;"></div>
            <div id="fis-qrcode"
                style="margin: 10px auto; display: flex; justify-content: center; align-items: center;"></div>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 8px;">Sıranızı bu kodu okutarak takip edebilirsiniz.
            </div>
            <div style="font-size: 11px; margin-top: 10px; opacity: 0.6;" id="fis-tarih">2026-02-07 18:30</div>

            <button onclick="location.reload()" class="back-btn"
                style="color: #333; border-color: #333; margin-top: 15px; padding: 10px 20px; font-size: 14px;">
                ANA SAYFAYA DÖN
            </button>
        </div>
    </div>
    <div id="numara-ekrani" style="display:none;">
        <div class="bilet-konteynir">
            <!-- Sol Panel: Bilet Bilgileri -->
            <div class="info-section">
                <h2>Sıra Numaranız</h2>
                <div class="numara" id="numara"></div>
                <p class="mesaj" id="mesaj"></p>
                <div class="bekleme-info" id="bekleme-info"></div>
                <div class="tahmini-bekleme" id="tahmini-bekleme"></div>
                <button onclick="fisBastir()" class="print-btn">
                    <i class="fas fa-print"></i>
                    FİŞ YAZDIR
                </button>
            </div>

            <!-- Sağ Panel: QR Kod -->
            <div class="qr-section">
                <div id="qrcode"></div>
                <p>Karekod Okut</p>
                <div class="qr-aciklama">Sıranızı telefondan canlı takip edin</div>
                <div id="qr-sayac"></div>
                <button onclick="location.reload()" class="back-btn">ANA SAYFAYA DÖN</button>
            </div>
        </div>
    </div>

    <!-- Font Awesome ve QR Lib -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Backend API Helper (config.js = tüm klasör için tek API/WS adresi) -->
    <script src="static/config.js"></script>
    <script src="static/app.js"></script>
    
    <script>
        
        // Durum Badge Güncelleme (Küçük, Sağ Üst Köşe)
        let connectionStatusShown = false;
        let isFirstLoad = !localStorage.getItem('kiosk_first_load_done');
        
        function updateConnectionStatus(status, message) {
            const el = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            if (!el || !textEl) return;
            
            // İlk yüklemede göster, sonraki yüklemelerde sadece offline durumunda göster
            if (!isFirstLoad && status === 'online') {
                // İlk yükleme değilse ve online ise gösterme
                el.style.display = 'none';
                return;
            }
            
            // Badge'i göster
            el.style.display = 'block';
            connectionStatusShown = true;
            
            if (status === 'online') {
                el.style.background = '#2ecc71';
                textEl.innerHTML = '<i class="fas fa-check-circle"></i> Online';
                // İlk yüklemede 3 saniye sonra gizle, sonraki yüklemelerde hemen gizle
                setTimeout(() => { 
                    el.style.display = 'none';
                    connectionStatusShown = false;
                }, isFirstLoad ? 3000 : 1000);
                // İlk yükleme işaretini koy
                if (isFirstLoad) {
                    localStorage.setItem('kiosk_first_load_done', 'true');
                    isFirstLoad = false;
                }
            } else if (status === 'offline') {
                el.style.background = '#e74c3c';
                textEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message || 'Bağlantı Yok'}`;
                // Offline durumunda göster (kullanıcı bilgilendirilmeli)
            } else {
                el.style.background = '#f39c12';
                textEl.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${message || 'Kontrol...'}`;
            }
        }

        // Toast, Loading, vs. yardımcı fonksiyonlar
        function showLoading(show) {
            const loader = document.getElementById('loading');
            if (loader) loader.style.display = show ? 'flex' : 'none';
        }
        
        function showToast(message, type = 'info') {
            alert(message); // Basit toast yerine alert
        }
        
        let allQueues = [];
        let FIRMA_ID = localStorage.getItem('global_firma_id') || 1;
        let DEVICE_ID = localStorage.getItem('tablet_device_id') || null;
        let DEVICE_FINGERPRINT = localStorage.getItem('device_fingerprint') || null;

        // Barkod/QR linki: doğrudan özel domain (github adresi hiç görünmez)
        const BILET_QR_BASE_URL = 'https://siramatik.inovathinks.com';

        // Kiosk Ayarları Yönetimi
        // Not: initialSetupDone, ilk kurulum sihirbazının tamamlanıp tamamlanmadığını tutar
        let kioskSettings = {
            servisIds: [],
            kuyrukIds: [],
            hideServisSelection: false,
            initialSetupDone: false,
            deviceName: null,
            fullscreen: true,
            orientation: 'landscape' // 'auto' | 'portrait' | 'landscape' — varsayılan yatay
        };

        // ============================================
        // CİHAZ KAYIT VE YÖNETİM SİSTEMİ
        // ============================================

        /**
         * Browser Fingerprint Oluştur
         * Canvas, WebGL, Screen, Navigator bilgilerini kullanarak benzersiz ID
         */
        async function generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.textBaseline = 'alphabetic';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('SIRAMATIK', 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillText('DEVICE', 4, 17);
            
            const canvasData = canvas.toDataURL();
            
            const components = [
                canvasData,
                navigator.userAgent,
                navigator.language,
                screen.colorDepth,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency || 0,
                navigator.deviceMemory || 0
            ].join('|||');
            
            // Simple hash
            let hash = 0;
            for (let i = 0; i < components.length; i++) {
                const char = components.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return 'fp_' + Math.abs(hash).toString(36) + '_' + Date.now().toString(36);
        }

        /**
         * Cihazı Backend'e Kaydet veya Güncelle
         */
        async function registerOrUpdateDevice() {
            try {
                // Cihaz kaydı kontrol ediliyor
                
                let fingerprint = localStorage.getItem('device_fingerprint');
                if (!fingerprint) {
                    fingerprint = await generateFingerprint();
                    localStorage.setItem('device_fingerprint', fingerprint);
                    console.log('[OK] Yeni fingerprint oluşturuldu:', fingerprint);
                }
                DEVICE_FINGERPRINT = fingerprint;
                
                // Browser bilgisini tespit et (okunabilir format)
                function detectBrowser() {
                    const ua = navigator.userAgent;
                    if (ua.includes('Edg')) return 'Edge';
                    if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
                    if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
                    if (ua.includes('Firefox')) return 'Firefox';
                    if (ua.includes('Opera') || ua.includes('OPR')) return 'Opera';
                    return 'Unknown';
                }
                
                // Cihaz bilgilerini topla
                const deviceInfo = {
                    firma_id: parseInt(FIRMA_ID),
                    ad: `KIOSK-${fingerprint.substring(3, 10)}`,
                    tip: 'kiosk', // legacy alan (kullanım tipi)
                    cihaz_tipi: 'TABLET',
                    kullanim_tipi: 'KIOSK',
                    device_fingerprint: fingerprint,
                    mac_address: null,
                    ip: null,
                    ayarlar: kioskSettings,
                    metadata: {
                        browser: detectBrowser(),
                        browser_version: navigator.userAgent,
                        screen_resolution: `${screen.width}x${screen.height}`,
                        platform: navigator.platform,
                        cihaz_tipi: 'TABLET',
                        kullanim_tipi: 'KIOSK',
                        language: navigator.language,
                        last_url: window.location.href
                    }
                };
                
                // Backend'e kayıt
                const response = await apiCall('/api/cihaz/kayit', {
                    method: 'POST',
                    body: JSON.stringify(deviceInfo)
                });
                
                if (response.status === 'success' && response.device) {
                    DEVICE_ID = response.device.id;
                    localStorage.setItem('tablet_device_id', DEVICE_ID);
                    console.log('[OK] Cihaz kaydedildi. Device ID:', DEVICE_ID);
                    console.log('[OK] Device bilgileri:', JSON.stringify(response.device));
                    updateConnectionStatus('online');

                    // Backend'den ayarları çek (setup durumu burada kontrol edilecek)
                    await syncSettingsFromBackend();
                    
                    // Eğer backend'de ayar yoksa VE is_new ise, local ayarları da sıfırla
                    if (response.device.is_new && (!kioskSettings || !kioskSettings.initialSetupDone)) {
                        console.log('[SETUP] Yeni cihaz kaydı ve backend\'de setup bilgisi yok, kurulum gerekli');
                    }
                    
                    return true;
                }
                
                console.warn('[WARN] Cihaz kaydedilemedi, response:', response);
                updateConnectionStatus('offline', 'Cihaz kayıt yanıtı geçersiz');
                return false;
                
            } catch (error) {
                console.error('[ERR] Cihaz kayıt hatası:', error);
                updateConnectionStatus('offline', 'Cihaz kaydedilemedi: ' + (error.message || 'Bilinmeyen hata'));
                // Hata durumunda local ayarlarla devam et
                return false;
            }
        }

        /**
         * Backend'den Ayarları Çek ve Senkronize Et
         */
        async function syncSettingsFromBackend() {
            if (!DEVICE_ID) return;
            
            try {
                const response = await apiCall(`/api/cihaz/${DEVICE_ID}/ayarlar`);
                
                console.log('[SYNC] Backend response:', response);
                
                if (response.status === 'success' && response.device) {
                    const backendSettings = response.device.ayarlar || {};
                    const setupCompleted = response.device.setup_tamamlandi || false;
                    
                    console.log('[SYNC] Backend setup_tamamlandi:', setupCompleted);
                    console.log('[SYNC] Backend ayarları:', backendSettings);
                    
                    // Backend'deki setup durumunu ayarlara ekle
                    if (setupCompleted) {
                        backendSettings.initialSetupDone = true;
                        console.log('[SYNC] Backend\'de setup tamamlanmış olarak işaretli');
                        
                        // Setup tamamlandıysa tablet adı alanını readonly yap
                        const nameInput = document.getElementById('device-name-input');
                        if (nameInput) {
                            nameInput.readOnly = true;
                            nameInput.style.background = '#f1f5f9';
                            nameInput.style.cursor = 'not-allowed';
                            nameInput.style.color = '#64748b';
                            nameInput.title = 'Cihaz adı artık sadece admin panelinden değiştirilebilir.';
                        }
                    } else {
                        console.log('[SYNC] Backend\'de setup henüz tamamlanmamış');
                    }
                    
                    // Backend ayarları ile local ayarları karşılaştır
                    const localSettings = JSON.stringify(kioskSettings);
                    const remoteSettings = JSON.stringify(backendSettings);
                    
                    if (localSettings !== remoteSettings) {
                        console.log('[SYNC] Backend ayarları uygulanıyor...');
                        kioskSettings = { ...kioskSettings, ...backendSettings };
                        localStorage.setItem('kiosk_settings', JSON.stringify(kioskSettings));
                        console.log('[OK] Ayarlar senkronize edildi:', kioskSettings);
                        return true;
                    } else {
                        console.log('[SYNC] Local ve backend ayarları aynı, senkronizasyon gerekmiyor');
                    }
                }
            } catch (error) {
                console.error('[WARN] Ayar senkronizasyon hatası:', error);
            }
            return false;
        }

        /**
         * Ayarları Backend'e Kaydet
         */
        async function saveSettingsToBackend(settings) {
            if (!DEVICE_ID) return false;
            
            try {
                // Setup durumunu kontrol et - eğer setup tamamlandıysa deviceName'i ayarlardan çıkar
                let settingsToSend = { ...settings };
                
                // Backend'den mevcut setup durumunu kontrol et
                try {
                    const deviceResponse = await apiCall(`/api/cihaz/${DEVICE_ID}/ayarlar`);
                    if (deviceResponse.status === 'success' && deviceResponse.device) {
                        const setupCompleted = deviceResponse.device.setup_tamamlandi || false;
                        if (setupCompleted) {
                            // Setup tamamlandıysa saha tarafından değiştirilemeyen alanları gönderme (sadece admin değiştirebilir)
                            console.log('[SETUP] Setup tamamlanmış, deviceName/cihaz_tipi/kullanim_tipi backend\'e gönderilmeyecek');
                            delete settingsToSend.deviceName;
                            delete settingsToSend.cihaz_tipi;
                            delete settingsToSend.kullanim_tipi;
                        }
                    }
                } catch (err) {
                    console.warn('[SETUP CHECK] Backend setup durumu kontrol edilemedi:', err);
                }
                
                const response = await apiCall(`/api/cihaz/${DEVICE_ID}/ayarlar`, {
                    method: 'PUT',
                    body: JSON.stringify({ ayarlar: settingsToSend })
                });
                
                if (response.status === 'success') {
                    console.log('[OK] Ayarlar Backend\'e kaydedildi');
                    return true;
                }
                
                console.error('[ERR] Ayar kayıt hatası');
                return false;
            } catch (error) {
                console.error('[ERR] Ayar kayıt hatası:', error);
            }
            return false;
        }

        /**
         * Heartbeat Gönder
         */
        async function sendHeartbeat() {
            if (!DEVICE_ID) {
                console.warn('[WARN] Heartbeat atlaması: DEVICE_ID yok');
                return;
            }
            
            // Heartbeat gönderiliyor
            try {
                await apiCall(`/api/cihaz/${DEVICE_ID}/heartbeat`, {
                    method: 'POST',
                    body: JSON.stringify({
                        device_id: DEVICE_ID,
                        ip: null,
                        metadata: null 
                    })
                });
                updateConnectionStatus('online');
            } catch (error) {
                console.warn('[WARN] Heartbeat hatası:', error);
                var msg = 'Sunucu ile iletişim kurulamıyor';
                if (error.message && (error.message.includes('fetch') || error.message.includes('Network'))) {
                    msg = 'Backend\'e ulaşılamıyor. Backend çalışıyor mu? (Port 8000)';
                }
                updateConnectionStatus('offline', msg);
                
                // Eğer cihaz bulunamadı hatası alırsak (404), ID geçersizdir.
                if (error.message && (error.message.includes('bulunamadı') || error.message.includes('404'))) {
                    console.log('[RESET] Cihaz ID geçersiz, sıfırlanıyor...');
                    updateConnectionStatus('offline', 'Kimlik yenileniyor...');
                    localStorage.removeItem('tablet_device_id');
                    DEVICE_ID = null;
                    // Yeniden kayıt olmayı dene
                    await registerOrUpdateDevice();
                }
            }
        }

        function loadKioskSettings() {
            const saved = localStorage.getItem('kiosk_settings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Eski ayarlarda yeni alan olmayabilir, spread ile güvenli birleştirme yapıyoruz
                    kioskSettings = { ...kioskSettings, ...parsed };
                } catch (e) {
                    console.error('Ayarlar yüklenemedi:', e);
                }
            }
        }

        async function openSettings() {
            // Modal ile şifre sor
            const password = await askPasswordModal();
            if (!password) return;

            try {
                // Şifreyi doğrula ve hangi firmaya ait olduğunu bul
                const res = await apiCall('/api/auth/ekran-login', {
                    method: 'POST',
                    body: JSON.stringify({ sifre: password })
                });

                if (res.status === 'authorized') {
                    // Eğer şifre başka bir firmaya aitse veya ilk defa kuruluyorsa
                    if (res.firma_id != FIRMA_ID) {
                        localStorage.setItem('global_firma_id', res.firma_id);
                        alert(`Cihaz ${res.firma_ad} firmasına bağlandı. Sayfa yenileniyor...`);
                        location.reload();
                        return;
                    }

                    // Şifre doğru ve firma aynıysa ayarları aç
                    document.getElementById('settings-modal').style.display = 'flex';
                    loadSettingsData();
                }
            } catch (err) {
                alert('[ERR] Geçersiz müdahale şifresi!');
            }
        }

        function askPasswordModal() {
            return new Promise((resolve) => {
                const modal = document.getElementById('password-ask-modal');
                const input = document.getElementById('ask-password-input');
                const confirmBtn = document.getElementById('ask-password-confirm');
                const cancelBtn = document.getElementById('ask-password-cancel');

                input.value = '';
                modal.style.display = 'flex';
                input.focus();

                const cleanup = () => {
                    modal.style.display = 'none';
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    input.onkeydown = null;
                };

                confirmBtn.onclick = () => {
                    const val = input.value;
                    cleanup();
                    resolve(val);
                };

                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(null);
                };

                input.onkeydown = (e) => {
                    if (e.key === 'Enter') confirmBtn.click();
                    if (e.key === 'Escape') cancelBtn.click();
                };
            });
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function clearServisSelection() {
            const servisSelect = document.getElementById('servis-filter');
            Array.from(servisSelect.options).forEach(opt => opt.selected = false);
            // Kuyrukları da temizle çünkü bölüm seçimi yoksa kuyruk seçimi anlamsız
            const kuyrukSelect = document.getElementById('kuyruk-filter');
            Array.from(kuyrukSelect.options).forEach(opt => opt.selected = false);
        }

        function clearKuyrukSelection() {
            const kuyrukSelect = document.getElementById('kuyruk-filter');
            Array.from(kuyrukSelect.options).forEach(opt => opt.selected = false);
        }

        async function saveSettings() {
            const servisSelect = document.getElementById('servis-filter');
            const kuyrukSelect = document.getElementById('kuyruk-filter');

            const selectedServisIds = Array.from(servisSelect.selectedOptions).map(opt => parseInt(opt.value));
            const selectedKuyrukIds = Array.from(kuyrukSelect.selectedOptions).map(opt => parseInt(opt.value));

            const deviceNameInput = document.getElementById('device-name-input');
            const deviceName = deviceNameInput ? deviceNameInput.value.trim() : '';
            const fullscreenCheckbox = document.getElementById('fullscreen-checkbox');
            const orientationSelect = document.getElementById('orientation-select');
            const cihazTipiSelect = document.getElementById('kiosk-cihaz-tipi');
            const kullanimTipiSelect = document.getElementById('kiosk-kullanim-tipi');
            const cihazTipi = cihazTipiSelect ? cihazTipiSelect.value || 'TABLET' : 'TABLET';
            const kullanimTipi = kullanimTipiSelect ? kullanimTipiSelect.value || 'KIOSK' : 'KIOSK';

            kioskSettings = {
                servisIds: selectedServisIds,
                kuyrukIds: selectedKuyrukIds,
                hideServisSelection: document.getElementById('hide-servis-checkbox').checked,
                deviceName: deviceName || kioskSettings.deviceName || `TABLET-${(DEVICE_FINGERPRINT || 'XXXXXXX').substring(3, 10)}`,
                cihaz_tipi: cihazTipi,
                kullanim_tipi: kullanimTipi,
                fullscreen: fullscreenCheckbox ? fullscreenCheckbox.checked : kioskSettings.fullscreen,
                orientation: orientationSelect ? orientationSelect.value : kioskSettings.orientation,
                initialSetupDone: true // Bu fonksiyon çağrıldığında kurulum tamamlandı kabul ediyoruz
            };

            // LocalStorage'a kaydet
            localStorage.setItem('kiosk_settings', JSON.stringify(kioskSettings));
            
            console.log('[SETUP] Kaydedilen ayarlar:', kioskSettings);
            
            // Backend'e de kaydet
            if (DEVICE_ID) {
                console.log('[SETUP] Backend\'e kaydediliyor, initialSetupDone:', kioskSettings.initialSetupDone);
                const success = await saveSettingsToBackend(kioskSettings);
                if (!success) {
                    console.error('[ERR] Backend\'e kayıt başarısız!');
                    alert('[WARN] Ayarlar localStorage\'a kaydedildi ama backend\'e gönderilemedi!');
                    return;
                }
                console.log('[OK] Backend kaydı başarılı');
            } else {
                console.error('[ERR] DEVICE_ID yok, backend kaydı yapılamadı!');
            }

            alert('[OK] Ayarlar kaydedildi! Sayfa yenileniyor...');
            location.reload();
        }

        async function resetSettings() {
            if (!confirm('[WARN] Bu tarayıcıdaki KIOSK ayarlarını sıfırlamak istediğinize emin misiniz?\\n\\nTüm kiosk ayarları, cihaz adı ve kimlik bilgileri (bu tarayıcıya ait) silinecek ve sayfa yeniden açıldığında ilk kurulum sihirbazı çalışacaktır.\\n\\nTablet veya bilgisayarın kendi fabrika ayarları DEĞİŞMEZ.')) {
                return;
            }

            // Fabrika ayarları için tekrar müdahale şifresi iste
            const password = await askPasswordModal();
            if (!password) return;

            try {
                // Önce backend'de cihaz kaydını sil (varsa)
                if (DEVICE_ID) {
                    const resetRes = await apiCall(`/api/cihaz/${DEVICE_ID}/self-reset`, {
                        method: 'POST',
                        body: JSON.stringify({ sifre: password })
                    });

                    if (!resetRes || resetRes.status !== 'success') {
                        alert('[ERR] Sunucuda cihaz kaydı silinemedi. Lütfen admin panelden kontrol edin.');
                    }
                }

                // Tüm lokal kimlik ve ayarları temizle
                localStorage.removeItem('kiosk_settings');
                localStorage.removeItem('tablet_device_id');
                localStorage.removeItem('device_fingerprint');

                alert('[OK] Cihaz fabrika ayarlarına döndürüldü. Sayfa yeniden açıldığında ilk kurulum sihirbazı çalışacak.');
                location.reload();
            } catch (err) {
                console.error('[ERR] Fabrika ayarlarına döndürme hatası:', err);
                alert('[ERR] Fabrika ayarlarına döndürme sırasında bir hata oluştu: ' + (err.message || 'Bilinmeyen hata'));
            }
        }

        async function loadSettingsData() {
            try {
                const [servisler, kuyruklar] = await Promise.all([
                    apiCall(`/api/servisler/${FIRMA_ID}`),
                    apiCall(`/api/kuyruklar/firma/${FIRMA_ID}`)
                ]);

                // Tüm kuyruğu global'de sakla
                window.allKuyruklar = kuyruklar;

                // Servis combo'sunu doldur
                const servisSelect = document.getElementById('servis-filter');
                servisSelect.innerHTML = servisler.map(s =>
                    `<option value="${s.id}" ${kioskSettings.servisIds.includes(s.id) ? 'selected' : ''}>${s.kod} - ${s.ad}</option>`
                ).join('');

                // Servis seçimine göre kuyrukları güncelle
                servisSelect.addEventListener('change', updateKuyrukList);

                // İlk yüklemede kuyrukları güncelle
                updateKuyrukList();

                // Checkbox durumunu ayarla
                const checkbox = document.getElementById('hide-servis-checkbox');
                if (checkbox) checkbox.checked = kioskSettings.hideServisSelection;

                // Backend'den cihaz bilgisini tek seferde al (setup durumu + cihaz_tipi, kullanim_tipi için)
                let deviceData = null;
                if (DEVICE_ID) {
                    try {
                        const deviceResponse = await apiCall(`/api/cihaz/${DEVICE_ID}/ayarlar`);
                        if (deviceResponse.status === 'success' && deviceResponse.device) {
                            deviceData = deviceResponse.device;
                        }
                    } catch (err) {
                        console.warn('[SETUP] Cihaz ayarları alınamadı:', err);
                    }
                }
                const setupCompleted = (deviceData && deviceData.setup_tamamlandi) || (DEVICE_ID && kioskSettings.initialSetupDone);

                // Cihaz adı ve fingerprint alanlarını doldur
                const nameInput = document.getElementById('device-name-input');
                const fpInput = document.getElementById('device-fingerprint-display');
                if (fpInput) {
                    fpInput.value = DEVICE_FINGERPRINT || localStorage.getItem('device_fingerprint') || 'Parmak izi oluşturuluyor...';
                }
                if (nameInput) {
                    const defaultName = `TABLET-${(DEVICE_FINGERPRINT || localStorage.getItem('device_fingerprint') || 'XXXXXXX').substring(3, 10)}`;
                    nameInput.value = kioskSettings.deviceName || defaultName;
                    if (setupCompleted) {
                        nameInput.readOnly = true;
                        nameInput.style.background = '#f1f5f9';
                        nameInput.style.cursor = 'not-allowed';
                        nameInput.style.color = '#64748b';
                        nameInput.title = 'Cihaz adı artık sadece admin panelinden değiştirilebilir.';
                    } else {
                        nameInput.readOnly = false;
                        nameInput.style.background = '';
                        nameInput.style.cursor = '';
                        nameInput.style.color = '';
                        nameInput.title = '';
                    }
                }

                // Cihaz tipi ve kullanım tipi alanlarını doldur; setup tamamsa sadece göster (değiştirilemez)
                const cihazTipiSelect = document.getElementById('kiosk-cihaz-tipi');
                const kullanimTipiSelect = document.getElementById('kiosk-kullanim-tipi');
                if (cihazTipiSelect && kullanimTipiSelect) {
                    const ct = (deviceData && deviceData.cihaz_tipi) ? String(deviceData.cihaz_tipi).toUpperCase() : (kioskSettings.cihaz_tipi || 'TABLET');
                    const kt = (deviceData && deviceData.kullanim_tipi) ? String(deviceData.kullanim_tipi).toUpperCase() : (kioskSettings.kullanim_tipi || 'KIOSK');
                    if (ct && Array.from(cihazTipiSelect.options).some(o => o.value === ct)) cihazTipiSelect.value = ct;
                    else cihazTipiSelect.value = 'TABLET';
                    if (kt && Array.from(kullanimTipiSelect.options).some(o => o.value === kt)) kullanimTipiSelect.value = kt;
                    else kullanimTipiSelect.value = 'KIOSK';
                    if (setupCompleted) {
                        cihazTipiSelect.disabled = true;
                        kullanimTipiSelect.disabled = true;
                        cihazTipiSelect.style.background = '#f1f5f9';
                        kullanimTipiSelect.style.background = '#f1f5f9';
                        cihazTipiSelect.title = 'Sadece ilk kurulumda değiştirilebilir; artık admin panelinden düzenleyin.';
                        kullanimTipiSelect.title = 'Sadece ilk kurulumda değiştirilebilir; artık admin panelinden düzenleyin.';
                    } else {
                        cihazTipiSelect.disabled = false;
                        kullanimTipiSelect.disabled = false;
                        cihazTipiSelect.style.background = '';
                        kullanimTipiSelect.style.background = '';
                        cihazTipiSelect.title = '';
                        kullanimTipiSelect.title = '';
                    }
                }

                // Ekran ayarlarını doldur
                const fullscreenCheckbox = document.getElementById('fullscreen-checkbox');
                const orientationSelect = document.getElementById('orientation-select');
                if (fullscreenCheckbox) fullscreenCheckbox.checked = kioskSettings.fullscreen !== false;
                if (orientationSelect) {
                    const o = kioskSettings.orientation;
                    orientationSelect.value = (o === 'portrait' || o === 'landscape') ? o : 'landscape';
                }

            } catch (error) {
                console.error('Ayarlar verisi yüklenemedi:', error);
                alert('[ERR] Veriler yüklenirken hata oluştu!');
            }
        }

        function updateKuyrukList() {
            const servisSelect = document.getElementById('servis-filter');
            const kuyrukSelect = document.getElementById('kuyruk-filter');

            const selectedServisIds = Array.from(servisSelect.selectedOptions).map(opt => parseInt(opt.value));

            if (selectedServisIds.length === 0) {
                // Hiçbir bölüm seçilmemişse kuyrukları boşalt
                kuyrukSelect.innerHTML = '<option disabled>Lütfen önce bölüm seçiniz</option>';
                return;
            }

            // Seçili bölümlere ait kuyrukları filtrele
            const filteredKuyruklar = window.allKuyruklar.filter(k => selectedServisIds.includes(k.servis_id));

            kuyrukSelect.innerHTML = filteredKuyruklar.map(k =>
                `<option value="${k.id}" ${kioskSettings.kuyrukIds.includes(k.id) ? 'selected' : ''}>${k.kod} - ${k.ad}</option>`
            ).join('');
        }

        function applyFilters(servisler, kuyruklar) {
            // Eğer hiçbir filtre yoksa tümünü döndür
            if (kioskSettings.servisIds.length === 0 && kioskSettings.kuyrukIds.length === 0) {
                console.log('[OK] Filtre yok, tüm veriler gösteriliyor');
                return { servisler, kuyruklar };
            }

            let filteredServisler = servisler;
            let filteredKuyruklar = kuyruklar;

            // Servis filtresi varsa uygula
            if (kioskSettings.servisIds.length > 0) {
                filteredServisler = servisler.filter(s => kioskSettings.servisIds.includes(s.id));
                filteredKuyruklar = kuyruklar.filter(k => kioskSettings.servisIds.includes(k.servis_id));
            }

            // Kuyruk filtresi varsa uygula
            if (kioskSettings.kuyrukIds.length > 0) {
                filteredKuyruklar = filteredKuyruklar.filter(k => kioskSettings.kuyrukIds.includes(k.id));
            }

            console.log(`[SEARCH] Filtre uygulandı: ${filteredServisler.length} servis, ${filteredKuyruklar.length} kuyruk`);
            return { servisler: filteredServisler, kuyruklar: filteredKuyruklar };
        }

        // --- İLK KURULUM SİHİRBAZI YARDIMCI FONKSİYONLARI ---

        function isInitialSetupRequired() {
            console.log('[SETUP CHECK] Kurulum kontrol ediliyor...');
            console.log('[SETUP CHECK] kioskSettings:', kioskSettings);
            
            // Eğer daha önce kurulum tamamlandıysa bir daha zorunlu açma
            if (kioskSettings && kioskSettings.initialSetupDone) {
                console.log('[SETUP CHECK] ✓ Kurulum daha önce tamamlanmış (initialSetupDone: true)');
                return false;
            }

            // Ayarlar yoksa veya servis seçilmemişse ilk kurulum gerektiğini varsay
            if (!kioskSettings) {
                console.log('[SETUP CHECK] ✗ Kurulum gerekli: kioskSettings yok');
                return true;
            }
            if (!Array.isArray(kioskSettings.servisIds)) {
                console.log('[SETUP CHECK] ✗ Kurulum gerekli: servisIds array değil');
                return true;
            }
            if (kioskSettings.servisIds.length === 0) {
                console.log('[SETUP CHECK] ✗ Kurulum gerekli: servisIds boş');
                return true;
            }
            
            console.log('[SETUP CHECK] ✓ Kurulum gerekli değil (servisIds var)');
            return false;
        }

        async function openInitialSetupWizard() {
            try {
                console.log('[SETUP] İlk kurulum sihirbazı başlatılıyor...');
                // Firma / servis / kuyruk verilerini yükle
                await loadSettingsData();

                // Başlık ve açıklamayı ilk kurulum için güncelle
                const modal = document.getElementById('settings-modal');
                const titleEl = modal.querySelector('.settings-panel h2');
                const descEl = modal.querySelector('.settings-panel p');
                if (titleEl) titleEl.textContent = 'İlk Kurulum - Kiosk Ayarları';
                if (descEl) descEl.textContent = 'Bu tabletin çalışacağı bölümleri ve kuyrukları seçin. Bu ayarlar kaydedildikten sonra istenildiğinde hem bu cihazdan hem de admin panelden değiştirilebilir.';

                modal.style.display = 'flex';
            } catch (e) {
                console.error('[SETUP] İlk kurulum sihirbazı açılamadı:', e);
            }
        }

        // Sayfa yüklendiğinde local ayarları yükle
        loadKioskSettings();

        // EKRAN AYARLARINI UYGULA
        function applyDisplaySettings() {
            try {
                // Tam ekran
                // Yön sınıfları (sayfa düzeni)
                document.body.classList.remove('orientation-portrait', 'orientation-landscape');
                if (kioskSettings.orientation === 'portrait') {
                    document.body.classList.add('orientation-portrait');
                } else {
                    document.body.classList.add('orientation-landscape');
                }

                const orient = kioskSettings.orientation || 'landscape';
                const tryLockOrientation = () => {
                    if (orient === 'auto' || !screen.orientation || typeof screen.orientation.lock !== 'function') return;
                    const lockMode = orient === 'portrait' ? 'portrait-primary' : 'landscape-primary';
                    screen.orientation.lock(lockMode).then(() => {
                        console.log('[DISPLAY] Ekran yönü kilitlendi:', lockMode);
                    }).catch(err => {
                        console.warn('[DISPLAY] Yön kilidi (çoğu tarayıcıda sadece tam ekranda çalışır):', err.message);
                    });
                };

                if (kioskSettings.fullscreen && document.fullscreenEnabled && !document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => {
                        tryLockOrientation();
                    }).catch(e => {
                        console.warn('[DISPLAY] Tam ekran başlatılamadı:', e);
                        tryLockOrientation();
                    });
                } else {
                    tryLockOrientation();
                }
            } catch (e) {
                console.warn('[DISPLAY] Ekran ayarları uygulanamadı:', e);
            }
        }


        async function initFirma() {
            try {
                console.log("Firma bilgileri yükleniyor...");
                // Public firma bilgisi endpoint'i: /api/firma/{firma_id}
                const firma = await apiCall(`/api/firma/${FIRMA_ID}`);
                if (firma && firma.ad) {
                    const el = document.getElementById('hospital-name');
                    if (el) el.textContent = firma.ad;
                    document.title = firma.ad + " - Sıra Al";
                }
            } catch (err) {
                console.error("Firma bilgisi hatası:", err);
            }
        }

        // Tüm verileri yükle
        async function verileriYukle(silent = false) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position:fixed;bottom:20px;left:20px;right:20px;background:rgba(231,76,60,0.95);color:white;padding:15px;border-radius:10px;z-index:10000;font-size:14px;';
            
            try {
                if (!silent) showLoading(true);
                
                // API çağrılarını paralel yap (daha hızlı)
                const [servisler, kuyruklar] = await Promise.all([
                    apiCall(`/api/servisler/${FIRMA_ID}`),
                    apiCall(`/api/kuyruklar/firma/${FIRMA_ID}`)
                ]);

                // Kiosk ayarlarına göre filtrele
                const filtered = applyFilters(servisler || [], kuyruklar || []);
                allQueues = filtered.kuyruklar;
                renderServisler(filtered.servisler);

                if (!silent) showLoading(false);
            } catch (error) {
                console.error("[ERR] VERİ YÜKLEME HATASI:", error);
                
                if (!silent) showLoading(false);
                
                errorDiv.innerHTML = `
                    <strong>[WARN] HATA:</strong><br>
                    ${error.message}<br>
                    <small>${error.stack ? error.stack.substring(0, 200) : ''}</small>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => errorDiv.remove(), 10000);
            }
        }

        function renderServisler(servisler) {
            const list = document.getElementById('departman-listesi');
            const subContainer = document.getElementById('alt-secenekler-konteynir');
            const exitBtn = document.getElementById('exit-btn');
            const mainHeader = document.getElementById('departman-secimi');
            const numEkrani = document.getElementById('numara-ekrani');

            if (!list) return;

            // Bilet ekranı AÇIKSA (display flex ise), arka plan güncellemelerinin onu kapatmasını engelle
            if (numEkrani && numEkrani.style.display === 'flex') {
                // Sadece verileri güncellemek için devam et ama ekranı bozma
            } else if (numEkrani) {
                numEkrani.style.display = 'none';
            }

            // Bölüm seçimini atlama ayarı aktifse
            if (kioskSettings.hideServisSelection && allQueues.length > 0) {
                if (mainHeader) mainHeader.style.display = 'none';
                renderKuyruklar(allQueues, "Hizmet Türü Seçiniz");
                return;
            } else {
                if (mainHeader) mainHeader.style.display = 'flex';
            }

            // Alt alanı gizle ve geri dön butonunu gizle (ana ekrandayız)
            if (subContainer) subContainer.style.display = 'none';
            if (exitBtn) exitBtn.classList.remove('show');

            if (servisler.length === 0) {
                list.innerHTML = `<p style="grid-column:1/-1; font-size:24px; opacity:0.7;">Tanımlı servis bulunamadı.</p>`;
                return;
            }

            // Ekran genişliğine göre kolon sayısı (7"-60" uyumlu)
            const w = window.innerWidth || 800;
            const maxCols = w < 480 ? 2 : w < 768 ? 3 : Math.min(servisler.length, 4);
            const columnCount = Math.min(servisler.length, maxCols);
            list.style.gridTemplateColumns = `repeat(${columnCount}, 1fr)`;

            list.innerHTML = servisler.map(s => `
                <div class="departman-card fade-in" id="servis-card-${s.id}" onclick="servisSecildi(${s.id}, '${s.ad}')" style="flex: 1;">
                    <div class="kod">${s.kod}</div>
                    <h2>${s.ad}</h2>
                    <div class="bekleyen">${s.kuyruk_sayisi > 0 ? ` ${s.kuyruk_sayisi} Seçenek` : (s.id === 2 ? ' 1 Sıra' : 'Sıra Al')}</div>
                </div>
            `).join('');
        }

        function servisSecildi(servisId, servisAd) {
            document.querySelectorAll('.departman-card').forEach(el => el.classList.remove('active'));
            const selectedIcon = document.getElementById(`servis-card-${servisId}`);
            if (selectedIcon) selectedIcon.classList.add('active');

            const uygunKuyruklar = allQueues.filter(k => k.servis_id === servisId);

            if (uygunKuyruklar.length <= 1) {
                const subContainer = document.getElementById('alt-secenekler-konteynir');
                if (subContainer) subContainer.style.display = 'none';

                const kuyrukId = uygunKuyruklar.length === 1 ? uygunKuyruklar[0].id : null;
                if (kuyrukId) siraAl(kuyrukId, servisId);
                else showToast("Bu servise bağlı kuyruk bulunamadı!", "error");
            } else {
                renderKuyruklar(uygunKuyruklar, servisAd);
            }
        }

        function renderKuyruklar(kuyruklar, servisAd) {
            const subContainer = document.getElementById('alt-secenekler-konteynir');
            const subList = document.getElementById('alt-secenek-listesi');
            const subTitle = document.getElementById('alt-secenek-baslik');
            const exitBtn = document.getElementById('exit-btn');

            subTitle.textContent = servisAd;
            subContainer.style.display = 'flex';
            // Eğer bölüm seçimi gizliyse "Geri Dön" butonunu gösterme (çünkü dönecek yer yok)
            if (exitBtn) {
                if (kioskSettings.hideServisSelection) exitBtn.classList.remove('show');
                else exitBtn.classList.add('show');
            }

            // Ekran genişliğine göre kolon sayısı
            const w = window.innerWidth || 800;
            const maxCols = w < 480 ? 2 : w < 768 ? 3 : 4;
            const columnCount = Math.min(kuyruklar.length, maxCols);
            subList.style.gridTemplateColumns = `repeat(${columnCount}, 1fr)`;

            subList.innerHTML = kuyruklar.map(k => `
                <div class="departman-card fade-in" onclick="siraAl(${k.id}, ${k.servis_id})" style="border-bottom: 8px solid #f0932b; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden;">
                    <div class="kod" style="font-size: clamp(24px, 4vh, 48px);">${k.kod}</div>
                    <h2 style="font-size: clamp(18px, 2.5vh, 28px);">${k.ad}</h2>
                </div>
            `).join('');

            // scrollIntoView kaldırıldı (scroll olmamalı)
        }

        let lastSiraResponse = null;

        async function siraAl(kuyrukId, servisId) {
            console.log("Sıra alınıyor: Kuyruk", kuyrukId);
            try {
                showLoading(true);
                const response = await apiCall('/api/sira/al', {
                    method: 'POST',
                    body: JSON.stringify({
                        kuyruk_id: kuyrukId,
                        servis_id: servisId,
                        firma_id: FIRMA_ID,
                        oncelik: 0
                    })
                });

                lastSiraResponse = response;
                lastSiraResponse.servis_id = servisId;
                lastSiraResponse.kuyruk_id = kuyrukId;

                const numaraEl = document.getElementById('numara');
                if (numaraEl) numaraEl.textContent = response.numara;
                const mesajEl = document.getElementById('mesaj');
                if (mesajEl) mesajEl.textContent = response.mesaj || (response.numara + " numaralı sıranız alındı.");
                const beklemeInfoEl = document.getElementById('bekleme-info');
                if (beklemeInfoEl) beklemeInfoEl.textContent = `Sıranızdan önce ${Math.max(0, response.bekleyen_sayisi - 1)} kişi var.`;

                const tahminiEl = document.getElementById('tahmini-bekleme');
                if (tahminiEl) {
                    const dk = response.tahmini_sure_dk;
                    if (dk != null && dk > 0) {
                        tahminiEl.textContent = `Yaklaşık bekleme süresi: ${dk} dakika`;
                        tahminiEl.style.display = '';
                    } else {
                        tahminiEl.textContent = '';
                        tahminiEl.style.display = 'none';
                    }
                }

                const depSecimi = document.getElementById('departman-secimi');
                const numEkrani = document.getElementById('numara-ekrani');
                const exitBtn = document.getElementById('exit-btn');

                if (depSecimi) depSecimi.style.display = 'none';
                if (numEkrani) {
                    numEkrani.style.display = 'flex'; // Overlay olduğu için flex yap
                }
                if (exitBtn) exitBtn.classList.add('show');

                // Gecikmeyi kaldırdık, anında gösteriyoruz
                karekodGoster();

            } catch (error) {
                console.error("Sıra alma hatası:", error);
                showLoading(false);
                showToast('Hata: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        let reloadTimer = null;

        function fisBastir() {
            if (!lastSiraResponse) return;

            showToast("Fişiniz yazdırılıyor...", "success");

            const hospEl = document.getElementById('hospital-name');
            document.getElementById('fis-hospital').textContent = hospEl ? hospEl.textContent : "İRMET HOSPITAL";
            document.getElementById('fis-numara').textContent = lastSiraResponse.numara;
            document.getElementById('fis-kuyruk').textContent = lastSiraResponse.kuyruk_ad;
            document.getElementById('fis-tarih').textContent = new Date().toLocaleString('tr-TR');

            const fisQrContainer = document.getElementById('fis-qrcode');
            fisQrContainer.innerHTML = '';
            const biletUrl = `${BILET_QR_BASE_URL}/frontend/bilet.html?numara=${lastSiraResponse.numara}&kuyruk=${encodeURIComponent(lastSiraResponse.kuyruk_ad)}&bekleyen=${Math.max(0, lastSiraResponse.bekleyen_sayisi - 1)}&firma=${encodeURIComponent(document.getElementById('hospital-name').textContent)}&kuyruk_id=${lastSiraResponse.kuyruk_id}&sira_id=${lastSiraResponse.sira_id}&firma_id=${FIRMA_ID}`;

            new QRCode(fisQrContainer, {
                text: biletUrl,
                width: 120,
                height: 120,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });

            document.getElementById('fis-modal').style.display = 'flex';

            if (reloadTimer) clearInterval(reloadTimer);
            setTimeout(() => {
                location.reload();
            }, 10000);
        }

        let kioskConfig = { host_ip: 'localhost', port: 3000 };

        async function initConfig() {
            try {
                const config = await apiCall('/api/kiosk-config');
                kioskConfig = config;
                console.log("Kiosk Yapılandırması:", kioskConfig);
            } catch (err) {
                console.error("Config yüklenemedi:", err);
            }
        }

        async function karekodGoster() {
            if (!lastSiraResponse) return;

            try {
                const qrContainer = document.getElementById('qrcode');
                if (!qrContainer) return;

                // "Hazırlanıyor" yazısını kaldırdık ki boyut zıplaması olmasın

                const n = lastSiraResponse.numara || '---';
                const k = lastSiraResponse.kuyruk_ad || 'Sıra';
                const b = Math.max(0, (lastSiraResponse.bekleyen_sayisi || 1) - 1);
                const hEl = document.getElementById('hospital-name');
                const h = hEl ? hEl.textContent.trim() : "İRMET HOSPITAL";
                const kid = lastSiraResponse.kuyruk_id || 0;

                const safeN = encodeURIComponent(n);
                const safeH = encodeURIComponent(h);
                const safeK = encodeURIComponent(k);

                const sid = lastSiraResponse.sira_id || 0;
                const biletUrl = `${BILET_QR_BASE_URL}/frontend/bilet.html?numara=${safeN}&kuyruk=${safeK}&bekleyen=${b}&firma=${safeH}&kuyruk_id=${kid}&sira_id=${sid}&firma_id=${FIRMA_ID}`;

                console.log("QR Kod Telefon Linki:", biletUrl);

                qrContainer.innerHTML = '';

                if (typeof QRCode === 'undefined') {
                    qrContainer.innerHTML = '<div style="color:red; font-size:12px;">Kütüphane Hatası!</div>';
                    return;
                }

                new QRCode(qrContainer, {
                    text: biletUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#2c3e50",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });

                let saniye = 15;
                const sayacEl = document.getElementById('qr-sayac');
                if (sayacEl) sayacEl.textContent = `${saniye} sn içinde kapanacak`;

                if (reloadTimer) clearInterval(reloadTimer);
                reloadTimer = setInterval(() => {
                    saniye--;
                    if (sayacEl) sayacEl.textContent = `${saniye} sn içinde kapanacak`;
                    if (saniye <= 0) {
                        clearInterval(reloadTimer);
                        location.reload();
                    }
                }, 1000);

            } catch (err) {
                console.error("QR oluşturma hatası:", err);
                const qrContainer = document.getElementById('qrcode');
                if (qrContainer) qrContainer.innerHTML = '<div style="color:red; font-size:12px;">QR Oluşturulamadı</div>';
            }
        }

        // Başlat
        async function baslat() {
            // Başlangaçta tüm verileri yükle
            try {
                showLoading(true);
                
                // 1. CİHAZ KAYIT VE AYAR SENKRONİZASYONU (Paralel başlat)
                const devicePromise = registerOrUpdateDevice();
                
                // 2. Firma bilgilerini paralel yükle
                const firmaPromise = initFirma();
                
                // İkisini de bekle
                await Promise.all([devicePromise, firmaPromise]);

                // 3. İlk kurulum gerekiyor mu kontrol et
                if (isInitialSetupRequired()) {
                    await openInitialSetupWizard(); // loadSettingsData içinden servis/kuyruk verilerini alıyor
                } else {
                    // 3b. Normal mod: Servis ve Kuyruklar yükle
                    await verileriYukle(false);
                }
                
                // 4. Ekran ayarlarını uygula
                applyDisplaySettings();

                // 5. Heartbeat Başlat (10 saniyede bir)
                sendHeartbeat(); // İlk heartbeat hemen gönder
                setInterval(() => {
                    sendHeartbeat();
                }, 10000);

            } catch (err) {
                console.error("[ERR] Kiosk başlatma hatası:", err);
                alert('[WARN] Veriler yüklenirken hata oluştu: ' + err.message);
                showLoading(false);
            }
        }

        // Debounce için timer
        let verileriYukleTimer = null;
        
        // Polling mekanizması (WebSocket yedek sistemi)
        let pollingInterval = null;
        
        function isWebSocketConnected() {
            return window.ws && window.ws.readyState === WebSocket.OPEN;
        }
        
        function startPolling() {
            // Eğer zaten çalışıyorsa durdur
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // WebSocket bağlı değilse polling başlat (10 saniyede bir)
            pollingInterval = setInterval(() => {
                if (!isWebSocketConnected()) {
                    // WebSocket yoksa polling ile güncelle
                    verileriYukle(true); // Sessiz güncelleme (loader göstermeden)
                } else {
                    // WebSocket bağlandıysa polling'i durdur
                    stopPolling();
                }
            }, 10000); // 10 saniye (maksimum tazeleme süresi)
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        // WebSocket durumunu kontrol et ve polling'i yönet
        function checkWebSocketAndManagePolling() {
            if (isWebSocketConnected()) {
                // WebSocket bağlıysa polling'i durdur
                stopPolling();
            } else {
                // WebSocket bağlı değilse polling'i başlat (yedek mekanizma)
                startPolling();
            }
        }
        
        baslat();
        
        // WebSocket Dinleyici (debounce ile optimize edildi)
        initWebSocket((data) => {
            if (['new_ticket', 'call_ticket', 'complete_ticket', 'delete_ticket'].includes(data.type)) {
                // Debounce: Aynı anda gelen birden fazla event'i tek bir çağrıya indir
                if (verileriYukleTimer) clearTimeout(verileriYukleTimer);
                verileriYukleTimer = setTimeout(() => {
                    verileriYukle(true);
                }, 300); // 300ms debounce
            }
        });
        
        // İlk kontrol: WebSocket durumunu kontrol et ve polling'i başlat/durdur
        setTimeout(() => {
            checkWebSocketAndManagePolling();
        }, 2000); // 2 saniye sonra kontrol et (WebSocket bağlantısı için zaman tanı)
        
        // Periyodik kontrol: Her 5 saniyede bir WebSocket durumunu kontrol et
        setInterval(() => {
            checkWebSocketAndManagePolling();
        }, 5000);


    </script>
</body>

</html>
