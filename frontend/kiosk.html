<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sƒ±ra Numarasƒ± Al - Sƒ±ramatik</title>
    <link rel="stylesheet" href="static/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .header {
            margin-bottom: 50px;
        }

        .header h1 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 24px;
            opacity: 0.9;
        }

        .departman-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .departman-card {
            background: white;
            color: #667eea;
            padding: 40px 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .departman-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .departman-card h2 {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .departman-card .kod {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #764ba2;
        }

        .departman-card .bekleyen {
            font-size: 18px;
            color: #666;
            margin-top: 10px;
        }

        #numara-ekrani {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        #numara-ekrani .numara {
            font-size: 150px;
            font-weight: bold;
            margin: 50px 0;
            text-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        #numara-ekrani .mesaj {
            font-size: 28px;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }

        .bekleme-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üè• DEMO HASTANESƒ∞</h1>
        <p>Sƒ±ra Numarasƒ± Alma Sistemi</p>
    </div>

    <div id="departman-secimi">
        <h2 style="font-size: 36px; margin-bottom: 40px;">Hangi B√∂l√ºme Gideceksiniz?</h2>
        <div class="departman-grid" id="departman-listesi"></div>
    </div>

    <div id="numara-ekrani">
        <h2 style="font-size: 42px;">Sƒ±ra Numaranƒ±z</h2>
        <div class="numara" id="numara"></div>
        <div class="mesaj" id="mesaj"></div>
        <div class="bekleme-info" id="bekleme-info"></div>
    </div>

    <script src="static/app.js"></script>
    <script>
        const FIRMA_ID = '11111111-1111-1111-1111-111111111111'; // Demo firma

        // Servisleri y√ºkle
        async function servisleriYukle() {
            try {
                showLoading(true);
                const data = await apiCall(`/servisler/${FIRMA_ID}`);

                const liste = document.getElementById('departman-listesi');
                liste.innerHTML = '';

                data.forEach(servis => {
                    const card = document.createElement('div');
                    card.className = 'departman-card fade-in';
                    card.innerHTML = `
                        <div class="kod">${servis.kod}</div>
                        <h2>${servis.ad}</h2>
                        <div class="bekleyen">
                            ${servis.kuyruk_sayisi > 0 ?
                            `üïê ${servis.kuyruk_sayisi} ki≈üi bekliyor` :
                            '‚úì Sƒ±ra yok'}
                        </div>
                    `;
                    // Servisin baƒülƒ± olduƒüu ilk kuyruƒüu bulmak gerekirdi ama
                    // demo i√ßin varsayƒ±lan kuyruk ID'sini backend'in bulmasƒ±nƒ± isteyeceƒüiz
                    // veya backend endpointini buna g√∂re g√ºncelleyeceƒüiz.
                    // ≈ûimdilik backend SiraCreate modeline uygun g√∂nderelim:
                    card.onclick = () => siraAl(servis.id);
                    liste.appendChild(card);
                });

                showLoading(false);
            } catch (error) {
                showLoading(false);
                showToast('Servisler y√ºklenemedi: ' + error.message, 'error');
            }
        }

        // Sƒ±ra numarasƒ± al
        async function siraAl(servisId) {
            try {
                showLoading(true);

                // Kuyruk ID'sini bulmak i√ßin √∂nce servis detayƒ±nƒ± √ßekmek daha doƒüru olurdu
                // ama basitlik i√ßin backend'e sadece servis ID g√∂nderip
                // backend'in o servise baƒülƒ± ilk kuyruƒüu se√ßmesini saƒülayacak bir endpoint lazƒ±m.
                // Veya frontend'de hile yapƒ±p, t√ºm kuyruklarƒ± √ßekip filtreleyebiliriz.

                // D√úZELTME: Backend'de /sira/al endpointi SiraCreate(kuyruk_id, servis_id) bekliyor.
                // Biz sadece servis_id biliyoruz.
                // Bu y√ºzden √∂nce servisin kuyruklarƒ±nƒ± bulmalƒ±yƒ±z.
                // DEMO HACK: ≈ûimdilik servis ID'sini kuyruk ID gibi g√∂nderip backend'de hata verirse bakarƒ±z.
                // DOƒûRUSU: Backend'e /servis/{id}/kuyruklar endpointi eklenmeli.
                // AMA ≈ûƒ∞MDƒ∞Lƒ∞K: T√ºm kuyruklarƒ± √ßekelim.

                const kuyruklar = await apiCall(`/kuyruklar/firma/${FIRMA_ID}`);

                if (!kuyruklar || kuyruklar.length === 0) {
                    throw new Error('Sistemde tanƒ±mlƒ± kuyruk bulunamadƒ±!');
                }

                // Servise uygun kuyruƒüu bulmaya √ßalƒ±≈ü
                const uygunKuyruk = kuyruklar.find(k => k.servis_id === servisId);

                // Servise ait kuyruk yoksa, listedeki ilk kuyruƒüu kullan (Fallback)
                const secilenKuyruk = uygunKuyruk || kuyruklar[0];

                console.log('Se√ßilen Kuyruk:', secilenKuyruk);

                const requestData = {
                    kuyruk_id: secilenKuyruk.id,
                    servis_id: servisId,
                    firma_id: FIRMA_ID,
                    oncelik: 0
                };

                const responseData = await apiCall('/sira/al', {
                    method: 'POST',
                    body: JSON.stringify(requestData)
                });

                showLoading(false);

                // Numarayƒ± g√∂ster
                document.getElementById('departman-secimi').style.display = 'none';
                document.getElementById('numara-ekrani').style.display = 'block';
                document.getElementById('numara').textContent = responseData.numara;
                document.getElementById('mesaj').textContent = responseData.mesaj;

                if (responseData.tahmini_bekleme_dk) {
                    document.getElementById('bekleme-info').innerHTML = `
                        ‚è±Ô∏è Tahmini Bekleme S√ºresi: <strong>${responseData.tahmini_bekleme_dk} dakika</strong>
                    `;
                } else {
                    document.getElementById('bekleme-info').innerHTML = `
                        ‚úÖ Sƒ±ranƒ±z √ßok yakƒ±nda √ßaƒürƒ±lacak!
                    `;
                }

                // 15 saniye sonra ana ekrana d√∂n
                setTimeout(() => {
                    location.reload();
                }, 15000);

            } catch (error) {
                showLoading(false);
                showToast('Sƒ±ra alƒ±namadƒ±: ' + error.message, 'error');
            }
        }

        // Sayfa y√ºklendiƒüinde
        servisleriYukle();

        // Her 30 saniyede bir yenile
        setInterval(servisleriYukle, 30000);
    </script>
</body>

</html>